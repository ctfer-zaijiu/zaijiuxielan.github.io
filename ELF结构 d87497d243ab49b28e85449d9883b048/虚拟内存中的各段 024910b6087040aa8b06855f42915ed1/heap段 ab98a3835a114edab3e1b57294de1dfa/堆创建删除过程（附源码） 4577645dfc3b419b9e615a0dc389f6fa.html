<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>å †åˆ›å»ºåˆ é™¤è¿‡ç¨‹ï¼ˆé™„æºç ï¼‰</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.page-description {
	margin-bottom: 2em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(50, 48, 44, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-default_background {
	color: rgba(50, 48, 44, 1);
}
.highlight-gray_background {
	background: rgba(248, 248, 247, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(248, 243, 252, 1);
}
.highlight-pink_background {
	background: rgba(252, 241, 246, 1);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-default_background {
	color: inherit;
	fill: inherit;
}
.block-color-gray_background {
	background: rgba(248, 248, 247, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(248, 243, 252, 1);
}
.block-color-pink_background {
	background: rgba(252, 241, 246, 1);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-uiBlue { background-color: undefined; }
.select-value-color-pink { background-color: rgba(225, 136, 179, 0.27); }
.select-value-color-purple { background-color: rgba(168, 129, 197, 0.27); }
.select-value-color-green { background-color: rgba(123, 183, 129, 0.27); }
.select-value-color-gray { background-color: rgba(84, 72, 49, 0.15); }
.select-value-color-transparentGray { background-color: undefined; }
.select-value-color-translucentGray { background-color: undefined; }
.select-value-color-orange { background-color: rgba(224, 124, 57, 0.27); }
.select-value-color-brown { background-color: rgba(210, 162, 141, 0.35); }
.select-value-color-red { background-color: rgba(244, 171, 159, 0.4); }
.select-value-color-yellow { background-color: rgba(236, 191, 66, 0.39); }
.select-value-color-blue { background-color: rgba(93, 165, 206, 0.27); }
.select-value-color-pageGlass { background-color: undefined; }
.select-value-color-washGlass { background-color: undefined; }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="4577645d-fc3b-419b-9e61-5a0dc389f6fa" class="page sans"><header><img class="page-cover-image" src="%E5%A0%86%E5%88%9B%E5%BB%BA%E5%88%A0%E9%99%A4%E8%BF%87%E7%A8%8B%EF%BC%88%E9%99%84%E6%BA%90%E7%A0%81%EF%BC%89%204577645dfc3b419b9e615a0dc389f6fa/firefox_oZt25cSg0n.png" style="object-position:center 50%"/><div class="page-header-icon page-header-icon-with-cover"><img class="icon" src="https://www.notion.so/icons/condense_red.svg"/></div><h1 class="page-title">å †åˆ›å»ºåˆ é™¤è¿‡ç¨‹ï¼ˆé™„æºç ï¼‰</h1><p class="page-description"></p></header><div class="page-body"><blockquote id="e094cf59-4bfe-460d-87e4-8cc687016f22" class="block-color-gray">æ’äº‘é©­éœå…®æ¬²ä½•ä¹‹ï¼Œæµªè¹„è½èŠ±å…®å ä½•ä¹‹ã€‚</blockquote><h1 id="17d0427e-38bb-8050-a7c6-c359cf56812d" class="block-color-default_background">ä¸€ã€ç›¸å…³å‰ç½®ä»£ç </h1><h3 id="17d0427e-38bb-80d1-9004-fc624c63faab" class="">1-é€šç”¨å‰ç½®ä»£ç </h3><ul id="17d0427e-38bb-800e-9456-c4755e148966" class="toggle"><li><details open=""><summary><strong>1ã€ä¼šç”¨åˆ°çš„ç›¸å…³å®ï¼šchunkæ¼«æ¸¸ã€chunkæ ‡å¿—ä½ç›¸å…³ã€å…¶ä»–</strong></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="17d0427e-38bb-807d-8508-ffe69d4b9f4a" class="code"><code class="language-Plain Text">//1ã€chunkæ¼«æ¸¸=======================
//1.1ã€å‰åæ¼«æ¸¸
//è¿™é‡Œçš„next_chunkå®å…¶å®å°±æ˜¯é€šè¿‡chunkåœ°å€åŠ ä¸Šè¯¥chunkå¤§å°ä»è€Œå¾—åˆ°ä¸‹ä¸€ä¸ªç‰©ç†ç›¸é‚»chunkçš„åœ°å€ã€‚è¿™ä¸ªå¾ˆé‡è¦ï¼è¿™é‡Œæ¶‰åŠåˆ°äº†æ¼æ´åˆ©ç”¨ï¼
#define next_chunk(p)        ((mchunkptr) (((char *) (p)) + chunksize(p)))
#define prev_chunk(p)        ((mchunkptr) (((char *) (p)) - (p)-&gt;prev_size))
//1.2ã€åç§»æ¼«æ¸¸
//è®¡ç®—ç»™å®šå†…å­˜å— p åç§»é‡ä¸º s çš„ä½ç½®ï¼Œå¹¶è¿”å›è¯¥ä½ç½®çš„åœ°å€å€¼ã€‚
#define chunk_at_offset(p, s)  ((mchunkptr) (((char *) (p)) + (s)))
//1.3ã€å—å¤´&amp;å—ä½“æ¼«æ¸¸
//è¿™é‡ŒmemæŒ‡å‘ä¸€ä¸ªå—çš„dataéƒ¨åˆ†ï¼ŒchukæŒ‡å‘ä¸€ä¸ªå—çš„å—å¤´éƒ¨åˆ†ï¼Œä»–ä»¬ä¹‹é—´ç›¸å·®ä¸¤ä¸ªæŒ‡é’ˆå¤§å°ã€‚
#define chunk2mem(p) ((void *) ((char *) (p) + 2 * SIZE_SZ))
#define mem2chunk(mem) ((mchunkptr)((char *) (mem) -2 * SIZE_SZ))


//2ã€chunkæ ‡å¿—ä½ç›¸å…³=================
//2.1ã€è®¾ç½®
//æŠŠå½“å‰chunkçš„prev_inuseæ ‡å¿—ä½è®¾ç½®ä¸º0
#define clear_inuse_bit_at_offset(p, s)		 (((mchunkptr) (((char *) (p)) + (s)))-&gt;size &amp;= ~(PREV_INUSE))
//è®¾ç½®å½“å‰chunkçš„sizeå­—æ®µ
#define set_head(p, s)       ((p)-&gt;size = (s))
//è®¾ç½®å½“å‰chunkçš„ä¸‹ä¸€ä¸ªchunkçš„prev_sizeå­—æ®µï¼ˆåªå½“freechunkæ—¶è¿™ä¹ˆè®¾ç½®ï¼ï¼‰
#define set_foot(p, s)       (((mchunkptr) ((char *) (p) + (s)))-&gt;prev_size = (s))
//2.2ã€æ£€æŸ¥
//æŸ¥çœ‹å½“å‰chunkçš„ç‰©ç†ç›¸é‚»ä¸Šä¸€ä¸ªchunkæ˜¯å¦æ­£åœ¨ä½¿ç”¨ï¼ŒåŸç†æ˜¯é€šè¿‡ç›´æ¥æŸ¥çœ‹å½“å‰chunkçš„Pä½æ˜¯å¦==1
#define prev_inuse(p)       ((p)-&gt;size &amp; PREV_INUSE)
//æŸ¥çœ‹å½“å‰chunkæ˜¯å¦ä¸ºinuseï¼ŒåŸç†æ˜¯é€šè¿‡æŸ¥çœ‹å®ƒç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ªchunkçš„PREV_INUSEä½
#define inuse(p)							      \
  ((((mchunkptr) (((char *) (p)) + ((p)-&gt;size &amp; ~SIZE_BITS)))-&gt;size) &amp; PREV_INUSE)
//æ£€æŸ¥å½“å‰chunkçš„å¤§å°æ˜¯å¦å°äºlargebinçš„æœ€å°å¤§å°
#define in_smallbin_range(sz)   ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)
//2.3ã€æŸ¥çœ‹
#define chunksize(p)         ((p)-&gt;size &amp; ~(SIZE_BITS))

//3ã€å†…å­˜åˆå§‹åŒ–=============================
//åœ¨mallocæ—¶ï¼Œç”¨perturb_byte^0xffæ¥åˆå§‹åŒ–å¡«å……å—å†…å®¹ã€‚ï¼ˆè¿™é‡Œ^0xffå°±ç›¸å½“äºæ˜¯æŠŠperturb_byteçš„å…¨éƒ¨ä½å–åï¼Œè¿™æ˜¯ä¸ºäº†è°ƒè¯•æ—¶å¯ä»¥æ›´å®¹æ˜“åœ°è¯†åˆ«å‡ºæ˜¯åœ¨ä½¿ç”¨æœªåˆå§‹åŒ–çš„å†…å­˜è¿˜æ˜¯åœ¨ä½¿ç”¨å·²ç»é‡Šæ”¾çš„å†…å­˜ï¼‰
//åœ¨freeæ—¶ï¼Œç”¨perturb_byteæ¥åˆå§‹åŒ–å¡«å……å—å†…å®¹ã€‚
//æ³¨æ„ï¼Œperturb_byte çš„é»˜è®¤å€¼é€šå¸¸æ˜¯ 0ï¼Œè€Œå½“perturb_byte==0æ—¶ï¼Œé»˜è®¤ä¸è¿›è¡Œå†…å­˜æ‰°åŠ¨æ“ä½œï¼ï¼ï¼ï¼ˆä»¥å‡å°‘æ—¶é—´æ¶ˆè€—ï¼‰åªæœ‰å½“è°ƒè¯•æ—¶è®¾ç½®äº†perturb_byteï¼Œæ‰ä¼šè¿›è¡Œå†…å­˜æ‰°åŠ¨æ“ä½œã€‚
static void alloc_perturb (char *p, size_t n){
  if (__glibc_unlikely (perturb_byte))
    memset (p, perturb_byte ^ 0xff, n);
}
static void free_perturb (char *p, size_t n){
  if (__glibc_unlikely (perturb_byte))
    memset (p, perturb_byte, n);
}

//4ã€å…¶ä»–=====================================
//æœ€å°chunkå¤§å°=4ä¸ªæŒ‡é’ˆå¤§å°
#define MIN_CHUNK_SIZE (offsetof(struct malloc_chunk, fd_nextsize))</code></pre></details></li></ul><ul id="17d0427e-38bb-80e3-abf3-ccafb6e14bb8" class="toggle"><li><details open=""><summary><strong>2ã€ä¼šç”¨åˆ°çš„ä¸€äº›æ£€æŸ¥å‡½æ•°ï¼šdo_check_chunkå‡½æ•°</strong></summary><p id="63126137-109e-4b27-86e3-44a38d40f351" class="">ã€æµç¨‹ç®€ä»‹ã€‘</p><p id="5ff24e4e-89c1-42fa-a5bc-7a83bbf06f0a" class="">1ã€å¯¹äºæ™®é€šå—ï¼Œåˆ†æå½“å‰å—å¤´ã€å°¾æ‰€å¤„ä½ç½®çš„åˆæ³•æ€§</p><p id="b4abf5e2-a7a5-4d6a-8ae5-60afec5c8e3e" class="">2ã€å¯¹äºtopchunkï¼Œæ£€æŸ¥å…¶å¤§å°æ˜¯å¦åˆæ³•ï¼Œä»¥åŠæ£€æŸ¥å…¶å‰ä¸€ä¸ªå—æ˜¯å¦éµå®ˆâ€œæ€»æ˜¯æ ‡è®°ä¸ºå·²ä½¿ç”¨â€</p><blockquote id="aa6bddb9-b48b-485d-8de1-3973d1f3efea" class="">åœ¨å“ªé‡Œéƒ½å¯ä»¥çœ‹åˆ°è¿™å°å­ï¼Œä¸€èˆ¬åœ¨ä»»ä½•checkå‡½æ•°çš„å¼€å¤´éƒ½ä¼šè°ƒç”¨è¯¥å‡½æ•°checkä¸€ä¸‹~çœŸå·æ‡’å•Šå¼€å‘è€…</blockquote><p id="17d0427e-38bb-800c-8e83-d50673b10101" class="">ã€ä»£ç ã€‘</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="38eda44f-c651-4bba-98b0-db1a92d8a59e" class="code"><code class="language-Plain Text">//å…¶ä¸­ï¼Œdo_check_chunkå‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š------------------------------------------
static void do_check_chunk (mstate av, mchunkptr p){
  // è·å–å—çš„å¤§å°
  unsigned long sz = chunksize (p);
  // 0ã€å‡è®¾è¿ç»­åˆ†é…ä¸‹ï¼Œè®¡ç®—pçš„åœ°å€å¯åˆæ³•å–å¾—çš„æœ€å°å€¼å’Œæœ€å¤§å€¼
  char *max_address = (char *) (av-&gt;top) + chunksize (av-&gt;top);
  char *min_address = max_address - av-&gt;system_mem;

  // å¦‚æœå—ä¸æ˜¯é€šè¿‡ mmap åˆ†é…çš„
  if (!chunk_is_mmapped (p)){
			// å¦‚æœå½“å‰å—ä¸æ˜¯topchunk
      if (p != av-&gt;top){
          // å¦‚æœå½“å‰å †åŒºæ˜¯è¿ç»­çš„
          if (contiguous (av)){
              // 1ã€æ£€æŸ¥å—åœ°å€åœ¨æœ€å°å’Œæœ€å¤§åœ°å€ä¹‹é—´
              // è¿™æ˜¯ä¸ºäº†é˜²æ­¢â€œfastbinçš„ä»»æ„åˆ†é…æ¼æ´â€ä¹‹ç±»çš„ï¼Œåœ¨ä»»æ„åœ°å€ä¸Šé¢æ„å»ºfreechunkçš„æ¼æ´
              assert (((char *) p) &gt;= min_address);              //å½“å‰å—å¤´åœ°å€å¿…é¡»æ˜¯å¤§äºåˆšåˆšç®—å‡ºæ¥çš„å¯åˆæ³•å–å¾—çš„æœ€å°å€¼
              assert (((char *) p + sz) &lt;= ((char *) (av-&gt;top)));//é€šè¿‡å—å¤´+å—çš„å¤§å°ï¼Œè®¡ç®—å½“å‰å—å°¾åœ°å€è¦æ±‚å…¶ä¸è¶…è¿‡topchunkå¤´åœ°å€
            }
        }
      // å¦‚æœå½“å‰å—æ˜¯topchunk
      else{
          // 2ã€æ£€æŸ¥ï¼š
          //   ï¼ˆ1ï¼‰top å—çš„å¤§å°è‡³å°‘ä¸º MINSIZE
          //   ï¼ˆ2ï¼‰top å—çš„å‰ä¸€ä¸ªå—æ˜¯å¦éµå®ˆâ€œæ€»æ˜¯æ ‡è®°ä¸ºå·²ä½¿ç”¨â€
          assert ((unsigned long) (sz) &gt;= MINSIZE);
          assert (prev_inuse (p));//å› ä¸ºæ­£å¸¸æ¥è¯´ï¼Œtopchunkä¼šå› ä¸ºåˆå¹¶æœºåˆ¶è€Œå»åå¹¶å®ƒä¹‹å‰çš„æ‰€æœ‰freechunkç›´åˆ°é‡åˆ°ä¸€ä¸ªinuseçš„chunk
													        //å¦‚æœæ²¡æœ‰è¿™æ ·çš„è¯ï¼Œé‚£æˆ–è®¸è¯´æ˜topchunkçš„ä½ç½®è¢«äººä¸ºä¿®æ”¹è¿‡ï¼
        }
    }
  // å¦‚æœå—æ˜¯é€šè¿‡ mmap åˆ†é…çš„ï¼Œå³ï¼šå—çš„åœ°å€åœ¨ä¸»å †å¤–
  else{
		  // å¦‚æœå½“å‰è¿™ä¸ªå †åœ°å€æ˜¯è¿ç»­çš„ï¼Œä½†å®ƒçš„topchunkä¸æ˜¯ä¸»å †çš„é‚£ä¸ªtopchunk
      if (contiguous (av) &amp;&amp; av-&gt;top != initial_top (av)){
          // 3ã€æ£€æŸ¥ï¼šå½“å‰å—èµ·å§‹åœ°å€å¿…é¡»åœ¨æœ€å°åœ°å€ä¹‹å‰æˆ–æœ€å¤§åœ°å€ä¹‹é—´ï¼Œå¦åˆ™æŠ¥é”™
          assert (((char *) p) &lt; min_address || ((char *) p) &gt;= max_address);
        }
      // 4ã€è¿›è¡Œä»¥ä¸‹ä¸¤ä¸ªæ£€æŸ¥ï¼š
      //   ï¼ˆ1ï¼‰å—å¤§å°ä¸å‰ä¸€ä¸ªå—çš„å¤§å°ä¹‹å’Œæ˜¯å¦æŒ‰ç…§ç³»ç»Ÿå†…å­˜é¡µå¤§å°å¯¹é½ã€‚
      //   ï¼ˆ2ï¼‰æ£€æŸ¥ç»™å®šå— p çš„èµ·ç‚¹åœ°å€æ˜¯å¦æŒ‰ç…§ç³»ç»Ÿè¦æ±‚å‘4B&amp;8Bå¯¹é½ã€‚
      assert (((p-&gt;prev_size + sz) &amp; (GLRO (dl_pagesize) - 1)) == 0);
      assert (aligned_OK (chunk2mem (p)));
    }
}</code></pre></details></li></ul><h3 id="17d0427e-38bb-8006-bd57-d4b5d86f1de0" class="">2-mallocä¸“ç”¨å‰ç½®ä»£ç </h3><ul id="7cd63176-484b-4433-83fe-879fe236724f" class="toggle"><li><details open=""><summary><strong>1ã€ä¼šç”¨åˆ°çš„ç›¸å…³å®ï¼šæ ‡è®°ä½è®¾ç½®ã€biné“¾è¡¨ç»´æŠ¤ã€ä½å›¾ã€sizeæ£€æŸ¥å’Œè½¬æ¢</strong></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="46c83d57-1cac-4a69-86e8-8cf98217d959" class="code"><code class="language-Plain Text">//1ã€ä¸€äº›æ ‡è®°ä½è®¾ç½®ç›¸å…³å®ï¼š
#define set_head(p, s)       ((p)-&gt;size = (s))
//å¯ä»¥çœ‹åˆ°æ‰€è°“çš„å¯¹ä¸€ä¸ªchunkçš„â€œsetfootâ€æ“ä½œï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨å…¶æœ«4Bï¼ˆx64ä¸‹æ˜¯æœ«8Bï¼‰å†™å…¥å®ƒçš„sizeï¼Œä¹Ÿå°±ç›¸å½“äºæ˜¯åœ¨å¡«å†™å®ƒçš„ç‰©ç†ç›¸é‚»ä¸‹ä¸€ä¸ªchunkçš„prev_size
//å› ä¸ºprevsizeåªç”¨äºfreechunkï¼Œæ‰€ä»¥åªæœ‰è¢«freeçš„chunkæˆ–è€…è¢«åˆ‡å‰²åå‰©ä¸‹çš„remainderä¼šéœ€è¦è¢«è¿›è¡Œset_footæ“ä½œï¼
#define set_foot(p, s)       (((mchunkptr) ((char *) (p) + (s)))-&gt;prev_size = (s))

//2ã€ä¸€äº›biné“¾è¡¨ç»´æŠ¤çš„å®ï¼š
//2.1ã€firstã€lastï¼šè·å¾—é“¾è¡¨å¤´æˆ–è€…é“¾è¡¨å°¾
#define first(b)     ((b)-&gt;fd)
#define last(b)      ((b)-&gt;bk)
//2.2ã€bin_atï¼šè¿”å›æŒ‡å®šç´¢å¼•å¯¹åº”çš„binçš„æŒ‡é’ˆï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œè¿”å›çš„æ˜¯bins[idx]è¿™ä¸ªæ•°ç»„å…ƒç´ çš„åœ°å€ï¼‰
#define bin_at(m, i) \
  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2])) - offsetof (struct malloc_chunk, fd))
  
//3ã€ä½å›¾ç›¸å…³ï¼š
#define NBINS            128
#define BINMAPSHIFT      5
#define BITSPERMAP       (1U &lt;&lt; BINMAPSHIFT)             // 1U &lt;&lt; 5 ç›¸å½“äº 1 * 2^5 = 32
#define BINMAPSIZE       (NBINS / BITSPERMAP)            // 128 / 32 ç›¸å½“äº 4
#define idx2block(i)     ((i) &gt;&gt; BINMAPSHIFT)            // idx &gt;&gt; 5 ï¼Œå› ä¸ºlargebinæ˜¯ä½äºbin[64]~bin[126]ï¼Œä¹Ÿå°±æ˜¯è¯´å…¶idxæ˜¯0b100,0000~0b111,1110ï¼Œ&gt;&gt;5å°±å¿…å¾—åˆ°0b10ä¹Ÿå°±æ˜¯2ã€‚è¯¥å­—æ®µæ˜¯ç”¨æ¥åšbinmapçš„ä¸‹æ ‡ï¼Œä¹Ÿå°±æ˜¯è¯´largebinå¯¹åº”çš„å°±æ˜¯binmap[2]ã€‚
#define idx2bit(i)       ((1U &lt;&lt; ((i) &amp; ((1U &lt;&lt; BINMAPSHIFT) - 1))))     // (1U &lt;&lt; BINMAPSHIFT) - 1å¾—0b11111ï¼Œå»&amp;idxä¹Ÿå°±ç›¸å½“äºåªä¿ç•™æœ«5ä¸ªäºŒè¿›åˆ¶ä½ï¼Œä¹Ÿå°±æ˜¯â€”â€”è·å–içš„æœ€ä½BINMAPSHIFTä¸ªä½ï¼ˆ5ä½ï¼‰ï¼Œè¿™å®é™…ä¸Šæ˜¯iåœ¨blockå†…çš„åç§»é‡ã€‚
                                                                         // æœ€åå°†1å·¦ç§»ä¸Šè¿°è®¡ç®—å‡ºçš„åç§»é‡ã€‚å®ƒç”Ÿæˆäº†ä¸€ä¸ªä»…æœ‰ä¸€ä¸ªä½è¢«è®¾ç½®ä¸º1çš„æ•°ï¼Œè¿™ä¸ª1çš„ä½ç½®æ­£å¥½å¯¹åº”äºbinç´¢å¼•iåœ¨ä½å›¾çš„æŸä¸ªunsigned intä¸­çš„ä½ç½®ã€‚
                                                                         // æŠŠä½å›¾çš„é‚£ä¸ªunsigned intï¼Œå» &amp; â€œè¿™ä¸ªidx2bit(idx)çš„ç»“æœâ€ï¼Œå¾—åˆ°çš„å€¼å¦‚æœé0å°±è¡¨ç¤ºidxå¯¹åº”çš„largebinä¸ä¸ºç©ºï¼Œå¦åˆ™åˆ™ä¸ºç©ºã€‚
unsigned int binmap[BINMAPSIZE];                         // ä¸€å…±5ä¸ªunsigned intï¼Œæ¯ä¸ªæ˜¯32ä½ã€‚largebinå¯¹åº”çš„æ˜¯binmap[2]ï¼Œè¿™ä¸ªunsigned intçš„32ä¸ªbitå¯¹åº”çš„æ˜¯32æ¡largebinæ˜¯å¦ä¸ºç©ºã€‚

//4ã€chunkåˆ‡å‰²ç›¸å…³å®
//chunk_at_offsetï¼šè¾“å…¥victimä½ç½®å’Œæ‰€éœ€åˆ‡å‰²çš„å¤§å°ï¼Œè¾“å‡ºåˆ‡å‰²åremainderå—å¤´çš„åœ°å€ã€‚
//ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œåˆ‡å‰²åçš„victimåœ¨ä½åœ°å€ï¼Œåˆ‡å‰²åçš„remainderåœ¨é«˜åœ°å€ã€‚
#define chunk_at_offset(p, s)  ((mchunkptr) (((char *) (p)) + (s)))

//5ã€sizeæ£€æŸ¥å’Œè½¬æ¢
//æœ€å°chunkå¤§å°
//å…¶ä¸­ï¼ŒMIN_CHUNK_SIZEè¡¨ç¤ºmalloc_chunkç»“æ„ä½“ä»å¼€å§‹å¤„åˆ° fd_nextsize æˆå‘˜å¼€å§‹ä¹‹é—´çš„å­—èŠ‚æ•°ï¼Œæ˜¯4*SIZE_SZï¼›è¿™ä¸ªMINSIZEçš„å€¼ä¹Ÿä¸€èˆ¬æ˜¯4*SIZE_SZ
#define MIN_CHUNK_SIZE        (offsetof(struct malloc_chunk, fd_nextsize))
#define MINSIZE  \
  (unsigned long)(((MIN_CHUNK_SIZE+MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))
//x32ä¸‹MALLOC_ALIGNMENT=8,MALLOC_ALIGN_MASK=7
#define MALLOC_ALIGNMENT       MAX (2 * sizeof(size_t),__alignof__ (long double))
#define MALLOC_ALIGN_MASK      (MALLOC_ALIGNMENT - 1)
//checked_request2sizeï¼šæ£€æŸ¥è¯·æ±‚çš„å¤§å°æ˜¯å¦æ˜¯ä¸€ä¸ªåˆç†çš„èŒƒå›´ï¼Œå°†è¯·æ±‚çš„å¤§å°è½¬æ¢ä¸º_int_mallocä¸­å®é™…è¦ç”³è¯·çš„å—å¤§å°ã€‚
#define checked_request2size(req, sz)                             \
  if (REQUEST_OUT_OF_RANGE (req)) {					      \
      __set_errno (ENOMEM);						      \
      return 0;								      \
    }									      \
  (sz) = request2size (req);
//å…¶ä¸­ï¼Œæ¶‰åŠåˆ°çš„å®å®šä¹‰æœ‰ä¸¤ä¸ªï¼š
//ï¼ˆ1ï¼‰REQUEST_OUT_OF_RANGEï¼šæ£€æŸ¥è¦ç”³è¯·çš„å¤§å°æ˜¯å¦è¿‡å¤§ï¼
//    çœ‹è¦ç”³è¯·çš„å¤§å°æ˜¯å¦å¤§äº(unsigned long) (INTERNAL_SIZE_T) (-2 * MINSIZE))ï¼Œå¦‚æœå¤§äºå°±ç®—æº¢å‡ºäº†ï¼Œè¿”å›trueã€‚
//    è¿™é‡Œ(-2 * MINSIZE)å®ƒå®é™…ä¸Šæ˜¯0xFFFF FFFF FFFF FFF0ã€‚è¢«è½¬æ¢æˆæ— ç¬¦å·æ•°æ˜¯ä¸€ä¸ªç‰¹åˆ«å¤§çš„æ•°ã€‚
#define REQUEST_OUT_OF_RANGE(req)                                 \
  ((unsigned long) (req) &gt;=						      \
   (unsigned long) (INTERNAL_SIZE_T) (-2 * MINSIZE))
// ï¼ˆ2ï¼‰request2sizeï¼šæŠŠç”¨æˆ·ç”³è¯·çš„å¤§å°ï¼Œè½¬æ¢ä¸º_int_mallocä¸­å®é™…è¦ç”³è¯·çš„å—å¤§å°ã€‚
//    ç”¨æˆ·ç¨‹åºè¦ç”³è¯·çš„å¤§å°ï¼Œå¦‚æœå°äºMINSIZEï¼Œåˆ™è¿”å›MINSIZEã€‚
//    å¦‚æœå¤§äºMINSIZEï¼Œåˆ™åŠ ä¸Š3*SIZE_SZï¼ˆæ¯ä¸ªSIZE_SZçš„å¤§å°ç›¸å½“äºä¸€ä¸ªæŒ‡é’ˆå¤§å°ï¼‰çš„å¤§å°ï¼Œç„¶åå†å°†å…¶æœ«ä¸‰ä½æ¸…é›¶ã€‚
#define request2size(req)                                         \
  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \
   MINSIZE :                                                      \
   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</code></pre></details></li></ul><ul id="072328b7-dce7-4d2b-9ebf-b1716332b506" class="toggle"><li><details open=""><summary><strong>2ã€ä¼šç”¨åˆ°çš„æ•°æ®ç»“æ„ï¼šsmallbinã€largebin</strong></summary><p id="19e45597-83a8-4511-93d5-dfbb3b80f94c" class=""><strong>smallbinsï¼š</strong></p><figure id="d43eb53e-54be-4b2b-b668-f130035d282e" class="image"><a href="%E5%A0%86%E5%88%9B%E5%BB%BA%E5%88%A0%E9%99%A4%E8%BF%87%E7%A8%8B%EF%BC%88%E9%99%84%E6%BA%90%E7%A0%81%EF%BC%89%204577645dfc3b419b9e615a0dc389f6fa/Untitled.png"><img style="width:621.5625px" src="%E5%A0%86%E5%88%9B%E5%BB%BA%E5%88%A0%E9%99%A4%E8%BF%87%E7%A8%8B%EF%BC%88%E9%99%84%E6%BA%90%E7%A0%81%EF%BC%89%204577645dfc3b419b9e615a0dc389f6fa/Untitled.png"/></a></figure><blockquote id="e8cdc72d-93cf-492d-b79c-dd2ad586b69f" class=""><mark class="highlight-red">æ³¨æ„ï¼æ¯ä¸ª smallbin é“¾è¡¨åœ¨åˆå§‹åŒ–æ—¶éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå¤´ç»“ç‚¹ã€‚</mark></blockquote><p id="797db03d-cfd1-4f5d-adcf-03418af09d4b" class=""><strong>largebinsï¼š</strong></p><figure id="f6008d8d-77b6-46b7-b03c-45963a343882" class="image"><a href="%E5%A0%86%E5%88%9B%E5%BB%BA%E5%88%A0%E9%99%A4%E8%BF%87%E7%A8%8B%EF%BC%88%E9%99%84%E6%BA%90%E7%A0%81%EF%BC%89%204577645dfc3b419b9e615a0dc389f6fa/Untitled%201.png"><img style="width:528px" src="%E5%A0%86%E5%88%9B%E5%BB%BA%E5%88%A0%E9%99%A4%E8%BF%87%E7%A8%8B%EF%BC%88%E9%99%84%E6%BA%90%E7%A0%81%EF%BC%89%204577645dfc3b419b9e615a0dc389f6fa/Untitled%201.png"/></a></figure></details></li></ul><ul id="1d8737ba-52bf-4329-b7f4-b8a63de3bbce" class="toggle"><li><details open=""><summary><strong>3ã€ä¼šç”¨åˆ°çš„ä¸€äº›æ£€æŸ¥å‡½æ•°ï¼šdo_check_malloced_chunkã€do_check_remalloced_chunk</strong></summary><p id="a26f5ca9-4010-47b8-acc5-0027fee14305" class=""><strong>do_check_remalloced_chunkå‡½æ•°ï¼š</strong></p><p id="a9d2bc80-dbfe-4e92-93ae-e377e40541b7" class="">é’ˆå¯¹å›æ”¶å†åˆ©ç”¨çš„å—è¿›è¡Œä¸€äº›æ£€æŸ¥~</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2e2b8332-d5dd-4dee-a08d-5b7ecd1e6a95" class="code"><code class="language-Plain Text">//do_check_remalloced_chunkå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š-------------------------------------

static void do_check_remalloced_chunk(mstate av, mchunkptr p, INTERNAL_SIZE_T s) {
    // è·å–å—çš„å¤§å°(é€šè¿‡æŠŠchunksizeä¸­çš„æ ‡å¿—ä½å»é™¤å¹²å‡€å¾—åˆ°~)
    INTERNAL_SIZE_T sz = p-&gt;size &amp; ~(PREV_INUSE | NON_MAIN_ARENA);

    // 1ã€å¦‚æœè¯¥å—ä¸æ˜¯é€šè¿‡ mmap åˆ†é…ï¼Œæ£€æŸ¥ç¡®ä¿å—æ‰€å±çš„ arena æ­£ç¡®---------------------------------
    if (!chunk_is_mmapped(p)) {
        assert(av == arena_for_chunk(p));  // è·å–å—æ‰€å±çš„ arena
        // åšä»¥ä¸‹æ£€æŸ¥ä»¥ç¡®ä¿å—æ‰€å±çš„ arena æ­£ç¡®
        if (chunk_non_main_arena(p))       // å¦‚æœå—ä¸Šé¢çš„non_main_arenaæ ‡å¿—ä½æç¤ºâ€œå½“å‰å—åœ¨éä¸» arena ä¸­â€
            assert(av != &amp;main_arena);     // åˆ™è¦ç¡®ä¿ä¼ å‚avå¯¹åº”çš„åº”è¯¥ä¹Ÿâ€œä¸æ˜¯ä¸» arenaâ€
        else                               // å¦‚æœå—ä¸Šé¢çš„non_main_arenaæ ‡å¿—ä½æç¤ºâ€œå½“å‰å—åœ¨ä¸» arena ä¸­â€
            assert(av == &amp;main_arena);     // åˆ™è¦ç¡®ä¿ä¼ å‚avå¯¹åº”çš„åº”è¯¥ä¹Ÿâ€œæ˜¯ä¸» arenaâ€
    }

    // 2ã€æ‰§è¡Œdo_check_inuse_chunkå‡½æ•°è¿›è¡Œç›¸å…³æ£€æŸ¥-----------------------------------------
    do_check_inuse_chunk(av, p);           // å…³äºè¯¥å‡½æ•°çš„å®šä¹‰è¯¦è§â€œfreeå‡½æ•°-2ã€ä¼šç”¨åˆ°çš„ä¸€äº›æ£€æŸ¥â€ï¼Œç®€å•æ¥è¯´ï¼Œå®ƒæ‰§è¡Œäº†ä»¥ä¸‹å·¥ä½œ~ğŸ‘‡
																				   // 1ã€æŸ¥çœ‹å½“å‰chunkæ˜¯å¦æ»¡è¶³â€œæ­£åœ¨ä½¿ç”¨â€ï¼ŒåŒæ—¶ç”¨do_check_chunkæ£€æŸ¥å…¶åˆæ³•æ€§
																					 // 2ã€ç„¶åæŸ¥çœ‹å½“å‰chunkçš„å‰åchunkï¼Œå¦‚æœæ˜¯freechunkå¯¹ä»–ä»¬ä½¿ç”¨do_check_free_chunkçš„åˆæ³•æ€§

		// 3ã€ç„¶åè¿›è¡Œä»¥ä¸‹ä¸€ç³»åˆ—æ£€æŸ¥----------------------------------------------------------
    // 3.1å—å¤§å°åˆæ³•æ€§çš„æ£€æŸ¥
    assert((sz &amp; MALLOC_ALIGN_MASK) == 0); // ç¡®ä¿å—å¤§å°ç¬¦åˆå¯¹é½è¦æ±‚
    assert((unsigned long)(sz) &gt;= MINSIZE);// ç¡®ä¿å—å¤§å°&gt;=æœ€å°å—å¤§å°
    // 3.2å—çš„å†…å­˜å¯¹é½æ£€æŸ¥
    assert(aligned_OK(chunk2mem(p)));      // ç¡®ä¿å—çš„å†…å­˜å¯¹é½æ­£ç¡®
    // 3.3è¢«å›æ”¶çš„å—æ˜¯å¦æ¯”â€œè¦è¯·æ±‚çš„å¤§å°â€å¤§ï¼Œä½†æ˜¯å¤§çš„é‡åˆä¸è¶…è¿‡MINSIZE
    assert((long)(sz) - (long)(s) &gt;= 0);          // è¢«å›æ”¶çš„å—æ˜¯å¦æ¯”â€œè¦è¯·æ±‚çš„å¤§å°â€å¤§
    assert((long)(sz) - (long)(s + MINSIZE) &lt; 0); // ä½†æ˜¯å¤§çš„é‡åˆä¸è¶…è¿‡MINSIZE
}</code></pre><p id="637ddc4a-21ce-47f3-923c-fbcd80fe04fe" class=""><strong>do_check_malloced_chunkï¼š</strong></p><p id="1822e813-10d3-446c-b745-6936f25b758c" class="">emmmæè¿™å¥—äº†ä¸ªå¨ƒ~</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="691306da-7cec-45f1-825b-fa3cf6e234d3" class="code"><code class="language-C">do_check_malloced_chunk (mstate av, mchunkptr p, INTERNAL_SIZE_T s){
  /* same as recycled case ... */
  do_check_remalloced_chunk (av, p, s);

  /*
     ... plus,  must obey implementation invariant that prev_inuse is
     always true of any allocated chunk; i.e., that each allocated
     chunk borders either a previously allocated and still in-use
     chunk, or the base of its memory arena. This is ensured
     by making all allocations from the `lowest&#x27; part of any found
     chunk.  This does not necessarily hold however for chunks
     recycled via fastbins.
   */
	
	// è¿™æ®µæ˜¯ä¸ºäº†éªŒè¯â€œfreechunkåˆå¹¶æœºåˆ¶â€æ˜¯å¦æ­£ç¡®æ‰§è¡Œ
  assert (prev_inuse (p));    // ç¡®ä¿æŒ‡é’ˆ p æ‰€æŒ‡å‘çš„å†…å­˜å—çš„å‰ä¸€ä¸ªå†…å­˜å—å·²ç»è¢«ä½¿ç”¨ï¼Œå¦‚æœæ²¡æœ‰è¢«ä½¿ç”¨ï¼Œåˆ™æ–­è¨€å¤±è´¥ï¼Œç¨‹åºåœæ­¢æ‰§è¡Œã€‚
  //#define prev_inuse(p)       ((p)-&gt;size &amp; PREV_INUSE)
}
</code></pre></details></li></ul><h3 id="17d0427e-38bb-808f-a184-e609da5808da" class="">3-freeä¸“ç”¨å‰ç½®ä»£ç </h3><ul id="0c3cbc55-7981-42da-b3d4-d800db2d2459" class="toggle"><li><details open=""><summary><strong>1ã€ä¼šç”¨åˆ°çš„ä¸€äº›ç›¸å…³å®ï¼šmalloc_stateçš„flagsæ ‡å¿—ä½ç›¸å…³ã€å¯¹é½ç›¸å…³ã€æ‰¾fastbinã€å…¶ä»–</strong></summary><p id="62fc8a6f-4add-4218-bbfb-776ce4dec603" class="">ä»£ç å¦‚ä¸‹</p><blockquote id="1e3f7ab1-83eb-4414-9292-19ae0afb8bee" class="">è¿™é‡Œè™½ç„¶è¯´æ˜¯â€œå®â€ï¼Œä½†å®é™…ä¸Šæ˜¯å‡½æ•°</blockquote><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="d4ae23ef-a33d-4b7e-bad4-9ae1d08c9b3a" class="code"><code class="language-Plain Text">//1ã€mallocc_stateç›¸å…³================
//1.1ã€flagsæ ‡å¿—ä½
//æ³¨æ„ï¼šä¸ºäº†ä½¿å¾— have_fastchunks åœ¨å¯åŠ¨æ—¶ä¸ºçœŸï¼ˆå› ä¸ºé™æ€å˜é‡ä¼šè¢«é›¶å¡«å……ï¼‰ï¼Œå…¶çœŸå‡å€¼è¢«åå‘å¤„ç†ï¼ˆä¹Ÿå°±æ˜¯0è¡¨ç¤ºçœŸï¼Œ1è¡¨ç¤ºå‡ï¼‰
#define have_fastchunks(M)     (((M)-&gt;flags &amp; FASTCHUNKS_BIT) == 0)
#define clear_fastchunks(M)    catomic_or (&amp;(M)-&gt;flags, FASTCHUNKS_BIT)
#define set_fastchunks(M)      catomic_and (&amp;(M)-&gt;flags, ~FASTCHUNKS_BIT)
//æ£€æŸ¥ä¸€ç‰‡å†…å­˜åŒºåŸŸæ˜¯å¦æ˜¯è¿ç»­åˆ†é…çš„ï¼Œè¿™æ˜¯ç”¨æ¥æ£€æŸ¥æ•´ä¸ªå †åŒºçš„ï¼Œé€šè¿‡çœ‹æ•´ä¸ªå †åŒºçš„flagsæ ‡å¿—ä½
#define contiguous(M) (((M)-&gt;flags &amp; NONCONTIGUOUS_BIT) == 0)
//è®¾ç½®NONCONTIGUOUS_BITæ ‡å¿—ä½
#define set_noncontiguous(M)   ((M)-&gt;flags |= NONCONTIGUOUS_BIT)
#define set_contiguous(M)      ((M)-&gt;flags &amp;= ~NONCONTIGUOUS_BIT)


//2ã€å¯¹é½ç›¸å…³=========================
//2.1ã€æ£€æŸ¥
//æ£€æŸ¥ç»™å®šçš„å†…å­˜å—æŒ‡é’ˆ p æ˜¯å¦æ­£ç¡®å¯¹é½ï¼Œå¦‚æœæœªå¯¹é½ï¼Œè¿”å›1ï¼Œå…·ä½“æ“ä½œè¿‡ç¨‹å¦‚ä¸‹ï¼š
//1ã€å…ˆæ˜¯è¿›è¡Œ(MALLOC_ALIGNMENT == 2 * SIZE_SZ ? (p) : chunk2mem (p))ï¼Œå…¶ä¸­ï¼š
//    MALLOC_ALIGNMENT æ˜¯å†…å­˜åˆ†é…å™¨è¦æ±‚çš„æœ€å°å¯¹é½å€¼ï¼›SIZE_SZ åˆ™æ˜¯ sizeof(size_t)ï¼Œè¡¨ç¤ºç³»ç»Ÿä¸­ size_t ç±»å‹çš„å¤§å°ï¼Œåœ¨32ä½ç³»ç»Ÿä¸Šä¸º4å­—èŠ‚ï¼Œåœ¨64ä½ç³»ç»Ÿä¸Šä¸º8å­—èŠ‚ã€‚
//    å¦‚æœ MALLOC_ALIGNMENT ç­‰äº 2 * SIZE_SZï¼Œåˆ™ç›´æ¥ä½¿ç”¨æŒ‡é’ˆ pï¼ˆæ­¤æ—¶pæŒ‡å‘å—dataéƒ¨åˆ†ï¼‰ï¼›å¦åˆ™ï¼Œè°ƒç”¨ chunk2mem(p) å‡½æ•°ï¼ˆæ­¤æ—¶pæŒ‡å‘å—å¤´ï¼‰ã€‚
//2ã€ç„¶åæŠŠæŒ‡é’ˆè½¬æ¢ä¸º uintptr_t ç±»å‹ï¼Œè¿™æ˜¯ä¸€ç§æ— ç¬¦å·æ•´æ•°ç±»å‹ã€‚
//3ã€æœ€åå’ŒMALLOC_ALIGN_MASK åšæŒ‰ä½ä¸ï¼Œå…¶ä¸­ï¼š
//    MALLOC_ALIGN_MASK æ˜¯ä¸€ä¸ªæ©ç ï¼Œé€šå¸¸= 2 * SIZE_SZ -1
//    é€šè¿‡å°†æŒ‡é’ˆåœ°å€ä¸è¿™ä¸ªæ©ç è¿›è¡ŒæŒ‰ä½ä¸æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°è¯¥åœ°å€åœ¨å¯¹é½è¾¹ç•Œå†…çš„åç§»é‡ã€‚å¦‚æœç»“æœä¸æ˜¯0ï¼Œåˆ™è¯´æ˜è¯¥åœ°å€æ²¡æœ‰æŒ‰ç…§æŒ‡å®šçš„è¾¹ç•Œå¯¹é½ã€‚
#define misaligned_chunk(p) \
  ((uintptr_t)(MALLOC_ALIGNMENT == 2 * SIZE_SZ ? (p) : chunk2mem (p)) \
   &amp; MALLOC_ALIGN_MASK)
#define aligned_OK(m) (((unsigned long) (m) &amp; MALLOC_ALIGN_MASK) == 0)


//3ã€æ‰¾fastbin=======================
//è¿™é‡Œè¿”å›çš„æ˜¯å¯¹åº”çš„é‚£æ¡fastbiné“¾è¡¨çš„åœ°å€
#define fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx])


//4ã€å…¶ä»–=============================
//4.1ã€é’ˆå¯¹æ¡ä»¶è¡¨è¾¾å¼çš„ä¸€ä¸ªåµŒå¥—ä¿®é¥°
//è¿™æ˜¯gccæä¾›çš„ä¸€ä¸ªç”¨æ¥å¯¹è¯ç¼–è¯‘å™¨ï¼Œä¼˜åŒ–ä»£ç æ‰§è¡Œè·¯å¾„çš„å®å®šä¹‰ã€‚å½“ä½ è¦æ˜¯ç”¨æŸä¸ªæ¯”è¾ƒè¡¨è¾¾å¼ï¼ŒåŒæ—¶åˆçŸ¥é“è¿™ä¸ªæ¯”è¾ƒè¡¨è¾¾å¼çš„å¤§æ¦‚ç‡ç»“æœæ—¶ï¼Œä½ å¯ä»¥ç»™æ¯”è¾ƒè¡¨è¾¾å¼å¥—ä¸Šè¯¥è¯­å¥è¿›è¡Œä¼˜åŒ–ã€‚
//ä¾‹å¦‚ï¼š
//    if (__builtin_expect(x != 0, 0)) {
//        // è¿™ä¸ªåˆ†æ”¯ä¸å¸¸è§ï¼ˆx != 0ï¼‰
//    } else {
//        // è¿™ä¸ªåˆ†æ”¯æ›´å¸¸è§ï¼ˆx == 0ï¼‰
//    }
//åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒçŸ¥é“è¡¨è¾¾å¼ x != 0 çš„ç»“æœå¤§æ¦‚ç‡æ˜¯0ã€‚å› æ­¤æˆ‘ä»¬ç»™è¿™ä¸ªè¡¨è¾¾å¼å¥—ä¸Šäº†è¯¥è¯­å¥ã€‚è¿™å°†ä¼šä½¿å¾—ç¼–è¯‘å™¨å¯¹elseåˆ†æ”¯é‡Œé¢çš„è¯­å¥åšåŠ é€Ÿå¤„ç†ï¼Œå¯¹ifåˆ†æ”¯é‡Œé¢çš„è¯­å¥åšå‡é€Ÿå¤„ç†ï¼ˆæ¯”å¦‚ä¸åšé¢„å¤„ç†åŠ é€Ÿï¼‰ã€‚
# define __builtin_expect(expr, val) (expr)</code></pre></details></li></ul><ul id="6a33bf53-8a66-49a1-bcdb-8dfebbf4942a" class="toggle"><li><details open=""><summary><strong>2ã€ä¼šç”¨åˆ°çš„ä¸€äº›æ£€æŸ¥å‡½æ•°ï¼šcheck_inuse_chunkã€do_check_chunkã€do_check_free_chunk</strong></summary><p id="6863fbbc-32f6-42a1-bca7-76eab5a0a931" class=""><strong>check_inuse_chunkå‡½æ•°ï¼š</strong></p><p id="b901d878-fcb3-49ba-ab4a-82e22f885b61" class="">1ã€æŸ¥çœ‹å½“å‰chunkæ˜¯å¦æ»¡è¶³â€œæ­£åœ¨ä½¿ç”¨â€ï¼ŒåŒæ—¶ç”¨do_check_chunkæ£€æŸ¥å…¶åˆæ³•æ€§</p><p id="771a5890-f931-4ff7-9823-97ee65bb1559" class="">2ã€ç„¶åæŸ¥çœ‹å½“å‰chunkçš„å‰åchunkï¼Œå¦‚æœæ˜¯freechunkå¯¹ä»–ä»¬ä½¿ç”¨do_check_free_chunkçš„åˆæ³•æ€§</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="9941b02d-3066-45c9-9bfd-fdb76fa153df" class="code"><code class="language-Plain Text"># define check_inuse_chunk(A, P)        do_check_inuse_chunk (A, P)
do_check_inuse_chunk (mstate av, mchunkptr p){//ä¼ å‚ä»‹ç»ï¼šavæ˜¯å †åœ°å€ç©ºé—´ï¼Œpæ˜¯å—æŒ‡é’ˆ
  mchunkptr next;

	// 1ã€è°ƒç”¨do_check_chunkå‡½æ•°ï¼Œè¿›è¡Œå®‰å…¨æ€§æ£€æŸ¥
  do_check_chunk (av, p); 

  if (chunk_is_mmapped (p))// å¦‚æœæ˜¯mmappedå—çš„è¯ï¼Œå› ä¸ºæ²¡æœ‰next/prevæ²¡ä»€ä¹ˆå¥½æŸ¥çš„ï¼Œæ‰€ä»¥ç›´æ¥returnæ‰äº†
    return; 

  // 2ã€æ£€æŸ¥å½“å‰å—æ˜¯å¦æ­£åœ¨ä½¿ç”¨ï¼Œæ²¡åœ¨ä½¿ç”¨åˆ™æŠ¥é”™ï¼ï¼ˆæ ¸å¿ƒä»£ç ~ï¼‰
  //psï¼šåé¢çœ‹å½“å‰å—çš„å‰åå—çš„å€¼ï¼Œè¿™æ˜¯å®Œå…¨å‡ºäºâ€œå®‰å…¨æ£€æŸ¥â€çš„ç›®çš„ï¼Œè€Œä¸æ˜¯å‡ºäºâ€œè¾…åŠ©æ£€æŸ¥å½“å‰å—æ˜¯å¦æ­£åœ¨ä½¿ç”¨â€çš„ç›®çš„
  assert (inuse (p));

	// 3ã€å½“å‰ä¸€ä¸ªå—æ˜¯freechunkæ—¶å»æ£€æŸ¥å‰ä¸€ä¸ªå—ï¼š
	//	ï¼ˆ1ï¼‰ç¡®ä¿å‰ä¸€ä¸ªå—å’Œå½“å‰å—åœ¨åœ°å€ä¸Šæ˜¯è¿ç»­çš„ï¼
	//  ï¼ˆ2ï¼‰è°ƒç”¨do_check_free_chunkå‡½æ•°ï¼Œè¿›è¡Œå®‰å…¨æ€§æ£€æŸ¥
  next = next_chunk (p); // è·å–ä¸‹ä¸€ä¸ªå—çš„æŒ‡é’ˆ
  if (!prev_inuse (p)){
      mchunkptr prv = prev_chunk (p); // è·å–å‰ä¸€ä¸ªå—çš„æŒ‡é’ˆ
      assert (next_chunk (prv) == p); // ç¡®ä¿å‰ä¸€ä¸ªå—å’Œå½“å‰å—åœ¨åœ°å€ä¸Šæ˜¯è¿ç»­çš„
      do_check_free_chunk (av, prv);  // è°ƒç”¨do_check_free_chunkå‡½æ•°ï¼Œè¿›è¡Œå®‰å…¨æ€§æ£€æŸ¥
    }

	// 4ã€ç„¶åå°±çœ‹ä¸‹ä¸€ä¸ªç‰©ç†ç›¸é‚»çš„chunk
	//   ï¼ˆ1ï¼‰å¦‚æœä¸‹ä¸€ä¸ªå—æ˜¯topchunkï¼Œåˆ™çœ‹â€œå®ƒçš„å‰ä¸€ä¸ªå—æ˜¯å¦åœ¨ä½¿ç”¨â€â€œtopchunkçš„å¤§å°å¤§äºMINSIZEâ€
	//   ï¼ˆ2ï¼‰å¦‚æœä¸‹ä¸€ä¸ªå—æ˜¯freechunkï¼Œåˆ™è°ƒç”¨do_check_free_chunkå‡½æ•°è¿›è¡Œæ£€æŸ¥
  if (next == av-&gt;top){ 
      assert (prev_inuse (next)); // ç¡®ä¿å‰ä¸€ä¸ªå—æ­£åœ¨ä½¿ç”¨
      assert (chunksize (next) &gt;= MINSIZE); // ç¡®ä¿å—å¤§å°å¤§äºç­‰äºæœ€å°å¤§å°
    }
  else if (!inuse (next)){        // å¦‚æœä¸‹ä¸€ä¸ªå—æœªè¢«ä½¿ç”¨
    do_check_free_chunk (av, next); // è°ƒç”¨do_check_free_chunkå‡½æ•°è¿›è¡Œæ£€æŸ¥
}</code></pre><p id="2aee16af-8bd1-4765-88c4-51cc6288398b" class="">do_check_free_chunkï¼š</p><p id="49d124cb-8bfd-4c7a-844d-29ac5e456cad" class="">1ã€ä¸€äº›å†—ä½™æ£€æŸ¥</p><p id="add04404-b704-4ccb-b605-23f51c87d3d8" class="">2ã€ä¸€ç³»åˆ—å‡ ç§æ£€æŸ¥ï¼š<div class="indented"><p id="e191a214-ffdb-4116-b7ac-914cafd2d213" class="">ï¼ˆ1ï¼‰å¯¹é½ç›¸å…³æ£€æŸ¥ï¼ˆ2ï¼‰å¯¹ä¸‹ä¸€ä¸ªå—çš„prev_sizeå’Œå½“å‰å—çš„sizeçš„ä¸€è‡´æ€§æ£€æŸ¥</p><p id="ff554e30-4500-4541-ad17-537e2010836d" class="">ï¼ˆ3ï¼‰å¯¹â€œå—åˆå¹¶æœºåˆ¶â€æ˜¯å¦æˆåŠŸå®æ–½çš„æ£€æŸ¥ï¼ˆ4ï¼‰ç¡®ä¿å½“å‰freechunkæ­£æ­£ç¡®åœ°å¤„åœ¨æŸæ¡biné“¾ä¸­</p></div></p><blockquote id="e2d3a801-1026-48a2-a8a2-0f593f867194" class="">æ²¡ç”¨ï¼Œdoublefreeæ„å»ºçš„é‚£ä¸ªå‡freechunkå®ƒä¸å’Œåˆ«äººç‰©ç†ç›¸é‚»ï¼Œæ‰€ä»¥å®ƒä¸ä¼šè¢«æŸ¥åˆ°å®ƒâ€œå…¶å®æ²¡æœ‰æ­£ç¡®åœ°å¤„åœ¨æŸæ¡biné“¾ä¸­â€</blockquote><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="13dbc755-a644-41d7-8440-949d9e46b7a6" class="code"><code class="language-Plain Text">// å…¶ä¸­ï¼Œdo_check_free_chunkçš„å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š---------------------------------------------
do_check_free_chunk (mstate av, mchunkptr p){
  INTERNAL_SIZE_T sz = p-&gt;size &amp; ~(PREV_INUSE | NON_MAIN_ARENA); // è®¡ç®—å—çš„å¤§å°
  mchunkptr next = chunk_at_offset (p, sz); // è·å–ä¸‹ä¸€ä¸ªå—çš„æŒ‡é’ˆ

  // 0ã€è¿™é‡Œå®Œå…¨æ˜¯ä¸€å¤„å†—ä½™è®¾è®¡ï¼Œå…¶å®åœ¨do_check_inuse_chunkè°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œå°±å·²ç»åšè¿‡äº†do_check_chunkã€inuseå’Œdo_check_inuse_chunkçš„æ£€æŸ¥
  do_check_chunk (av, p);         // è°ƒç”¨do_check_chunkå‡½æ•°æ£€æŸ¥ä¸€ä¸‹
  assert (!inuse (p));            // ç¡®ä¿å—æœªè¢«ä½¿ç”¨
  assert (!chunk_is_mmapped (p)); // ç¡®ä¿å—ä¸æ˜¯é€šè¿‡ mmap åˆ†é…çš„

  /* é™¤éæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ ‡è®°å—ï¼Œå¦åˆ™å¿…é¡»å…·æœ‰æ­£ç¡®çš„å­—æ®µ */
  if ((unsigned long) (sz) &gt;= MINSIZE){
  
		  //1ã€ä»¥ä¸‹è¿™ä¸€ç³»åˆ—æ£€æŸ¥æ‰æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼
			// ã€‚ã€‚ã€‚å¯¹é½ç›¸å…³çš„æ£€æŸ¥
      assert ((sz &amp; MALLOC_ALIGN_MASK) == 0);  // ç¡®ä¿å—çš„å¤§å°æŒ‰ç…§å—çš„å¯¹é½è¦æ±‚å¯¹é½
      assert (aligned_OK (chunk2mem (p)));     // ç¡®ä¿å—çš„èµ·å§‹åœ°å€æŒ‰ç…§å¯¹é½è¦æ±‚å¯¹é½
      // ã€‚ã€‚ã€‚å¯¹ä¸‹ä¸€ä¸ªå—çš„æ£€æŸ¥
      assert (next-&gt;prev_size == sz);           // ç¡®ä¿ä¸‹ä¸€ä¸ªå—çš„prev_sizeå­—æ®µä¸å½“å‰å—å¤§å°åŒ¹é…
      // ã€‚ã€‚ã€‚å¯¹â€œå—åˆå¹¶æœºåˆ¶â€æ˜¯å¦æˆåŠŸå®æ–½çš„æ£€æŸ¥
      assert (prev_inuse (p));                  // ç¡®ä¿å‰ä¸€ä¸ªå—æ­£åœ¨ä½¿ç”¨
      assert (next == av-&gt;top || inuse (next)); // ç¡®ä¿ä¸‹ä¸€ä¸ªå—æ­£åœ¨ä½¿ç”¨æˆ–è€…æ˜¯å †çš„é¡¶éƒ¨å—
      // ã€‚ã€‚ã€‚ç¡®ä¿å½“å‰freechunkæ­£æ­£ç¡®åœ°å¤„åœ¨æŸæ¡biné“¾ä¸­
      assert (p-&gt;fd-&gt;bk == p); // ç¡®ä¿å‰å‘é“¾æ¥æ­£ç¡®
      assert (p-&gt;bk-&gt;fd == p); // ç¡®ä¿åå‘é“¾æ¥æ­£ç¡®
    }
  else /* ç‰¹æ®Šæ ‡è®°å—ï¼Œè¦æ±‚æ ‡è®°å—çš„å¤§å°å§‹ç»ˆæ˜¯ SIZE_SZ */
    assert (sz == SIZE_SZ); // ç¡®ä¿æ ‡è®°å—çš„å¤§å°æ˜¯ SIZE_SZ
}</code></pre></details></li></ul><h3 id="1860427e-38bb-80cb-bbf0-f2bce215779b" class="">4-å…¶ä»–ç›¸å…³å‡½æ•°çš„å‰ç½®ä»£ç </h3><ul id="1860427e-38bb-806b-ad7e-f5c606b43103" class="toggle"><li><details open=""><summary><strong>1ã€ä¼šç”¨åˆ°çš„ä¸€äº›ç›¸å…³å®ï¼šé€šç”¨unlinkæ“ä½œ</strong></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="1860427e-38bb-809b-a4f8-de56c6c4a987" class="code"><code class="language-Plain Text">// 1ã€é€šç”¨unlinkæ“ä½œ
// è¿™å¯ä»¥æŠŠä¸€ä¸ªchunkç»™unlinkå‡ºä»»ä½•ä¸€ä¸ªé“¾è¡¨
/* Take a chunk off a bin list */
#define unlink(AV, P, BK, FD) {                                            \
    FD = P-&gt;fd;								      \
    BK = P-&gt;bk;								      \
    if (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))		      \
      malloc_printerr (check_action, &quot;corrupted double-linked list&quot;, P, AV);  \
    else {								      \
        FD-&gt;bk = BK;							      \
        BK-&gt;fd = FD;							      \
        if (!in_smallbin_range (P-&gt;size)				      \
            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) {		      \
	    if (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)	      \
		|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    \
	      malloc_printerr (check_action,				      \
			       &quot;corrupted double-linked list (not small)&quot;,    \
			       P, AV);					      \
            if (FD-&gt;fd_nextsize == NULL) {				      \
                if (P-&gt;fd_nextsize == P)				      \
                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;		      \
                else {							      \
                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;			      \
                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;			      \
                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;			      \
                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;			      \
                  }							      \
              } else {							      \
                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;		      \
                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;		      \
              }								      \
          }								      \
      }									      \
}</code></pre></details></li></ul><h1 id="219b382d-9ddd-49f1-b73d-081c0a4cf532" class="block-color-default_background">äºŒã€mallocå‡½æ•°æ‰§è¡Œæµç¨‹</h1><h3 id="9efa7bcd-5db0-4ae4-b1f0-ca8f0efb6f2b" class=""><strong>1-è¿‡ç¨‹ç®€ä»‹</strong></h3><ul id="ace5df45-42d8-4376-8eef-1714ddb32a60" class="toggle"><li><details open=""><summary>1ã€<strong>ä¸€äº›é¢„å¤„ç†</strong></summary><p id="17b0427e-38bb-80b2-a6b9-c6c2ef897688" class="">ï¼ˆ1ï¼‰åœ¨libc_mallocå‡½æ•°é‡Œé¢ï¼Œæ‰§è¡Œmalloc_hookå¹¶å¯¹arenaä¸Šé”ï¼Œ</p><p id="1750427e-38bb-8005-8b0a-d7f708ea0a86" class="">ï¼ˆ2ï¼‰ç„¶åè·³è½¬åˆ°int_mallocå‡½æ•°ï¼ˆåç»­æ“ä½œéƒ½åœ¨è¯¥å‡½æ•°é‡Œï¼‰ï¼Œå¯¹ç”³è¯·å—å¤§å°åšå¯¹é½ï¼šå…ˆåŠ ä¸Šä¸¤ä¸ªæŒ‡é’ˆå¤§å°ï¼Œå†å‘0x8æˆ–0x10å¯¹é½</p><p id="1750427e-38bb-80fe-934d-e649d02ceab9" class="">ï¼ˆ3ï¼‰å¦‚æœå½“å‰çº¿ç¨‹è¿˜æ²¡æœ‰malloc_stateï¼Œåˆ™åšå †åˆå§‹åŒ–æ“ä½œ</p></details></li></ul><ul id="d555bed5-cd12-43fe-a0f7-d481f702e208" class="toggle"><li><details open=""><summary>2ã€è‹¥è¯·æ±‚çš„å—å¤§å°&lt;=get_max_fastï¼Œ<strong>å°è¯•å›æ”¶fastbin</strong></summary><p id="1750427e-38bb-806e-b0e2-d9e6bfab3e7e" class="">ï¼ˆ1ï¼‰æ‰¾å¯¹åº”idxä¸‹é¢æœ‰æ²¡æœ‰å—</p><p id="1750427e-38bb-80d7-ae5e-f3e7a865632a" class="">ï¼ˆ2ï¼‰å¦‚æœæœ‰ï¼Œå¯¹å…¶åšå®‰å…¨æ£€æŸ¥ï¼Œå¦‚ä¸‹ï¼š<div class="indented"><p id="17a0427e-38bb-80c1-8d8c-ff5af940f56f" class="">{1} â€œpopå‡ºçš„å—å¤§å°â€æ˜¯å¦ä¸â€œè¯·æ±‚å¤§å°å¯¹åº”çš„fastbinç´¢å¼•â€åŒ¹é…</p><p id="17a0427e-38bb-8063-9af3-f0b1e8221f2d" class="">{2} <mark class="highlight-blue_background">è°ƒç”¨check_remalloced_chunkå‡½æ•°è¿›è¡Œå®‰å…¨æ£€æŸ¥</mark></p></div></p><p id="17a0427e-38bb-80ef-a745-e6354c9dfcec" class="">ï¼ˆ3ï¼‰ç„¶åæŠŠä»–çš„å†…å®¹å…¨éƒ¨åˆå§‹åŒ–ä¸ºâ€™\0â€™ç„¶åè¿”å›ç»™ç”¨æˆ·<div class="indented"><blockquote id="1750427e-38bb-8040-be28-f82567adac78" class="">æ³¨æ„ï¼šè¿™é‡Œå¤´éƒ¨ç›¸å…³ä¿¡æ¯æ˜¯ä¸€ç‚¹éƒ½ä¸è®¾ç½®ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ ‡å¿—ä½ã€sizeç­‰éƒ½æ²¡è®¾ç½®<p id="1860427e-38bb-80a3-b001-eb2c1b0e5a74" class=""><mark class="highlight-red_background">ä¹Ÿå°±æ˜¯è¯´ï¼Œæ²¡æœ‰è®¾ç½®ç‰©ç†ç›¸é‚»ä¸‹ä¸€ä¸ªchunkçš„Pä½ä¿¡æ¯ä¸º=1ï¼Œè¿™æ˜¯å› ä¸ºåœ¨freeä¸€ä¸ªfastchunkçš„æ—¶å€™æœ¬æ¥å°±æ²¡æœ‰æŠŠä¸‹ä¸€ä¸ªchunkçš„Pä½è®¾ç½®ä¸º=0ï¼ˆä¹Ÿå°±æ˜¯fastchunkæ— è®ºæ˜¯å¦è¢«ä½¿ç”¨ï¼ŒPä½éƒ½æ˜¯=1çš„ï¼‰</mark></p></blockquote></div></p></details></li></ul><ul id="1750427e-38bb-8090-9600-f61c0ea36316" class="toggle"><li><details open=""><summary>3ã€<strong>å°è¯•å›æ”¶smallbin</strong></summary><p id="1750427e-38bb-80c0-afd5-cb26f2efe84d" class="">å°è¯•ä»å¯¹åº”bin[idx]ä¸­å–å‡ºä¸€ä¸ªå—ï¼Œç„¶ååˆ¤æ–­å–å‡ºç»“æœï¼š<div class="indented"><p id="17a0427e-38bb-80dd-848d-e0ba0a83e2b1" class="">{1} å¦‚æœå¾—åˆ°binï¼Œå°±è¡¨ç¤ºæ²¡æœ‰å—å¯ä»¥å–å‡ºï¼Œè·³å‡ºsmallbinå›æ”¶</p><p id="17a0427e-38bb-8056-8060-fe168472d488" class="">{2} å¦‚æœå¾—åˆ°0ï¼Œå°±è¡¨ç¤ºbinæ•°ç»„å’Œmalloc_stateå°šæœªåˆå§‹åŒ–ï¼Œåˆ™è°ƒç”¨malloc_consolidateå‡½æ•°åˆå§‹åŒ–binæ•°ç»„å’Œmalloc_stateï¼Œç„¶åè·³å‡ºsmallbinå›æ”¶</p><p id="17a0427e-38bb-80f2-9051-c7cd9942b0b6" class="">{3} å¦‚æœæ˜¯å¾—åˆ°ä¸€ä¸ªæ­£å¸¸çš„victimå—ï¼Œåˆ™åšå¤„ç†åè¿”å›ç»™åˆ°ç”¨æˆ·<div class="indented"><p id="1750427e-38bb-80b9-a3aa-c9c52cbaea82" class="">â‘  å®‰å…¨æ£€æŸ¥ï¼š<div class="indented"><p id="17a0427e-38bb-8079-a5ed-dab4a729dce9" class=""><mark class="highlight-blue_background">çœ‹victim-&gt;bk-&gt;fdæ˜¯å¦ç­‰äºvictim</mark>ï¼›</p><p id="17a0427e-38bb-80d2-8ff9-f284f67c1e0a" class=""><mark class="highlight-blue_background">è°ƒç”¨check_malloced_chunkå‡½æ•°æ£€æŸ¥ï¼›</mark></p></div></p><p id="17a0427e-38bb-80f8-bcca-d029a7f2b8aa" class="">â‘¡ å°† victim ä» å¯¹åº”çš„small_bin é“¾è¡¨ä¸­ç§»é™¤</p><p id="17a0427e-38bb-80c0-9b52-c279fa6ea391" class="">â‘¢ è®¾ç½®victimç›¸å…³æ ‡å¿—ä½<div class="indented"><blockquote id="17a0427e-38bb-809d-a5e6-f772ab1fcab4" class="">victimç‰©ç†ç›¸é‚»ä¸‹ä¸€ä¸ªchunkçš„prev_inuseä½ã€victimçš„Næ ‡å¿—ä½</blockquote><blockquote id="1750427e-38bb-8072-9603-ecdb5f659b0e" class="">æ³¨æ„ï¼šè¿™é‡Œä¸è®¾ç½®size</blockquote></div></p><p id="17a0427e-38bb-80ed-9e02-fc7ca0b928fd" class="">â‘£ å¯¹åˆ†é…çš„å—åš&#x27;\0&#x27;çš„dataéƒ¨åˆ†åˆå§‹åŒ–ï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·</p></div></p></div></p></details></li></ul><ul id="1750427e-38bb-801d-a6de-e119ab1b8478" class="toggle"><li><details open=""><summary>4ã€ä¸å¾…æ£€æŸ¥largechunkæ˜¯å¦æœ‰å¯ç”¨chunkï¼Œåªè¦æ­¤æ—¶å­˜åœ¨fastchunkï¼Œå°±ç›´æ¥<strong>ç”¨malloc_consolidateæ¥åšfastchunkç¢ç‰‡å—æ•´ç†åˆå¹¶</strong></summary></details></li></ul><ul id="1750427e-38bb-8054-bb89-e69a29cbd5c5" class="toggle"><li><details open=""><summary>5ã€<strong>ä¸€ä¸ªè¶…çº§å¤§çš„å¾ªç¯ï¼Œå¾ªç¯ä¸­ä¼šä¾æ¬¡è¿›è¡Œâ€œå¤„ç†unsortedbinâ†’å›æ”¶largechunkâ†’åˆ‡å‰²topchunkâ€æ“ä½œï¼Œå¦‚ä¸‹ï¼š</strong></summary><p id="17a0427e-38bb-808a-b0a2-c6fab170ddfb" class="">5.1ã€<strong>éå†åœ°å°†unsortedbiné‡Œé¢çš„æ‰€æœ‰unsortedchunkæ•´ç†å½’ç±»</strong>ï¼Œå¾ªç¯ä¸­ä¼šè¿›è¡Œä»¥ä¸‹æ“ä½œ==========================<div class="indented"><p id="1750427e-38bb-80db-b4b4-cfb2241e99b8" class="">ï¼ˆ1ï¼‰<mark class="highlight-blue_background">å®‰å…¨æ£€æŸ¥ï¼švictim-&gt;sizeå–å€¼å¿…é¡»åœ¨ä¸¤å€SIZE_SZå’Œav-&gt;system_memä¹‹é—´</mark></p><p id="1750427e-38bb-8049-88ec-f694d07a47b3" class="">ï¼ˆ2ï¼‰ä¸¤ç§å¯ä»¥ç«‹å³å–å‡ºå½“å‰unsortedchunkçš„æƒ…å†µï¼š<div class="indented"><p id="17b0427e-38bb-8064-bead-e0c9c5591902" class="">{1} å¦‚æœå–å‡ºçš„unsortedchunkåŒæ—¶æ»¡è¶³â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<div class="indented"><p id="1750427e-38bb-8040-a8d0-d14d23d993ca" class="">â‘  æ˜¯ä¸€ä¸ªsallbinèŒƒå›´çš„è¯·æ±‚</p><p id="1750427e-38bb-80ca-8598-fdbc9337fbfe" class="">â‘¡ å½“å‰unsorted chunkæ˜¯unsorted bin ä¸­å”¯ä¸€çš„å—</p><p id="1750427e-38bb-8021-947c-f3765c533e87" class="">â‘¢ å½“å‰unsorted chunkçš„å¤§å°&gt;&quot;è¯·æ±‚å¤§å°+MINSIZE&quot;</p><p id="1750427e-38bb-8071-b519-ede2be6cdf50" class="">â‘£ å®ƒæ˜¯ä¸Šæ¬¡çš„å‰©ä½™å—ï¼ˆå³ï¼švictim==av-&gt;last_remainderï¼‰</p></div></p><p id="1750427e-38bb-801b-9f24-ee46da5c3f33" class="">    åˆ™ç›´æ¥æ‹¿èµ°ï¼Œæ“ä½œå¦‚ä¸‹ï¼š<div class="indented"><p id="1750427e-38bb-806f-a4f1-d2cbaada3d42" class="">â‘  åˆ†å‰²è¿™ä¸ªunsorted chunkï¼Œå‰²å‡ºæ¥çš„å‰©ä½™éƒ¨åˆ†è¿å›unsorted bin</p><p id="1750427e-38bb-800c-abb0-d97b4513b71b" class="">â‘¡ è®¾ç½®å½“å‰victimã€å‰©ä½™å—çš„ç›¸å…³æ ‡å¿—ä½</p><blockquote id="1750427e-38bb-8094-90fe-f4aec0419a2a" class="">victimè®¾ç½®sizeåŸŸã€Pæ ‡å¿—ä½=1ã€Næ ‡å¿—ä½<p id="17b0427e-38bb-80d0-86af-d258f0bd07cb" class="">remainderè®¾ç½®sizeåŸŸã€Pæ ‡å¿—ä½=1ã€ä¸‹ä¸€ä¸ªchunkçš„prev_size=remainder_size</p></blockquote><p id="17b0427e-38bb-80e0-afc3-c12ca76a8b61" class="">â‘¢ <mark class="highlight-blue_background">è°ƒç”¨check_malloced_chunkè¿›è¡Œå®‰å…¨æ£€æŸ¥</mark></p><p id="17b0427e-38bb-8059-92c8-c868ba38a1f8" class="">â‘¢ åš&#x27;\0&#x27;çš„dataéƒ¨åˆ†åˆå§‹åŒ–ï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·</p></div></p><p id="1750427e-38bb-80d6-a84d-eb8c2f3eda5c" class="">{2} å¦‚æœå¤§å°æ­£å¥½åˆé€‚ï¼Œåˆ™ç›´æ¥æ‹¿èµ°ï¼Œæ“ä½œå¦‚ä¸‹â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<div class="indented"><p id="1750427e-38bb-80b9-8805-e17d10a02052" class="">â‘  æŠŠvictimä»unsorted binä¸­unlinkèµ°</p><p id="17b0427e-38bb-80a0-8796-fe7b818ab53b" class="">â‘¡ è®¾ç½®å½“å‰victimçš„ç›¸å…³æ ‡å¿—ä½</p><blockquote id="17b0427e-38bb-80b7-bb5f-cee6102ae347" class="">victimè®¾ç½®Næ ‡å¿—ä½ã€ä¸‹ä¸€ä¸ªchunkçš„Pæ ‡å¿—ä½=1</blockquote><p id="17b0427e-38bb-8083-95d4-cc3638859455" class="">â‘¢ <mark class="highlight-blue_background">è°ƒç”¨check_malloced_chunkè¿›è¡Œå®‰å…¨æ£€æŸ¥</mark></p><p id="1750427e-38bb-80ff-a0ae-d90e762a1639" class="">â‘£ åš&#x27;\0&#x27;çš„dataéƒ¨åˆ†åˆå§‹åŒ–ï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·</p></div></p></div></p><p id="1750427e-38bb-8024-a958-d03a70fde137" class="">ï¼ˆ3ï¼‰å‰é¢ä¸¤ç§æƒ…å†µéƒ½ä¸ç¬¦åˆï¼Œåˆ™å°†å…¶æ”¾è¿›smallbinå’Œlargebinä¸­ï¼Œæ“ä½œå¦‚ä¸‹â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<div class="indented"><p id="1750427e-38bb-80dc-bca8-e6f11eb793a8" class="">{1} æŠŠvictimä»unsorted binä¸­unlinkèµ°ï¼Œç„¶åè®¡ç®—å…¶å¯¹åº”çš„smallbin&amp;largebinç´¢å¼•</p><p id="1750427e-38bb-8016-85d4-e61a521a9372" class="">{2} ç„¶åæ ¹æ®ç´¢å¼•æ‰¾åˆ°é“¾è¡¨ä¸­è¦æ’å…¥ä½ç½®çš„å‰ä¸€ä¸ªèŠ‚ç‚¹è®°ä¸ºfwdï¼Œåä¸€ä¸ªèŠ‚ç‚¹è®°ä¸ºbckï¼Œå…¶ä¸­ï¼š<div class="indented"><p id="1750427e-38bb-80e1-85b5-c4bf3f77d9a7" class="">â‘  å¦‚æœæ˜¯smallbinå°±æ˜¯æ‰¾åˆ°bins[idx]ä¸ºbckï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºfwd</p><p id="1750427e-38bb-8095-8c5d-ed5f95740631" class="">â‘¡ å¦‚æœæ˜¯largebinå°±æ˜¯è¦éµå®ˆä»å¤§åˆ°å°çš„æ’åˆ—é¡ºåºæ‰¾åˆ°bckå’Œfwd</p></div></p><p id="1750427e-38bb-805f-b5f6-e27f8afc9625" class="">{3} å°†å…¶linkå…¥åŒå‘é“¾è¡¨ä¸­ï¼ˆæ”¾å…¥fwdå’Œbckä¹‹é—´ï¼‰</p></div></p></div></p><p id="1770427e-38bb-80d7-a26d-ddce7d0b9828" class="">5.2ã€<strong>å°è¯•åœ¨largebinä¸­å›æ”¶chunk===========================================</strong><br/>ï¼ˆ1ï¼‰å…ˆå°è¯•ä»ç”³è¯·å¤§å°æ‰€å±çš„å¤§å°åŒºé—´å¯¹åº”çš„é‚£æ¡large biné‡Œå–å‡ºchunkï¼Œå…¶ä¸­â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br/><div class="indented"><p id="1790427e-38bb-8005-a024-ca545bf3981f" class="">{1} å¾ªç¯ç›´åˆ°æ‰¾åˆ°åˆé€‚å¤§å°çš„å—</p><blockquote id="1790427e-38bb-80d0-9a13-e0ef39d26309" class="">æ³¨æ„ï¼šå¦‚æœæœ‰å¤šä¸ªç›¸åŒå¤§å°çš„åˆé€‚å¤§å°çš„å—ï¼Œç”¨fd_nextchunkçš„å‰ä¸€ä¸ªchunkä½œä¸ºvictimï¼Œè¿™æ ·å¯ä»¥é¿å…æ›´æ–°fd_nextchunké“¾çš„é¢å¤–æ—¶é—´å¼€æ”¯</blockquote><p id="1790427e-38bb-80c1-bfef-dbe36c108ea1" class="">{2} å°†victimç»™unlinkå‡ºæ¥</p><p id="1790427e-38bb-80d3-8e19-f8d1682e9bee" class="">{3} åˆ‡å‰²ï¼Œç„¶åå¤„ç†åˆ‡å‰²åˆ‡å‰²åçš„å‰©ä½™å—ï¼š<div class="indented"><p id="1790427e-38bb-80a6-acc9-e818a3113f12" class="">â‘  å¦‚æœåˆ‡å‰²åå‰©ä½™å—å¤§å°&lt;æœ€å°å—å¤§å°ï¼Œåˆ™ä¸åˆ‡å‰²ï¼Œå¹¶ä¸”è®¾ç½®äº†victimçš„ç›¸å…³æ ‡å¿—ä½</p><blockquote id="17a0427e-38bb-803c-895f-d41c3830325c" class="">victimçš„Næ ‡å¿—ä½ã€ç‰©ç†ç›¸é‚»ä¸‹ä¸€ä¸ªchunkçš„Pæ ‡å¿—ä½=1</blockquote><p id="1790427e-38bb-8025-b043-c243f92e97b3" class="">â‘¡ å¦‚æœåˆ‡å‰²åå‰©ä½™å—å¤§å°&gt;=æœ€å°å—å¤§å°ï¼Œåˆ™å°†åˆ‡å‰²åå‰©ä½™å—linkå…¥unsortedbinçš„å¼€å¤´ï¼Œå¹¶ä¸”è®¾ç½®äº†victimã€remainderçš„ç›¸å…³æ ‡å¿—ä½</p><blockquote id="17a0427e-38bb-801e-9b18-e7e05257fef7" class="">victimçš„sizeå­—æ®µï¼ŒNæ ‡å¿—ä½ã€Pæ ‡å¿—ä½=1<br/>remainderçš„sizeå­—æ®µã€Pæ ‡å¿—ä½=1ã€footå­—æ®µ=size<br/></blockquote><p id="1790427e-38bb-8013-8490-e770b5669bbe" class="">â‘¢ ç„¶åæŠŠåˆ‡å‰²ä¸‹æ¥çš„å—ï¼Œåªæ˜¯ç®€å•ç”¨check_malloced_chunkå‡½æ•°æ£€æŸ¥ä¸€ä¸‹åï¼Œdataéƒ¨åˆ†åˆå§‹åŒ–ä¸º&#x27;\0&#x27;ï¼Œç„¶åå°±è¿”å›ç»™ç”¨æˆ·</p></div></p><p id="1790427e-38bb-80c3-8afb-cc2c241d94de" class="">{4} <mark class="highlight-blue_background">è°ƒç”¨check_malloced_chunkåšå®‰å…¨æ£€æŸ¥</mark></p></div></p><p id="1790427e-38bb-8031-9088-ccdc37899fcf" class="">ï¼ˆ2ï¼‰å†å»å°è¯•å›æ”¶æ¯”ä»–å¤§çš„biné“¾ä¸Šçš„largechunkâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<div class="indented"><p id="17a0427e-38bb-802c-b898-c4b48037fb83" class="">è¿™é‡Œæ˜¯é€šè¿‡ä¸€ä¸ªå¾ªç¯å®ç°çš„ï¼Œæ¯ä¸ªå¾ªç¯ä¸­ä¼šè¿›è¡Œä»¥ä¸‹æ“ä½œï¼š</p><p id="17a0427e-38bb-80a4-9acb-f24e0c3d0cfe" class="">{1} å…ˆå·§å¦™åœ°ç²—åˆ¤æ–­å½“å‰blockï¼ˆå³ä¸€ä¸ªunsigned intï¼‰é‡Œé¢æ˜¯å¦è¿˜æœ‰å¯ç”¨çš„â€œ1â€ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç›´æ¥è·³è¿‡è¿™ä¸ªblockçš„å‰©ä½™éƒ¨åˆ†ï¼Œæ¥åˆ°ä¸‹ä¸€ä¸ªblockã€ä¸‹ä¸‹ä¸ªblock....ç›´åˆ°æœ‰ä¸€ä¸ªéç©ºblockæˆ–è€…æ‰€æœ‰blockéƒ½ä¸è¡Œå°±ç›´æ¥å»åˆ‡å‰²topchunkã€‚</p><p id="17a0427e-38bb-80ae-b663-ecad726cad42" class="">{2} ä»ä½åˆ°é«˜åœ°æ£€æŸ¥å½“å‰blockä¸­çš„æ¯ä¸€ä½ï¼ˆå…±32ä½ï¼‰ï¼Œç›´åˆ°å…¶ä¸­æœ‰ä¸€ä½ä¸º1æ—¶é€€å‡ºå¾ªç¯ï¼Œæ­¤æ—¶çš„binå°±æŒ‡å‘äº†é‚£æ¡é“¾è¡¨çš„bin[idx]</p><p id="17a0427e-38bb-80b7-bf8f-e518414697e9" class="">{3} å› ä¸ºä½è¡¨ä¹Ÿå¯èƒ½ä¼šäº§ç”Ÿè¯¯æŠ¥ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ä»å¯¹åº”biné‡Œé¢çœ‹èƒ½å¦æˆåŠŸå–å‡ºvictimï¼Œå¦‚æœå–ä¸å‡ºï¼Œå°±æ˜¯è¯¯æŠ¥ï¼Œåˆ™æ›´æ–°ä½è¡¨å¹¶ç§»åŠ¨bit</p><p id="17a0427e-38bb-8049-9cbb-ec021f566805" class="">{4} <mark class="highlight-blue_background">é’ˆå¯¹æ‰€å–å‡ºçš„å—çš„å¤§å°çš„å®‰å…¨æ£€æŸ¥ï¼šæ–­è¨€victimå—å¤§å°&gt;=è¯·æ±‚å¤§å°</mark></p><p id="17a0427e-38bb-80d8-93ec-e5d5afdf2c7d" class="">{5} å°†victimä»largebinä¸­ç»™unlinkå‡ºæ¥</p><p id="17a0427e-38bb-80e6-ae4f-fb2c380c6d3d" class="">{6} å¦‚æœå‰©ä½™å—å°äºæœ€å°å—å¤§å°ï¼Œä¸åˆ‡å‰²ï¼Œå¹¶è®¾ç½®victimç›¸å…³æ ‡å¿—ä½<div class="indented"><blockquote id="17a0427e-38bb-80cd-8f02-efc74995f469" class="">è®¾ç½®victimçš„Næ ‡å¿—ä½ã€victinç‰©ç†ç›¸é‚»ä¸‹ä¸€ä¸ªchunkçš„Pæ ‡å¿—ä½ä¸º1</blockquote></div></p><p id="17a0427e-38bb-8020-90db-cc4d09509621" class="">{7} å¦‚æœå‰©ä½™å—å¤§äºæœ€å°å—å¤§å°ï¼Œåˆ™åˆ‡å‰²ä¸‹æ¥ï¼Œå¹¶ä¸”è®¾ç½®victimå’Œå‰©ä½™å—remainderçš„ç›¸å…³æ ‡å¿—ä½ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š<div class="indented"><p id="17a0427e-38bb-8027-bc3e-d966f5b96d04" class="">â‘  å°†remainderç»™linkå…¥unsortedbinçš„å¼€å¤´</p><p id="17a0427e-38bb-8002-abb6-e3c797c76863" class="">â‘¡ å°†remainderå£°æ˜ä¸ºav-&gt;last_remainder</p><p id="17a0427e-38bb-8014-b9b8-db8aa66d6ef2" class="">â‘¢ å¦‚æœremainderæ˜¯largechunkå¤§å°ï¼Œåˆ™å°†å…¶fd_nextsizeã€bk_nextsizeåŸŸåˆå§‹åŒ–ä¸ºNULL</p><p id="17a0427e-38bb-80c6-819e-cb5f907fc83f" class="">â‘£ è®¾ç½®victimã€remainderçš„ç›¸å…³æ ‡å¿—ä½</p><blockquote id="17a0427e-38bb-8004-89ec-ff4dd2264635" class="">è®¾ç½®victimçš„sizeåŸŸã€Pæ ‡å¿—ä½=1ã€Næ ‡å¿—ä½<p id="17a0427e-38bb-806b-aa67-d64f7fcc5d8c" class="">è®¾ç½®remainderçš„sizeåŸŸã€Pæ ‡å¿—ä½=1ã€ç‰©ç†ç›¸é‚»ä¸‹ä¸€ä¸ªchunkçš„prev_sizeåŸŸ=remainder_size</p></blockquote></div></p><p id="17a0427e-38bb-80d5-b8ae-c7fc6a252576" class="">{8} è°ƒç”¨check_malloced_chunkå‡½æ•°åšå®‰å…¨æ£€æŸ¥ï¼Œå¯¹åˆ†é…çš„å—åš&#x27;\0&#x27;çš„dataéƒ¨åˆ†åˆå§‹åŒ–ï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·ç¨‹åº</p></div></p><p id="1750427e-38bb-8087-8715-d98c20514062" class="">5.3ã€å¦‚æœå‰é¢æ“ä½œéƒ½å¤±è´¥äº†ï¼Œåˆ™<strong>ä»topchunkä¸­åˆ‡å‰²</strong>ï¼Œæˆ–æ‰©å¤§arenaåä»topchunkä¸­åˆ‡å‰²===============================<div class="indented"><p id="17a0427e-38bb-80f6-b29f-ff5346e39819" class="">ï¼ˆ1ï¼‰å¦‚æœtopchunkè¶³å¤Ÿå¤§ï¼ˆåˆ‡å‰²åçš„å‰©ä½™&gt;=æœ€å°å—å¤§å°ï¼‰ï¼Œç›´æ¥åˆ‡å‰²ä¹‹ï¼Œæ“ä½œå¦‚ä¸‹ï¼š<div class="indented"><p id="17a0427e-38bb-80ed-8c38-f6ce3e839793" class="">{1} æ›´æ–°av-&gt;topæŒ‡é’ˆ</p><p id="17a0427e-38bb-8085-89ae-e05bc567470a" class="">{2} è®¾ç½®victimå’Œremainderçš„ç›¸å…³æ ‡å¿—ä½</p><blockquote id="17a0427e-38bb-80db-8615-ee720145593d" class="">victimè®¾ç½®sizeåŸŸï¼ŒPæ ‡å¿—ä½=1ï¼ŒNæ ‡å¿—ä½<p id="17a0427e-38bb-8014-bb6b-ed03f5d0ae2d" class="">remainderè®¾ç½®sizeåŸŸï¼ŒPæ ‡å¿—ä½=1</p></blockquote><p id="17a0427e-38bb-80b7-b8d4-fe25e41063cb" class="">{3} è°ƒç”¨check_malloced_chunkå‡½æ•°è¿›è¡Œå®‰å…¨æ€§æ£€æŸ¥</p><p id="17a0427e-38bb-8051-b501-f8f683f5f0d1" class="">{4} åˆå§‹åŒ–dataä¸º\0åï¼Œè¿”å›ç»™ç”¨æˆ·</p></div></p><p id="17a0427e-38bb-8096-9475-d7df1179c53f" class="">ï¼ˆ2ï¼‰å¦‚æœtopchunkä¸å¤Ÿå¤§ï¼Œä½†æ˜¯æœ‰fastchunkï¼Œåˆ™è°ƒç”¨malloc_consolidateå‡½æ•°</p><p id="17a0427e-38bb-80a2-b51b-c1316fd4086f" class="">ï¼ˆ3ï¼‰å¦‚æœtopchunkä¸å¤Ÿå¤§ï¼Œä¸”æ²¡æœ‰fastchunkï¼Œåˆ™è°ƒç”¨sysmallocå‡½æ•°ï¼Œåœ¨å…¶ä¸­å°è¯•ç›´æ¥è°ƒç”¨mmapåˆ†é…è¶…å¤§chunkéœ€æ±‚&amp;æ‰©å¤§topchunk</p></div></p></details></li></ul><blockquote id="324ed3cf-7f6e-46e8-96b7-a82ba061c626" class="">æ³¨æ„ï¼š<p id="e1cc54e2-d131-432d-93ce-2a05de83c3bf" class=""><mark class="highlight-red">mallocä¸ä¼šå°†ç”³è¯·åˆ°çš„å †å—é‡Œé¢çš„å†…å®¹è®¾ç½®ä¸º0ï¼Œä½†æ˜¯callocä¼šï¼</mark></p></blockquote><h3 id="30cf3f8d-ad17-4f4f-bdb7-4f4d3b0e3513" class=""><strong>2-ç¤ºæ„å›¾</strong></h3><ul id="8e2a1a88-7820-4967-9daf-0cd4b4db628e" class="toggle"><li><details open=""><summary>ä»¥x32ç¯å¢ƒä¸‹çš„mallocå‡½æ•°ä¸ºä¾‹</summary><figure id="17d0427e-38bb-809f-9a76-c19a8f26fd02" class="image"><a href="%E5%A0%86%E5%88%9B%E5%BB%BA%E5%88%A0%E9%99%A4%E8%BF%87%E7%A8%8B%EF%BC%88%E9%99%84%E6%BA%90%E7%A0%81%EF%BC%89%204577645dfc3b419b9e615a0dc389f6fa/1.png"><img style="width:959.1875px" src="%E5%A0%86%E5%88%9B%E5%BB%BA%E5%88%A0%E9%99%A4%E8%BF%87%E7%A8%8B%EF%BC%88%E9%99%84%E6%BA%90%E7%A0%81%EF%BC%89%204577645dfc3b419b9e615a0dc389f6fa/1.png"/></a></figure><figure id="17d0427e-38bb-80fe-a126-c4ed73905d6d" class="image"><a href="%E5%A0%86%E5%88%9B%E5%BB%BA%E5%88%A0%E9%99%A4%E8%BF%87%E7%A8%8B%EF%BC%88%E9%99%84%E6%BA%90%E7%A0%81%EF%BC%89%204577645dfc3b419b9e615a0dc389f6fa/2.png"><img style="width:959.2000122070312px" src="%E5%A0%86%E5%88%9B%E5%BB%BA%E5%88%A0%E9%99%A4%E8%BF%87%E7%A8%8B%EF%BC%88%E9%99%84%E6%BA%90%E7%A0%81%EF%BC%89%204577645dfc3b419b9e615a0dc389f6fa/2.png"/></a></figure></details></li></ul><h3 id="1770427e-38bb-8056-ae3a-e2954385cb4e" class="">3-æºç è§£æ</h3><blockquote id="1730427e-38bb-8060-a981-d85be28b0736" class="">æºç å‡ºå¤„ï¼š<a href="https://elixir.bootlin.com/glibc/glibc-2.23/source/malloc/malloc.c">https://elixir.bootlin.com/glibc/glibc-2.23/source/malloc/malloc.c</a></blockquote><p id="1770427e-38bb-80e9-b94c-e28d64db4873" class="">å…ˆæ˜¯è¿›åˆ°libc_mallocå‡½æ•°ï¼Œç„¶åè¯¥å‡½æ•°è°ƒç”¨_int_mallocå‡½æ•°å»å®Œæˆä¸»è¦çš„å—åˆ›å»ºè¿‡ç¨‹</p><ul id="17b0427e-38bb-809b-9f2a-ddddfa0ce92f" class="toggle"><li><details open=""><summary><strong>__libc_malloc å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</strong></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="17b0427e-38bb-8098-883d-eddfe063fe01" class="code"><code class="language-Plain Text">void * __libc_malloc (size_t bytes) // å‚æ•° bytes è¡¨ç¤ºè¯·æ±‚åˆ†é…çš„å­—èŠ‚æ•°ã€‚
{
  mstate ar_ptr; // ç”¨äºè¡¨ç¤ºå½“å‰çº¿ç¨‹ä½¿ç”¨çš„å†…å­˜åŒºåŸŸï¼ˆarenaï¼‰çš„çŠ¶æ€ã€‚
  void *victim; // ç”¨äºå­˜å‚¨åˆ†é…åˆ°çš„å†…å­˜åœ°å€ï¼Œå¦‚æœåˆ†é…å¤±è´¥åˆ™ä¸º NULLã€‚

	// 1ã€é’©å­å¤„ç†
  // è·å–å…¨å±€ malloc é’©å­å‡½æ•°ã€‚è¿™ä¸ªé’©å­å…è®¸ç”¨æˆ·åœ¨å®é™…åˆ†é…å‘ç”Ÿä¹‹å‰æ’å…¥è‡ªå®šä¹‰é€»è¾‘ã€‚
  void *(*hook) (size_t, const void *) = atomic_forced_read (__malloc_hook);
  // å¦‚æœæœ‰è®¾ç½® malloc é’©å­å¹¶ä¸”å®ƒä¸æ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œåˆ™è°ƒç”¨è¯¥é’©å­è¿›è¡Œå†…å­˜åˆ†é…ã€‚
  if (__builtin_expect (hook != NULL, 0)) // __builtin_expect ä¼˜åŒ–åˆ†æ”¯é¢„æµ‹ã€‚
    return (*hook)(bytes, RETURN_ADDRESS (0)); // è¿”å›é’©å­å‡½æ•°çš„ç»“æœã€‚

  // 2ã€å°è¯•è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„ arenaï¼Œå¹¶å¯¹å…¶ä¸Šé”ã€‚
  // å…·ä½“æ¥è¯´ï¼Œè¯¥å‡½æ•°æ‰§è¡Œæ—¶ï¼Œglibc å†…éƒ¨ä¼šæ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»æœ‰äº†ä¸€ä¸ªå…³è”çš„ arenaã€‚å¦‚æœæ²¡æœ‰ï¼Œå®ƒä¼šå°è¯•æ‰¾åˆ°æˆ–åˆ›å»ºä¸€ä¸ªæ–°çš„ arenaï¼Œå¹¶ä¸”åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šå¯¹å…¨å±€çš„æ•°æ®ç»“æ„ä¸Šé”
  arena_get (ar_ptr, bytes);

  // 3ã€è°ƒç”¨_int_mallocå‡½æ•°è·å¾—ä¸€ç‰‡å†…å­˜
  victim = _int_malloc (ar_ptr, bytes); // _int_malloc æ˜¯æ‰§è¡Œå®é™…åˆ†é…å·¥ä½œçš„å‡½æ•°ã€‚
  
  // 4ã€å¦‚æœç¬¬ä¸€æ¬¡å°è¯•æœªèƒ½æˆåŠŸåˆ†é…å†…å­˜ï¼ˆvictim ä¸ºç©ºï¼‰ï¼Œå¹¶ä¸”æˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†ä¸€ä¸ªå¯ç”¨çš„ arenaï¼Œ
  // åˆ™é‡è¯•ä½¿ç”¨å¦ä¸€ä¸ª arena è¿›è¡Œåˆ†é…ã€‚
  if (!victim &amp;&amp; ar_ptr != NULL)
    {
      LIBC_PROBE (memory_malloc_retry, 1, bytes); // å‘å‡ºè°ƒè¯•ä¿¡æ¯ï¼Œè¡¨æ˜æ­£åœ¨é‡è¯•å†…å­˜åˆ†é…ã€‚
      
      // å°è¯•ä»å…¶ä»– arena è·å–å†…å­˜ã€‚
      ar_ptr = arena_get_retry (ar_ptr, bytes);
      victim = _int_malloc (ar_ptr, bytes); // å†æ¬¡å°è¯•åˆ†é…å†…å­˜ã€‚
    }

	// 5.å¯¹å½“å‰çº¿ç¨‹ç»‘å®šçš„arenaè§£é”
  // å¦‚æœæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª arenaï¼Œåˆ™éœ€è¦è§£é”å®ƒï¼Œä»¥ä¾¿å…¶ä»–çº¿ç¨‹å¯ä»¥ä½¿ç”¨å®ƒã€‚
  if (ar_ptr != NULL)
    (void) mutex_unlock (&amp;ar_ptr-&gt;mutex); // è§£é” arena çš„äº’æ–¥é”ã€‚

	// 6ã€å®‰å…¨æ£€æŸ¥
  // æ–­è¨€ï¼šç¡®ä¿è¿”å›çš„å†…å­˜è¦ä¹ˆæ˜¯é€šè¿‡ mmap åˆ†é…çš„ï¼Œè¦ä¹ˆå±äºå½“å‰çš„ arenaã€‚
  assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||
          ar_ptr == arena_for_chunk (mem2chunk (victim)));

  return victim; // è¿”å›åˆ†é…çš„å†…å­˜åœ°å€ï¼Œæˆ–è€…å¦‚æœåˆ†é…å¤±è´¥åˆ™è¿”å› NULLã€‚
}
// libc_hidden_def å®ç”¨æ¥éšè—ç¬¦å·ï¼Œé˜²æ­¢ç¬¦å·è¢«åŠ¨æ€é“¾æ¥å™¨è§£æã€‚
libc_hidden_def (__libc_malloc);</code></pre></details></li></ul><ul id="1770427e-38bb-800e-9150-feee3c06d8df" class="toggle"><li><details open=""><summary><strong>_int_malloc å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</strong></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b9f3da3d-c953-4d32-a689-4f6aa9f7d421" class="code"><code class="language-C">static void *_int_malloc (mstate av, size_t bytes){
  INTERNAL_SIZE_T nb;               /* è¯·æ±‚çš„chunkçš„å¤§å°ï¼ */
  unsigned int idx;                 /* ç›¸å…³çš„ bin ç´¢å¼• */
  mbinptr bin;                      /* ç›¸å…³çš„ bin */

  mchunkptr victim;                 /* è¢«æ£€æŸ¥/é€‰ä¸­çš„å†…å­˜å— */
  INTERNAL_SIZE_T size;             /* å†…å­˜å—çš„å¤§å° */
  int victim_index;                 /* å†…å­˜å—çš„ bin ç´¢å¼• */

  mchunkptr remainder;              /* æ‹†åˆ†åçš„å‰©ä½™å†…å­˜å— */
  unsigned long remainder_size;     /* å‰©ä½™å†…å­˜å—çš„å¤§å° */

  unsigned int block;               /* ä½å›¾éå†å™¨ */
  unsigned int bit;                 /* ä½å›¾éå†å™¨ */
  unsigned int map;                 /* binmap çš„å½“å‰å­— */

  mchunkptr fwd;                    /* é“¾æ¥çš„ä¸´æ—¶å˜é‡ */
  mchunkptr bck;                    /* é“¾æ¥çš„ä¸´æ—¶å˜é‡ */

  const char *errstr = NULL;

	// 1ã€å¯¹è¯·æ±‚chunkå¤§å°çš„åˆå§‹åŒ–å¤„ç†-----------------------------------------------
  // æ£€æŸ¥è¯·æ±‚çš„å¤§å°æ˜¯å¦è¿‡åˆ†å¤§ï¼Œå¹¶ä¸”å¾€å¤§å°é‡Œé¢æ·»åŠ ä¸¤ä¸ªæŒ‡é’ˆå¤§å°ç„¶åå‘8&amp;16å­—èŠ‚å¯¹é½
  checked_request2size (bytes, nb);

  // 2ã€æ£€æŸ¥ä¸€ä¸‹å¦‚æœav==NULLï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰å †åŒºåˆå§‹åŒ–æ˜¯ç¬¬ä¸€æ¬¡malloc----------------------
  // å¦‚æœæ²¡åˆå§‹åŒ–ï¼Œå°±è°ƒç”¨ sysmallocæ¥å‘osç”³è¯·ä¸€ç‰‡å †ç©ºé—´ï¼Œç„¶åè°ƒç”¨alloc_perturbæŠŠchunkçš„å…¨éƒ¨å†…å®¹è®¾ç½®ä¸º&#x27;\0&#x27;è¿”å›ç»™ç”¨æˆ·
  // ä¹‹æ‰€ä»¥è¿™ä¹ˆç®€å•ï¼Œæ˜¯å› ä¸ºç¬¬ä¸€æ¬¡mallocæ—¶ä¸€å®šä¸æ¶‰åŠé‚£äº›å¤æ‚çš„å †å—å›æ”¶æœºåˆ¶å•¥çš„
  if (__glibc_unlikely (av == NULL)){
      void *p = sysmalloc (nb, av);  //å¦‚æœæ²¡åˆå§‹åŒ–ï¼Œå°±è°ƒç”¨ sysmalloc å‡½æ•°æ¥è¦æ±‚osä¸ºå †åŒºåˆ†é…ä¸€ç‰‡å†…å­˜
																     //è¯¥å‡½æ•°ä¼šå¯¹â€œç®¡ç†å †çš„ç»“æ„ä½“â€è¿›è¡Œåˆå§‹åŒ–ï¼Œç»†èŠ‚æŒºå¤šçš„ï¼Œå‡½æ•°æºç æ”¾ä¸‹è¾¹äº†ï¼Œå› ä¸ºä¸æ¶‰åŠå †pwnæˆ‘å°±ä¸è¯¦ç»†å†™äº†
      if (p != NULL)
					alloc_perturb (p, bytes);  //å¦‚æœåˆå§‹åŒ–æˆåŠŸäº†ï¼Œå°±è°ƒç”¨alloc_perturbæ¥æŠŠchunkçš„å…¨éƒ¨å†…å®¹åˆå§‹åŒ–ä¸º&#x27;\0&#x27;
      return p;
    }
	
	/********************************************
		fastbinå›æ”¶éƒ¨åˆ†ï¼
	*********************************************/
  // 3ã€è¿™é‡Œæ˜¯fastchunkçš„ç”³è¯·ä»£ç ï¼Œå¼€å‘è€…å› ä¸ºè‡ªä»¥ä¸ºæ˜¯çš„ç–å¿½æ‰€ä»¥åšçš„å®‰å…¨æ£€æŸ¥å¾ˆå°‘
	// è‹¥è¯·æ±‚çš„å—å¤§å°&lt;=get_max_fastï¼Œåˆ™å°è¯•ä»å¯¹åº”çš„fastbinä¸­å›æ”¶å—
	if ((unsigned long) (nb) &lt;= (unsigned long) (get_max_fast ())) {
    
    idx = fastbin_index(nb);            // ç¡®å®šè¯·æ±‚å¤§å°å¯¹åº”çš„fastbinç´¢å¼•
    mfastbinptr *fb = &amp;fastbin(av, idx);// è·å–å¯¹åº”çš„fastbiné“¾è¡¨æŒ‡é’ˆï¼Œè®°ä¸ºfb
    mchunkptr pp = *fb;                 // è·å–è¯¥fastbiné“¾è¡¨çš„ç¬¬ä¸€ä¸ªå—ï¼Œè®°ä¸ºpp
    // 3.1ã€ä»fastbinä¸­popå‡ºä¸€å—å¯ç”¨äºåˆ†é…çš„fastchunkï¼Œå­˜æ”¾äºå˜é‡victimä¸­
    do {
        victim = pp;
        if (victim == NULL)  // å¦‚æœå½“å‰å—ä¸ºç©ºï¼Œåˆ™è·³å‡ºå¾ªç¯
            break;
    } while ((pp = catomic_compare_and_exchange_val_acq(fb, victim-&gt;fd, victim)) != victim);
		//whileçš„æ¡ä»¶è¿™é‡Œæ˜¯ä¸€ä¸ªè‡ªæ—‹æ“ä½œï¼Œæ„ä¹‰æ˜¯ä¸ºäº†ä»å½“å‰fastbinä¸­å–å‡ºvictimï¼Œè‡ªæ—‹æ˜¯ä¸ºäº†åº”å¯¹å¤šçº¿ç¨‹

    // å¦‚æœæ‰¾åˆ°å¯ç”¨çš„å¿«é€Ÿå—
    if (victim != 0) {
        // 3.2ã€å®‰å…¨æ£€æŸ¥ï¼šâ€œpopå‡ºçš„å—å¤§å°â€æ˜¯å¦ä¸â€œè¯·æ±‚å¤§å°å¯¹åº”çš„fastbinç´¢å¼•â€åŒ¹é…ï¼Œå¦‚æœä¸åŒ¹é…åˆ™å¯èƒ½å­˜åœ¨å†…å­˜æŸåï¼ŒæŠ¥é”™ä¹‹
        if (__builtin_expect(fastbin_index(chunksize(victim)) != idx, 0)) {
            errstr = &quot;malloc(): memory corruption (fast)&quot;;
            errout:
              malloc_printerr (check_action, errstr, chunk2mem (victim), av);
              return NULL;
        }
        // 3.3ã€è°ƒç”¨å‡½æ•°ï¼Œæ£€æŸ¥è¿™ä¸ªå›æ”¶çš„å—æ˜¯å¦å®‰å…¨ï¼ï¼ï¼
        check_remalloced_chunk(av, victim, nb);
				// 3.4ã€å¯¹åˆ†é…çš„å—çš„å†…å®¹è¿›è¡Œ&#x27;\0&#x27;åˆå§‹åŒ–ç„¶åè¿”å›ç»™ç”¨æˆ·
        void *p = chunk2mem(victim);       // è·å–åˆ†é…å—çš„æŒ‡é’ˆ
        alloc_perturb(p, bytes);           // å¯¹åˆ†é…çš„å—è¿›è¡Œåˆå§‹åŒ–ï¼Œé‡Œé¢å†…å®¹å…¨éƒ¨åˆå§‹åŒ–ä¸º&#x27;\0&#x27;
        return p;                          // è¿”å›åˆ†é…å—çš„æŒ‡é’ˆ
    }
	}

	/********************************************
		smallbinå›æ”¶éƒ¨åˆ†ï¼
	*********************************************/
	//4ã€è¿™æ˜¯smallchunkçš„ç”³è¯·ä»£ç 
	// æˆ‘ä»¬å¯ä»¥åœ¨unosortedbinéå†å‰å°±å…ˆå°è¯•å¥½smallbinï¼Œè¿™æ˜¯å› ä¸ºæ¯æ¡smallbinsé“¾è¡¨éƒ½å¯¹åº”äº†ä¸€ä¸ªå›ºå®šçš„å¤§å°ã€‚
  // (å¯¹äºä¸€ä¸ªå¤§å‹chunkç”³è¯·ï¼Œæˆ‘ä»¬éœ€è¦ç­‰åˆ°unsorted binsè¢«å¤„ç†å®Œæ‰èƒ½æ‰¾åˆ°æœ€ä½³åŒ¹é…ã€‚ä½†å¯¹äºå°å‹è¯·æ±‚ï¼ŒåŒ¹é…æ€»æ˜¯ç²¾ç¡®çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨å¯ä»¥æ£€æŸ¥ï¼Œè¿™æ›´å¿«ã€‚)
  // ç„¶ååé¢unsortedbinéå†æ—¶è¦æ˜¯é‡åˆ°åˆé€‚çš„smallå¤§å°çš„å—ä¼šç›´æ¥æ‹¿æ¥ç”¨ï¼Œå¦‚æœæ²¡é‡åˆ°åˆ™ä¹Ÿä¸éœ€è¦åç»­å†å°è¯•smallbinï¼Œæ‰€ä»¥ æˆ‘ä»¬è¿™é‡Œåç»­å°±ä¸ç”¨å†å°è¯•éå†smallbinäº†ï¼
	if (in_smallbin_range(nb)) {   //æ£€æŸ¥å½“å‰chunkçš„å¤§å°æ˜¯å¦å°äºlargebinçš„æœ€å°å¤§å°ï¼Œåˆ¤æ–­å…¶æ˜¯å¦ä¸ºä¸€ä¸ªsmallchunkç”³è¯·

    idx = smallbin_index(nb);    //è·å¾—å¯¹åº”çš„smallbiné“¾è¡¨ç´¢å¼•
    bin = bin_at(av, idx);       //è·å¾—å¯¹åº”çš„smallbiné“¾è¡¨ï¼Œå­˜ä¸ºå˜é‡bin

		// 4.1å°è¯•ä»binä¸­å–å‡ºä¸€ä¸ªå—
		// 4.1.1å¦‚æœå¾—åˆ°binï¼Œå°±è¡¨ç¤ºæ²¡æœ‰å—å¯ä»¥å–å‡ºï¼Œè·³å‡ºsmallbinå›æ”¶
    // å¦‚æœ bin ä¸­æœ‰å—å¯ç”¨ï¼Œä¹Ÿå°±æ˜¯å®ƒä¸åªæœ‰ä¸€ä¸ªç©ºçš„å¤´èŠ‚ç‚¹
    // åˆå§‹åŒ–çš„smallbinæ¯ä¸ªé“¾è¡¨ä¼šæœ‰ä¸€ä¸ªç©ºçš„å¤´èŠ‚ç‚¹ï¼Œç„¶åç¬¬ä¸€æ¬¡è°ƒç”¨mallocå»ç”³è¯·smallbinæ—¶æ‰ä¼šè®¾ç½®æ‰€æœ‰å¤´èŠ‚ç‚¹çš„bkåŸŸå¾€å›æŒ‡
    if ((victim = last(bin)) != bin) {    // binè¿™é‡Œæ˜¯bin[idx]ï¼Œæ‰€ä»¥è¿™é‡Œvictim=last(bin)æ˜¯å–å‡ºå¯¹åº”çš„é‚£æ¡smallbiné“¾è¡¨ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœä»–!=bin[idx],åˆ™è¦ä¹ˆè¡¨ç¤ºmalloc_stateé‡Œé¢çš„binåŸŸæ²¡æœ‰åˆå§‹åŒ–ï¼Œè¦ä¹ˆè¡¨ç¤ºæ˜¯å–åˆ°äº†é‚£ä¸ªå †å—

        // 4.1.2å¦‚æœå¾—åˆ°0ï¼Œå°±è¡¨ç¤ºbinæ•°ç»„å’Œmalloc_stateå°šæœªåˆå§‹åŒ–ï¼Œåˆ™è°ƒç”¨malloc_consolidateå‡½æ•°åˆå§‹åŒ–binæ•°ç»„å’Œmalloc_state
        if (victim == 0) 
            malloc_consolidate(av);   //è°ƒç”¨malloc_consolidateå‡½æ•°
        //4.2å¦‚æœæ˜¯å¾—åˆ°ä¸€ä¸ªæ­£å¸¸çš„victimå—ï¼Œåˆ™åšå¤„ç†åè¿”å›ç»™åˆ°ç”¨æˆ·---------------------------------------
        else {
            bck = victim-&gt;bk;            // è·å– victim å—çš„åç»§
            // 4.2.1å®‰å…¨æ£€æŸ¥ï¼šçœ‹victim-&gt;bk-&gt;fdæ˜¯å¦ç­‰äºvictim
            // è¿™æ˜¯ä¸ºäº†é˜²æ­¢é“¾è¡¨è¢«æ”»å‡»è€…ç ´å
            if (__glibc_unlikely(bck-&gt;fd != victim)) {
                errstr = &quot;malloc(): smallbin double linked list corrupted&quot;;
                goto errout;
            }
            // 4.2.2è®¾ç½®victimç‰©ç†ç›¸é‚»ä¸‹ä¸€ä¸ªchunkçš„prev_inuseä½
            set_inuse_bit_at_offset(victim, nb);    
            // 4.2.3å°† victim ä» bin é“¾è¡¨ä¸­ç§»é™¤
            bin-&gt;bk = bck;
            bck-&gt;fd = bin;
            // 4.2.4è®¾ç½® victim å—çš„ Næ ‡å¿—ä½
            if (av != &amp;main_arena)
                victim-&gt;size |= NON_MAIN_ARENA;
            // 4.2.5è°ƒç”¨check_malloced_chunkå‡½æ•°æ£€æŸ¥å·²åˆ†é…çš„å—
            check_malloced_chunk(av, victim, nb);
            // 4.2.6å¯¹åˆ†é…çš„å—åš&#x27;\0&#x27;çš„dataéƒ¨åˆ†åˆå§‹åŒ–ï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·
            void *p = chunk2mem(victim);  // è·å–åˆ†é…å—çš„æŒ‡é’ˆ
            alloc_perturb(p, bytes);      // å¯¹åˆ†é…çš„å—è¿›è¡Œåˆå§‹åŒ–
            return p;                     // è¿”å›åˆ†é…çš„å—æŒ‡é’ˆ
            // æ³¨æ„ï¼š
            // æ— éœ€è®¾ç½®victimçš„sizeåŸŸï¼Œè¿™æ˜¯å› ä¸ºsizeåŸŸçš„æ„ä¹‰æ˜¯ä¸ºäº†åœ¨unsorted binä¸­åšå›æ”¶&amp;åœ¨largebinä¸­åšæ’åº
            // å¦‚æœè¿™ä¸ªsmallchunkæ˜¯æ¥è‡ªç”¨æˆ·ç›´æ¥çš„freeï¼Œå°±æ— éœ€sizeã€‚å¦‚æœè¿™ä¸ªsmall
        }
    }
	}


	//5ã€åœ¨ç»§ç»­ä¹‹å‰å…ˆåˆå¹¶fastchunkï¼Œé¡ºä¾¿è®¡ç®—äº†ä¸€ä¸‹å¦‚æœè¦ç”³è¯·çš„å—æ˜¯largebinå¤§å°æ—¶å®ƒçš„idx
	//è™½ç„¶åœ¨ç”šè‡³è¿˜æœªæ£€æŸ¥largechunkæ˜¯å¦æœ‰å¯ç”¨chunkä¹‹å‰å°±æ¸…ç©ºæ‰€æœ‰å¿«é€Ÿåˆ†é…å—å¯èƒ½çœ‹èµ·æ¥æœ‰äº›è¿‡åº¦ï¼Œä½†è¿™æ ·å¯ä»¥é¿å…é€šå¸¸ä¸å¿«é€Ÿåˆ†é…å—ç›¸å…³çš„ç¢ç‰‡åŒ–é—®é¢˜ã€‚
	//æ­¤å¤–ï¼Œåœ¨å®è·µä¸­ï¼Œç¨‹åºé€šå¸¸æœ‰ä¸€ç³»åˆ—å°å‹æˆ–å¤§å‹è¯·æ±‚ï¼Œä½†è¾ƒå°‘æ··åˆæƒ…å†µï¼Œå› æ­¤åœ¨å¤§å¤šæ•°ç¨‹åºä¸­å¹¶ä¸ç»å¸¸è°ƒç”¨åˆå¹¶æ“ä½œã€‚è€Œé‚£äº›é¢‘ç¹è°ƒç”¨åˆå¹¶æ“ä½œçš„ç¨‹åºé€šå¸¸ä¹Ÿå®¹æ˜“ç¢ç‰‡åŒ–ã€‚
	else{
	  idx = largebin_index (nb);   // è®¡ç®—å¯¹åº”å¤§å—çš„ç´¢å¼•
	  // å¦‚æœæœ‰fastchunkï¼Œåˆ™è°ƒç”¨malloc_consolidateå¯¹æ‰€æœ‰fastchunkè¿›è¡Œåˆå¹¶æ“ä½œ
	  if (have_fastchunks (av))
	    malloc_consolidate (av);
	}

	/********************************************
		éå†unsorted binéƒ¨åˆ†ï¼
	*********************************************/
  for (;; ){      //ä¹‹æ‰€ä»¥ä¼šæœ‰è¿™ä¸ªå¤–å¾ªç¯ï¼Œæ˜¯å› ä¸ºwhileå¾ªç¯è¿™é‡Œå¯èƒ½ä¼šåˆ‡å‰²å¤§å—çš„chunkè€Œå¯¼è‡´æœ‰æ–°çš„å‰©ä½™chunkåŠ å…¥unsorted bin
      int iters = 0;
      
      // 6ã€éå†unsorted binå¤„ç†å®ƒé‡Œé¢çš„æ‰€æœ‰unsortedchunk-------------------------------------------
      while ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av)){     // victimè¢«è®¾ç½®æŒ‡å‘é‚£ä¸ªunsorted chunkï¼
          bck = victim-&gt;bk;    //
          
          // 6.1å®‰å…¨æ£€æŸ¥ï¼švictim-&gt;sizeå–å€¼å¿…é¡»åœ¨ä¸¤å€SIZE_SZå’Œav-&gt;system_memä¹‹é—´
          if (__builtin_expect (victim-&gt;size &lt;= 2 * SIZE_SZ, 0)|| __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, 0))
              malloc_printerr (check_action, &quot;malloc(): memory corruption&quot;,chunk2mem (victim), av);
          size = chunksize (victim);

					/********************************************
						å°è¯•ä½¿ç”¨å”¯ä¸€ä¸€ä¸ªå‰©ä½™å—
					*********************************************/
          // 6.2ã€å°è¯•ä½¿ç”¨å”¯ä¸€ä¸€ä¸ªå‰©ä½™å—---------------------------------------------------------------------------------------------
	        // å¦‚æœå–å‡ºçš„ç¬¬ä¸€ä¸ªunsortedchunkåŒæ—¶æ»¡è¶³ï¼šï¼ˆ1ï¼‰æ˜¯ä¸€ä¸ªsallbinèŒƒå›´çš„è¯·æ±‚ï¼ˆ2ï¼‰å½“å‰unsorted chunkæ˜¯unsorted bin ä¸­å”¯ä¸€çš„å—ï¼ˆ3ï¼‰å½“å‰unsorted chunkçš„å¤§å°&gt;&quot;è¯·æ±‚å¤§å°+MINSIZE&quot;ï¼ˆ4ï¼‰å®ƒæ˜¯ä¸Šæ¬¡çš„å‰©ä½™å—ï¼ˆav-&gt;last_remainderï¼‰
	        // åˆ™å°è¯•ä½¿ç”¨ä¹‹ï¼ˆåˆ‡å‰²æˆåˆé€‚å¤§å°ï¼Œå¹¶ä¸”æŠŠå‰²å‡ºæ¥çš„å‰©ä½™chunkè¿å›unsorted binï¼‰ã€‚
          // æ„ä¹‰ï¼šè¿™æœ‰åŠ©äºæé«˜è¿ç»­å°è¯·æ±‚çš„å±€éƒ¨æ€§ã€‚è¿™æ˜¯æœ€ä½³é€‚é…çš„å”¯ä¸€ä¾‹å¤–ï¼Œä»…é€‚ç”¨äºæ²¡æœ‰ç²¾ç¡®åŒ¹é…çš„å°å—ã€‚
          if (in_smallbin_range (nb) &amp;&amp;                       // å¦‚æœnbæ˜¯å°è¯·æ±‚çš„èŒƒå›´
              bck == unsorted_chunks (av) &amp;&amp;                  // å¦‚æœå½“å‰unsorted chunkæ˜¯unsorted bin ä¸­å”¯ä¸€çš„å—
              victim == av-&gt;last_remainder &amp;&amp;                 // å¦‚æœå½“å‰unsorted chunkæ˜¯ä¸Šæ¬¡çš„å‰©ä½™å—
              (unsigned long) (size) &gt; (unsigned long) (nb + MINSIZE)) // å¦‚æœå½“å‰unsorted chunkçš„å¤§å°å¤§äºè¯·æ±‚å¤§å°åŠ ä¸Šæœ€å°å—å¤§å°
            {
              // 6.2.1åˆ†å‰²è¿™ä¸ªunsorted chunkï¼Œå¹¶ä¸”æŠŠå‰²å‡ºæ¥çš„å‰©ä½™chunkè¿å›unsorted bin
              remainder_size = size - nb;                      // è®¡ç®—å‰©ä½™å—çš„å¤§å°
              remainder = chunk_at_offset (victim, nb);        // è·å–å‰©ä½™å—çš„åœ°å€
              unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;  // é‡æ–°è¿æ¥å‰©ä½™å—åˆ°æœªæ’åº bin ä¸­
              av-&gt;last_remainder = remainder;                  // æ›´æ–°æœ€åä¸€ä¸ªå‰©ä½™å—
              remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av); // è®¾ç½®å‰©ä½™å—çš„å‰é©±å’Œåç»§æŒ‡é’ˆä¸ºæœªæ’åº bin
              if (!in_smallbin_range (remainder_size))         // å¦‚æœè¿å›unsorted binçš„å‰©ä½™chunkè¿˜æ˜¯large chunkå¤§å°ï¼Œåˆ™å°†å…¶fd_nextsizeã€bk_nextsizeåŸŸåˆå§‹åŒ–ä¸º0
                 {
                  remainder-&gt;fd_nextsize = NULL;
                  remainder-&gt;bk_nextsize = NULL;
	               }
              // 6.2.2è®¾ç½®å½“å‰å—ã€å‰©ä½™å—çš„å¤´éƒ¨ç›¸å…³ä¿¡æ¯
              // 6.2.2.1è®¾ç½®å½“å‰å—çš„ç›¸å…³ä¿¡æ¯ï¼Œè®¾ç½®sizeã€æ ‡è®°prev_inuseï¼ˆå› ä¸ºå‰ååˆå¹¶æœºåˆ¶ï¼‰ã€å¦‚æœä¸æ˜¯ä¸»åˆ†é…åŒºåˆ™æ ‡è®°NON_MAIN_ARENA
							// è¿™é‡Œä¼šæ— è„‘è®¾ç½®prev_inuseï¼Œè¿™æˆ–è®¸ä¼šæˆä¸ºä¸€ä¸ªæ¼æ´åˆ©ç”¨ç‚¹
              set_head (victim, nb | PREV_INUSE |(av != &amp;main_arena ? NON_MAIN_ARENA : 0));
              // 6.2.2.2è®¾ç½®å‰©ä½™å—çš„å¤´éƒ¨å’Œè„šéƒ¨ä¿¡æ¯ï¼Œæ ‡è®°prev_inuseï¼Œä¸”æ ‡è®°ä¸‹ä¸€ä¸ªchunkçš„prev_size
              set_head (remainder, remainder_size | PREV_INUSE); //è¿™é‡Œæ˜¯è®¾ç½®å‰©ä½™å—çš„sizeå­—æ®µï¼ŒåŒ…æ‹¬è®¾ç½®äº†prev_inuseæ ‡å¿—ä½
              set_foot (remainder, remainder_size);              //è¿™é‡Œæ˜¯è®¾ç½®ä¸‹ä¸€ä¸ªchunkçš„prev_sizeå­—æ®µ
              // 6.2.3è°ƒç”¨check_malloced_chunkè¿›è¡Œå®‰å…¨æ£€æŸ¥
              check_malloced_chunk (av, victim, nb);
              // 6.2.4å¯¹åˆ†é…çš„å—åš&#x27;\0&#x27;çš„dataéƒ¨åˆ†åˆå§‹åŒ–ï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·ç¨‹åº
              void *p = chunk2mem (victim);      // å°†å—è½¬æ¢ä¸ºåˆ†é…çš„å†…å­˜åŒºåŸŸ
              alloc_perturb (p, bytes);           // æ‰°åŠ¨åˆ†é…çš„å†…å­˜åŒºåŸŸ
              return p;                           // è¿”å›åˆ†é…çš„å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆ
            }

          // 6.3æŠŠvictimä»unsorted binä¸­unlinkèµ°
          unsorted_chunks (av)-&gt;bk = bck;
          bck-&gt;fd = unsorted_chunks (av);

					/********************************************
						å¦‚æœæ°å¥½å¤§å°åŒ¹é…ï¼Œåˆ™ç«‹å³è·å–
					*********************************************/
					//6.3å¤§å°åˆé€‚çš„è¯ç«‹å³è·å–---------------------------------------------------------------------------------------------
          //å¦‚æœæ°å¥½å¤§å°åŒ¹é…ï¼Œåˆ™ç«‹å³è·å–ï¼Œè€Œä¸æ˜¯æ”¾å…¥ bin ä¸­å†å»binä¸­è·å–
          if (size == nb)                           // å¦‚æœå—çš„å¤§å°æ°å¥½ç­‰äºè¯·æ±‚çš„å¤§å°
            {
		          // 6.3.1è®¾ç½®å½“å‰çš„å¤´éƒ¨ç›¸å…³ä¿¡æ¯
              set_inuse_bit_at_offset (victim, size); // è®¾ç½®å—ä¸ºå·²ä½¿ç”¨çŠ¶æ€ï¼ˆé€šè¿‡è®¾ç½®ä¸‹ä¸€ä¸ªå—çš„prev_inuseä½ï¼‰
              if (av != &amp;main_arena)                  // å¦‚æœä¸æ˜¯ä¸»åˆ†é…åŒºï¼Œåˆ™è®¾ç½®å—ä¸ºéä¸»åˆ†é…åŒº
                victim-&gt;size |= NON_MAIN_ARENA;
              // 6.3.2è°ƒç”¨check_malloced_chunkè¿›è¡Œå®‰å…¨æ£€æŸ¥
              check_malloced_chunk (av, victim, nb);
              // 6.3.3å¯¹åˆ†é…çš„å—åš&#x27;\0&#x27;çš„dataéƒ¨åˆ†åˆå§‹åŒ–ï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·ç¨‹åº
              void *p = chunk2mem (victim);          // å°†å—è½¬æ¢ä¸ºåˆ†é…çš„å†…å­˜åŒºåŸŸ
              alloc_perturb (p, bytes);              // æŠŠdataéƒ¨åˆ†å…¨éƒ¨è®¾ç½®æˆ&#x27;\0&#x27;
              return p;                              // è¿”å›åˆ†é…çš„å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆ
            }

          /********************************************
						å‡†å¤‡å°†å—æ”¾å…¥å¯¹åº”çš„smallbin&amp;largebinä¸­
					*********************************************/
					//6.4å°†å—æ”¾å…¥å¯¹åº”çš„smallbin&amp;largebinä¸­--------------------------------------------------------------------------
					//6.4.1è·å–å…¶â€œè¦æ’å…¥çš„ä½ç½®â€ï¼Œä»¥å‡†å¤‡å°†å—æ”¾å…¥smallbins&amp;largebiné‡Œ
					//6.4.1.1å¦‚æœå—å¤§å°åœ¨small bin èŒƒå›´å†…ï¼Œè·å–å…¶â€œè¦æ’å…¥çš„ä½ç½®â€
					if (in_smallbin_range (size))
					 {
              victim_index = smallbin_index (size);      // è®¡ç®—å°å‹ bin çš„ç´¢å¼•
              bck = bin_at (av, victim_index);           // å¯¹åº”çš„bins[idx]è¿™ä¸ªå…ƒç´ çš„åœ°å€ï¼Œå­˜æ”¾åœ¨bck
              fwd = bck-&gt;fd;                             // fwdé‡Œé¢å­˜æ”¾ç€bins[idx]-&gt;fdä¹Ÿå°±æ˜¯é“¾è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„åœ°å€
            }
          //6.4.1.2å¦‚æœå—å¤§å°åœ¨large bin èŒƒå›´å†…ï¼Œè·å–å…¶â€œè¦æ’å…¥çš„ä½ç½®â€
          else
           {
              victim_index = largebin_index (size);      // è®¡ç®—å¤§å‹ bin çš„ç´¢å¼•
              bck = bin_at (av, victim_index);           // bckè¢«åˆå§‹åŒ–ä¸ºå¯¹åº”çš„bins[idx]è¿™ä¸ªå…ƒç´ çš„åœ°å€
              fwd = bck-&gt;fd;                             // fwdè¢«åˆå§‹åŒ–ä¸ºé“¾è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„åœ°å€

              // è¿™ä¸€æ®µå°±æ˜¯æ¯”è¾ƒå½“å‰è¦å›æ”¶çš„unsorted chunkå¤§å°ï¼Œæ‰¾åˆ°åˆé€‚çš„æ’å…¥ä½ç½®ï¼Œå› ä¸ºlarge biné“¾è¡¨è¦æ±‚ä»å°åˆ°å¤§æœ‰åºæ’åˆ—
              if (fwd != bck)
                {
                  // å°†sizeå˜é‡çš„Pæ ‡å¿—ä½è®¾ç½®ä¸º1ï¼Œè¿™æ˜¯ä¸ºäº†åé¢æ¯”è¾ƒæ“ä½œæ—¶ç®€åŒ–ä¸€äº›æ­¥éª¤
                  size |= PREV_INUSE;
                  /* å¦‚æœæ¯”æœ€å°å—è¿˜å°ï¼Œè·³è¿‡ä¸‹é¢çš„å¾ªç¯ */
                  assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == 0);
                  if ((unsigned long) (size) &lt; (unsigned long) (bck-&gt;bk-&gt;size))
                    {
                      fwd = bck;
                      bck = bck-&gt;bk;

                      victim-&gt;fd_nextsize = fwd-&gt;fd;
                      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;
                      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;
                    }
                  else
                    {
                      assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == 0);
                      while ((unsigned long) size &lt; fwd-&gt;size)
                        {
                          fwd = fwd-&gt;fd_nextsize;
                          assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == 0);
                        }

                      if ((unsigned long) size == (unsigned long) fwd-&gt;size)
                        // å§‹ç»ˆæ’å…¥åœ¨ç¬¬äºŒä¸ªä½ç½®
                        fwd = fwd-&gt;fd;
                      else
                        {
                          victim-&gt;fd_nextsize = fwd;
                          victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;
                          fwd-&gt;bk_nextsize = victim;
                          victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;
                         }
                      bck = fwd-&gt;bk;
                    }
                }
              else
	                victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;
            }

					//6.4.2æ ¹æ®åˆšåˆšè·å–çš„â€œè¦æ’å…¥çš„ä½ç½®â€ï¼Œè¿›è¡Œæ’å…¥
          mark_bin (av, victim_index);                    // æ ‡è®°å¯¹åº” bin çš„ä½¿ç”¨
          victim-&gt;bk = bck;                               // è®¾ç½®åç»§æŒ‡é’ˆ
          victim-&gt;fd = fwd;                               // è®¾ç½®å‰è¿›æŒ‡é’ˆ
          fwd-&gt;bk = victim;                               // è®¾ç½®å‰è¿›æŒ‡é’ˆçš„åç»§æŒ‡é’ˆ
          bck-&gt;fd = victim;                               // è®¾ç½®åç»§æŒ‡é’ˆçš„å‰è¿›æŒ‡é’ˆ

#define MAX_ITERS       10000
          // å¦‚æœè¿­ä»£æ¬¡æ•°è¶…è¿‡æœ€å¤§å€¼ï¼Œè·³å‡ºwhileéå†unsorted binçš„å¾ªç¯ï¼Œä»¥æ­¤é˜²æ­¢æ­»å¾ªç¯~
          if (++iters &gt;= MAX_ITERS)
              break;
		  }//è‡³æ­¤ï¼Œwhileéå†unsorted binçš„å¾ªç¯ç»“æŸï¼


      /********************************************
		    å°è¯•ä»å¯¹åº”å¤§å°åŒºé—´çš„é‚£æ¡large biné‡Œå–å‡ºchunkéƒ¨åˆ†ï¼
	    *********************************************/
			// 7ã€è¿™é‡Œå°è¯•ä»æ‰€ç”³è¯·chunkå¯¹åº”çš„å¤§å°åŒºé—´çš„é‚£æ¡largebiné‡Œé¢æ‰¾åˆé€‚çš„chunk----------------------------------------------------------------
			// è¿™é‡Œå¦‚æœåˆ°è¿™ä¸€æ­¥ç„¶åè¦ç”³è¯·çš„æ˜¯smallèŒƒå›´çš„chunkè¿˜æ²¡ç”³è¯·åˆ°ï¼Œé‚£æˆ‘ä»¬å°±ä¼šç›´æ¥åœ¨åé¢å»åˆ‡å‰²topchunkäº†
      if (!in_smallbin_range (nb))
        {                        
          bin = bin_at (av, idx);                          // è¿™ä½¿binå˜é‡ä¸­å­˜æ”¾äº†bin[idx]è¿™ä¸ªå…ƒç´ çš„åœ°å€

          //7.1å¦‚æœä¸èƒ½åŒæ—¶ç¬¦åˆä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼Œå°±è¯æ˜â€œå¯¹åº”å¤§å°åŒºé—´çš„é‚£æ¡large biné‡Œæ²¡æ³•å–å‡ºæˆ‘ä»¬è¦çš„chunkâ€ï¼Œå°±ä¸å¿…èµ°ifåé¢çš„éƒ¨åˆ†ï¼š
          //ï¼ˆ1ï¼‰å¯¹åº”å¤§å°åŒºé—´çš„é‚£æ¡large biné“¾è¡¨ä¸ä¸ºç©º   ï¼ˆ2ï¼‰é‚£æ¡largebiné‡Œé¢çš„æœ€å¤§å—è¶³å¤Ÿå¤§      
          if ((victim = first (bin)) != bin &amp;&amp;             //  å¯¹åº”å¤§å°åŒºé—´çš„é‚£æ¡large biné“¾è¡¨ä¸ä¸ºç©ºï¼Œå³â€œbin[idx]æŒ‡å‘çš„æ˜¯ä¸€æ¡éç©ºlargebiné“¾è¡¨â€
              (unsigned long) (victim-&gt;size) &gt;= (unsigned long) (nb)) // è¿™æ¡éç©ºlargebiné“¾è¡¨é‡Œé¢çš„æœ€å¤§é‚£ä¸ªå—è¶³å¤Ÿå¤§ï¼ˆå³&gt;=nbï¼‰
           {
              // 7.2å¾ªç¯ç›´åˆ°æ‰¾åˆ°åˆé€‚å¤§å°çš„å—
              victim = victim-&gt;bk_nextsize;                // è·å–ä¸‹ä¸€ä¸ªæ›´å¤§çš„å—ï¼ˆæ³¨æ„å¦‚æœbké“¾æ˜¯a:1-b:2-c:2ï¼Œåˆ™bk_nextchunké“¾æ˜¯a:1-c:2ï¼‰
              while (((unsigned long) (size = chunksize (victim)) &lt;(unsigned long) (nb))) // å¾ªç¯ç›´åˆ°æ‰¾åˆ°åˆé€‚å¤§å°çš„å—ï¼Œå¾ªç¯ç»“æŸæ—¶ï¼Œå°†æœ‰victimçš„size&gt;=nb
                  victim = victim-&gt;bk_nextsize;
              // 7.3è¿™æ˜¯åœ¨å¤šä¸ªlargechunkå¤§å°ç›¸åŒæ—¶ï¼Œä¸popå‡ºå¤§å°ç›¸åŒçš„æœ€åä¸€ä¸ªï¼ˆbk_nextchunkæŒ‡å‘çš„é‚£ä¸ªï¼‰ï¼Œä»¥é¿å…å¿…é¡»é‡æ–°æ›´æ–°è·³é“¾ï¼ˆbk_nextchunké“¾ï¼‰ï¼ŒèŠ‚çº¦æ—¶é—´å¼€æ”¯
              // ç¤ºä¾‹ï¼šå¦‚æœbké“¾æ˜¯a:1-b:2-c:2-d:2ï¼Œå¯¹åº”çš„bk_nextchunké“¾å°±æ˜¯a:1-d:2ã€‚å‰é¢whileå¾ªç¯æ‰¾åˆ°çš„åˆé€‚çš„å—æ˜¯dï¼Œå¦‚æœç›´æ¥å–å‡ºdå°±éœ€è¦æŠŠbk_nextchunké“¾æ›´æ–°ä¸ºa-cï¼Œè¿™æ ·æ—¶é—´å¼€æ”¯è¾ƒå¤§ï¼Œä¸å¦‚æ”¹æˆç›´æ¥å–å‡ºcç„¶åä¸æ›´æ–°bk_nextchunké“¾ã€‚
              if (victim != last (bin) &amp;&amp; victim-&gt;size == victim-&gt;fd-&gt;size)
                  victim = victim-&gt;fd;
							// 7.4unlink
              remainder_size = size - nb;                  // è®¡ç®—å‰©ä½™å—çš„å¤§å°
              unlink (av, victim, bck, fwd);               // å°†æ‰¾åˆ°çš„å—ä»é“¾è¡¨ä¸­ç§»é™¤
              // 7.5å¯¹äºå‰©ä½™å—çš„å¤„ç†ï¼Œä»¥åŠè®¾ç½®ä¸€äº›æ ‡å¿—ä½
              // 7.5.1å¦‚æœåˆ‡å‰²åå‰©ä½™å—å¤§å°&lt;æœ€å°å—å¤§å°ï¼Œåˆ™ä¸åˆ‡å‰²ï¼Œå¹¶ç®€å•è®¾ç½®victimçš„ç›¸å…³æ ‡å¿—ä½ï¼ˆï¼‰
              if (remainder_size &lt; MINSIZE)               // å¦‚æœå‰©ä½™å—å¤§å°å°äºæœ€å°å—å¤§å°
               {
                  set_inuse_bit_at_offset (victim, size); // è®¾ç½®å—Pæ ‡å¿—ä½ä¸ºâ€œå·²ä½¿ç”¨çŠ¶æ€â€
                  if (av != &amp;main_arena)
                      victim-&gt;size |= NON_MAIN_ARENA;     // å¦‚æœä¸æ˜¯ä¸»åˆ†é…åŒºï¼Œåˆ™è®¾ç½®å—æ ‡å¿—ä½ä¸ºâ€œéä¸»åˆ†é…åŒºâ€
               }
              // 7.5.2å¦‚æœåˆ‡å‰²åå‰©ä½™å—å¤§å°&gt;=æœ€å°å—å¤§å°ï¼Œå‰©ä½™å—ç»™ä»–æ”¾è¿›unsortedbiné‡Œ
              else
               {
                  remainder = chunk_at_offset (victim, nb); // è·å–å‰©ä½™å—çš„åœ°å€
                  /* æˆ‘ä»¬ä¸èƒ½å‡è®¾æœªæ’åºåˆ—è¡¨ä¸ºç©ºï¼Œå› æ­¤å¿…é¡»åœ¨è¿™é‡Œæ‰§è¡Œå®Œå…¨æ’å…¥ã€‚ */
                  // 7.5.2.1å°†åˆ‡å‰²åå‰©ä½™å—linkå…¥unsortedinçš„å¼€å¤´
                  // 7.5.2.1.1è·å–bckå’Œfwd
                  bck = unsorted_chunks (av);              // è·å–unsorted bin çš„æŒ‡é’ˆ
                  fwd = bck-&gt;fd;                           // è·å–å‰å‘æŒ‡é’ˆ
								  if (__glibc_unlikely (fwd-&gt;bk != bck)){
                      errstr = &quot;malloc(): corrupted unsorted chunks&quot;;
                      goto errout;
                  }
                  // 7.5.2.1.2å°†åˆ‡å‰²åå‰©ä½™å—remainderæ’å…¥bckå’Œfwdä¹‹é—´
                  remainder-&gt;bk = bck;                    
                  remainder-&gt;fd = fwd;
                  bck-&gt;fd = remainder;
                  fwd-&gt;bk = remainder;
                  // 7.5.2.2å¦‚æœå‰©ä½™å—å¤§å°åœ¨largebinèŒƒå›´å†…ï¼Œå¯¹å®ƒçš„fd_next_chunkå’Œbk_next_chunkåŸŸè¿›è¡Œåˆå§‹åŒ–
                  if (!in_smallbin_range (remainder_size)){  // å¦‚æœå‰©ä½™å—å¤§å°åœ¨largebinèŒƒå›´å†…ï¼Œå¯¹fd_next_chunkå’Œbk_next_chunkè¿›è¡Œåˆå§‹åŒ–
                      remainder-&gt;fd_nextsize = NULL; 
                      remainder-&gt;bk_nextsize = NULL;
                  }
                  // 7.5.2.3è®¾ç½®ç›¸å…³ä¿¡æ¯æ•°æ®ï¼š
                  // victimçš„sizeå­—æ®µï¼ŒNæ ‡å¿—ä½ã€Pæ ‡å¿—ä½=1
                  // remainderçš„sizeå­—æ®µã€Pæ ‡å¿—ä½=1ã€footå­—æ®µ=size
                  set_head (victim, nb | PREV_INUSE |        // è®¾ç½®å½“å‰å—çš„å¤´éƒ¨å’Œè„šéƒ¨ä¿¡æ¯
                            (av != &amp;main_arena ? NON_MAIN_ARENA : 0));
                  set_head (remainder, remainder_size | PREV_INUSE);
                  set_foot (remainder, remainder_size);
               }
              
              // 7.6è°ƒç”¨check_malloced_chunkå‡½æ•°æ£€æŸ¥åˆ†é…çš„å—æ˜¯å¦æ­£ç¡®
              check_malloced_chunk (av, victim, nb);
              // 7.7å¯¹åˆ†é…çš„å—åš&#x27;\0&#x27;çš„dataéƒ¨åˆ†åˆå§‹åŒ–ï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·ç¨‹åº
              void *p = chunk2mem (victim);               // å°†å—è½¬æ¢ä¸ºåˆ†é…çš„å†…å­˜åŒºåŸŸ
              alloc_perturb (p, bytes);                    // æ‰°åŠ¨åˆ†é…çš„å†…å­˜åŒºåŸŸ
              return p;                                    // è¿”å›åˆ†é…çš„å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆ
           }
        }
	
      /********************************************
		    éå†å…¶ä»–æ¡ä½äºæ›´å¤§çš„å¤§å°åŒºé—´çš„large binéƒ¨åˆ†ï¼
	    *********************************************/
			// 8ã€éå†å…¶ä»–æ¡large bin-----------------------------------------------------------
			// è¿™é‡Œå®ƒä¸ä¼šåªå°è¯•å›æ”¶å’Œå½“å‰è¦å›æ”¶å¤§å°ç›¸åŒçš„biné“¾ä¸Šçš„largechunkï¼Œè€Œæ˜¯ä¼šå»å°è¯•å›æ”¶æ¯”ä»–å¤§çš„biné“¾ä¸Šçš„largechunk
			// å¹¶ä¸”è¿™é‡Œä¼šä½¿ç”¨ä¸€ä¸ªâ€œä½å›¾â€æœºåˆ¶(binmapçš„è®¾è®¡æ„ä¹‰å°±æ˜¯è®°å½•å¯¹åº”çš„binæ˜¯å¦ä¸ºç©ºï¼Œå½“åœ¨ malloc ä¸­éå†æœŸé—´å‘ç°å®ƒä»¬ä¸ºç©ºæ—¶å°±ä¼šè®¾ç½®binmapçš„å¯¹åº”ä½) 
      
      // 8.1ã€ä¸€äº›å‰ç½®å¤„ç†
      // 8.1.1ã€è·å–ä¸‹ä¸€ä¸ªå¤§å°çš„largebinçš„bin[idx]å…ƒç´ ï¼Œå­˜æ”¾åœ¨binå˜é‡
      ++idx;                                               // idxç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª bin
      bin = bin_at (av, idx);                              // è·å–å¯¹åº” bin çš„æŒ‡é’ˆï¼ˆæŒ‡å‘bin[idx]è¿™ä¸ªå…ƒç´ ï¼‰
      // 8.1.2ã€è·å–ä¸‹ä¸€ä¸ªå¤§å°çš„largebinçš„ä½å›¾å¯¹åº”çš„é‚£ä¸ªunsigned intï¼Œå­˜æ”¾åœ¨mapå˜é‡ã€‚bitå˜é‡åˆ™æ˜¯ä¸€ä¸ªå®šä½æ ‡ï¼Œå…¶ä¸­32ä½é‡Œé¢idxå¯¹åº”çš„é‚£ä¸€ä½ä¸º1ï¼Œå…¶ä½™ä½ä¸º0.
      block = idx2block (idx);                             // è®¡ç®—ç´¢å¼• idx å¯¹åº”åœ¨ä½å›¾ï¼ˆbitmapï¼‰ä¸­çš„å—ï¼ˆblockï¼‰ä½ç½®
      map = av-&gt;binmap[block];                             // è·å– binmap ä¸­largebinå¯¹åº”çš„é‚£å¼ ä½å›¾
      bit = idx2bit (idx);                                 // è®¡ç®—é‚£å¼ ä½å›¾é‡Œidxå¯¹åº”çš„binçš„ä½ç½®ï¼Œå­˜ä¸ºbit

			// 8.2ã€å¾ªç¯è¿›è¡Œä»¥ä¸‹æ“ä½œï¼š
      for (;; )
        {
	        // 8.2.1ã€å…ˆå·§å¦™åœ°ç²—åˆ¤æ–­å½“å‰blockï¼ˆå³ä¸€ä¸ªunsigned intï¼‰é‡Œé¢æ˜¯å¦è¿˜æœ‰å¯ç”¨çš„â€œ1â€ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç›´æ¥è·³è¿‡è¿™ä¸ªblockçš„å‰©ä½™éƒ¨åˆ†ï¼Œæ¥åˆ°ä¸‹ä¸€ä¸ªblockã€ä¸‹ä¸‹ä¸ªblock....ç›´åˆ°æœ‰ä¸€ä¸ªéç©ºblockéç©ºæˆ–è€…æ‰€æœ‰blockéƒ½ä¸è¡Œå°±ç›´æ¥å»åˆ‡å‰²topchunkã€‚
	        // bit &gt; mapçš„å«ä¹‰ï¼šå› ä¸ºåœ¨binmapé‡Œé¢ï¼Œè¶Šå¤§çš„largebiné“¾å¯¹åº”çš„æ˜¯å€¼è¶Šé«˜çš„äºŒè¿›åˆ¶ä½ï¼Œæ‰€ä»¥å¦‚æœåˆšè¿›å…¥è¿™ä¸ªforæ—¶ï¼Œå°±å·²ç»bit &gt; mapäº†ï¼Œé‚£å°±è¯æ˜å½“å‰blockåœ¨æ¯”å½“å‰bitçš„é‚£ä¸ªä½å€¼æ›´é«˜çš„æ‰€æœ‰ä½ä¸Šéƒ½ä¸å­˜åœ¨â€œ1â€ï¼Œé‚£å°±ä¸ç”¨åœ¨ç°åœ¨è¿™ä¸ªblocké‡Œé¢çº ç¼ äº†
          // bit==0çš„å«ä¹‰ï¼šå› ä¸ºæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸ªblocké‡Œé¢æ˜¯å¦æœ‰å¯ç”¨çš„â€œ1â€ï¼Œæ˜¯é€šè¿‡ä¸åœæŠŠbitå³ç§»æ¥å®ç°çš„ï¼Œå¦‚æœä¸€ç›´å³ç§»åˆ°bit==0è¿˜æ²¡æœ‰åŒ¹é…åˆ°â€œ1â€ï¼Œé‚£å°±è¯´æ˜å½“å‰blocké‡Œé¢æ²¡æœ‰å¯ç”¨çš„&quot;1&quot;äº†
          if (bit &gt; map || bit == 0)         /* è¿™é‡Œæ˜¯ä¸€ä¸ªâ€œæˆ–â€é€»è¾‘ */
            {
              do
                {
                  if (++block &gt;= BINMAPSIZE) /* è¶…å‡ºäº† bin çš„èŒƒå›´ */
                    goto use_top;
                }
              while ((map = av-&gt;binmap[block]) == 0);

              bin = bin_at (av, (block &lt;&lt; BINMAPSHIFT));     // æ›´æ–° bin æŒ‡é’ˆ
              bit = 1;                                        // é‡ç½® bit
            }

          // 8.2.2ã€ä»ä½åˆ°é«˜åœ°æ£€æŸ¥å½“å‰blockä¸­çš„æ¯ä¸€ä½ï¼ˆå…±32ä½ï¼‰ï¼Œç›´åˆ°å…¶ä¸­æœ‰ä¸€ä½ä¸º1æ—¶é€€å‡ºå¾ªç¯ï¼Œæ­¤æ—¶çš„binå°±æŒ‡å‘äº†é‚£æ¡é“¾è¡¨çš„bin[idx]
          while ((bit &amp; map) == 0)
            {
              bin = next_bin (bin);                           // è·å–ä¸‹ä¸€ä¸ª bin çš„æŒ‡é’ˆ
              bit &lt;&lt;= 1;                                      // ç§»åŠ¨ bit é‡Œé¢çš„é‚£ä¸ª1çš„ä½ç½®ï¼Œè¶Šå¾€å·¦ç§»
              assert (bit != 0);
            }

          victim = last (bin);                                // è·å– bin ä¸­æœ€åä¸€ä¸ªå—

					// 8.2.3 å› ä¸ºä½è¡¨ä¹Ÿå¯èƒ½ä¼šäº§ç”Ÿè¯¯æŠ¥ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ä»å¯¹åº”biné‡Œé¢çœ‹èƒ½å¦æˆåŠŸå–å‡ºvictimï¼Œå¦‚æœå–ä¸å‡ºï¼Œå°±æ˜¯è¯¯æŠ¥ï¼Œåˆ™æ›´æ–°ä½è¡¨å¹¶ç§»åŠ¨bit
          /* å¦‚æœæ˜¯è¯¯æŠ¥ï¼ˆç©º binï¼‰ï¼Œåˆ™æ¸…é™¤ä½ã€‚ */
          if (victim == bin)
            {
              av-&gt;binmap[block] = map &amp;= ~bit; /* é€è¿‡å†™ */    // æ¸…é™¤å¯¹åº”ä½çš„å€¼
              bin = next_bin (bin);                           // è·å–ä¸‹ä¸€ä¸ª bin çš„æŒ‡é’ˆ
              bit &lt;&lt;= 1;                                      // ç§»åŠ¨ bit ä½
            }
          else
            {
	            // 8.2.4 é’ˆå¯¹æ‰€å–å‡ºçš„å—çš„å¤§å°çš„å®‰å…¨æ£€æŸ¥:æ–­è¨€victimå—å¤§å°&gt;=è¯·æ±‚å¤§å°
              size = chunksize (victim);                      // è·å–å—çš„å¤§å°
              assert ((unsigned long) (size) &gt;= (unsigned long) (nb)); // æ–­è¨€victimå—å¤§å°&gt;=è¯·æ±‚å¤§å°

              remainder_size = size - nb;                      // è®¡ç®—å‰©ä½™å—çš„å¤§å°
              // 8.2.5 å°†victimä»largebinä¸­ç»™unlinkå‡ºæ¥
              unlink (av, victim, bck, fwd);                  // å°†å—ä»é“¾è¡¨ä¸­ç§»é™¤
              // 8.2.6 å¦‚æœå‰©ä½™å—å°äºæœ€å°å—å¤§å°ï¼Œä¸åˆ‡å‰²ï¼Œå¹¶è®¾ç½®victimç›¸å…³æ ‡å¿—ä½ï¼ˆè®¾ç½®victimçš„Næ ‡å¿—ä½ã€victinç‰©ç†ç›¸é‚»ä¸‹ä¸€ä¸ªchunkçš„Pæ ‡å¿—ä½ä¸º1ï¼‰
              if (remainder_size &lt; MINSIZE)                   // å¦‚æœå‰©ä½™å—å¤§å°&lt;â€œæœ€å°å—å¤§å°â€
                {                   
                  set_inuse_bit_at_offset (victim, size);     // è®¾ç½®å—ä¸ºå·²ä½¿ç”¨çŠ¶æ€
                  if (av != &amp;main_arena)
                      victim-&gt;size |= NON_MAIN_ARENA;         // å¦‚æœä¸æ˜¯ä¸»åˆ†é…åŒºï¼Œåˆ™è®¾ç½®ä¸ºéä¸»åˆ†é…åŒº
                }
							// 8.2.7 å¦‚æœå‰©ä½™å—å¤§äºæœ€å°å—å¤§å°ï¼Œåˆ™åˆ‡å‰²ä¸‹æ¥ï¼Œå¹¶ä¸”è®¾ç½®victimå’Œå‰©ä½™å—remainderçš„ç›¸å…³æ ‡å¿—ä½
              /* åˆ†å‰² */
              else
                {
                  remainder = chunk_at_offset (victim, nb);   // è·å–å‰©ä½™å—çš„åœ°å€

									// 8.2.7.1 å°†remainderç»™linkå…¥unsortedbinçš„å¼€å¤´å¤„
                  /* æˆ‘ä»¬ä¸èƒ½å‡è®¾æœªæ’åºåˆ—è¡¨ä¸ºç©ºï¼Œå› æ­¤å¿…é¡»åœ¨è¿™é‡Œæ‰§è¡Œå®Œå…¨æ’å…¥ã€‚ */
                  bck = unsorted_chunks (av);                  // è·å–æœªæ’åº bin çš„æŒ‡é’ˆ
                  fwd = bck-&gt;fd;                               // è·å–å‰å‘æŒ‡é’ˆ
								  if (__glibc_unlikely (fwd-&gt;bk != bck))
								    {
                      errstr = &quot;malloc(): corrupted unsorted chunks 2&quot;; // å‘ç”Ÿé”™è¯¯
                      goto errout;                                  // è·³è½¬åˆ°é”™è¯¯å¤„ç†
                    }
                  remainder-&gt;bk = bck;                           // è®¾ç½®å‰©ä½™å—çš„å‰é©±å’Œåç»§æŒ‡é’ˆ
                  remainder-&gt;fd = fwd;
                  bck-&gt;fd = remainder;
                  fwd-&gt;bk = remainder;

                  // 8.2.7.2 å°†remainderå£°æ˜ä¸ºav-&gt;last_remainder
                  if (in_smallbin_range (nb))
	                    av-&gt;last_remainder = remainder;
	                // 8.2.7.3 å¦‚æœremainderæ˜¯largechunkå¤§å°ï¼Œåˆ™å°†å…¶fd_nextsizeã€bk_nextsizeåŸŸåˆå§‹åŒ–ä¸ºNULL
                  if (!in_smallbin_range (remainder_size))
                    {
                      remainder-&gt;fd_nextsize = NULL;             // è®¾ç½®å‰©ä½™å—çš„å‰é©±å’Œåç»§æŒ‡é’ˆä¸º NULL
                      remainder-&gt;bk_nextsize = NULL;
                    }
                  // 8.2.7.4 è®¾ç½®victimã€remainderçš„ç›¸å…³æ ‡å¿—ä½ï¼ŒåŒ…æ‹¬ï¼š
                  // è®¾ç½®victimçš„sizeåŸŸã€Pæ ‡å¿—ä½=1ã€Næ ‡å¿—ä½
                  // è®¾ç½®remainderçš„sizeåŸŸã€Pæ ‡å¿—ä½=1ã€ç‰©ç†ç›¸é‚»ä¸‹ä¸€ä¸ªchunkçš„prev_sizeåŸŸ=remainder_size
                  set_head (victim, nb | PREV_INUSE |            // è®¾ç½®å½“å‰å—çš„å¤´éƒ¨å’Œè„šéƒ¨ä¿¡æ¯
                            (av != &amp;main_arena ? NON_MAIN_ARENA : 0));
                  set_head (remainder, remainder_size | PREV_INUSE);
                  set_foot (remainder, remainder_size);
                }
              // 8.2.8ã€è°ƒç”¨check_malloced_chunkå‡½æ•°åšå®‰å…¨æ£€æŸ¥ï¼Œå¯¹åˆ†é…çš„å—åš&#x27;\0&#x27;çš„dataéƒ¨åˆ†åˆå§‹åŒ–ï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·
              check_malloced_chunk (av, victim, nb);
              
              void *p = chunk2mem (victim);
              alloc_perturb (p, bytes);
              return p;
            }
        }

    use_top:
      /********************************************
		    åˆ‡å‰²topchunkéƒ¨åˆ†ï¼
	    *********************************************/
      // 9.æ²¡å¾—å›æ”¶æ—¶æˆ‘ä»¬å°è¯•åˆ‡å‰²topchunk-------------------------------------------------------------------------------
      // åŒæ—¶åœ¨åˆ‡å‰²è¿‡ç¨‹ä¸­è¦ä¿è¯topchunkè¿˜æœ‰&gt;= MINSIZEçš„å‰©ä½™ï¼Œå› æ­¤å¦‚æœå½“å‰è¯·æ±‚å¦åˆ™ä¼šè€—å°½å®ƒï¼Œåˆ™ä¼šè¿›è¡Œè¡¥å……ã€‚ï¼ˆç¡®ä¿å®ƒå­˜åœ¨çš„ä¸»è¦åŸå› æ˜¯ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ MINSIZE çš„ç©ºé—´æ¥æ”¾ç½® sysmalloc ä¸­çš„æ …æ ã€‚ï¼‰
      victim = av-&gt;top;                               // è·å– av-&gt;top æŒ‡é’ˆ
      size = chunksize (victim);                      // è·å–å—çš„å¤§å°

			// 9.1å¦‚æœtopchunkè¶³å¤Ÿå¤§ï¼Œç›´æ¥åˆ‡å‰²ä¹‹----------------------------------------
      if ((unsigned long) (size) &gt;= (unsigned long) (nb + MINSIZE)){ // å¦‚æœå—å¤§å°è¶³å¤Ÿå¤§
          remainder_size = size - nb;                  // è®¡ç®—å‰©ä½™å—çš„å¤§å°
          remainder = chunk_at_offset (victim, nb);     // è·å–å‰©ä½™å—çš„åœ°å€
          av-&gt;top = remainder;                          // æ›´æ–° av-&gt;top æŒ‡é’ˆ
          set_head (victim, nb | PREV_INUSE |           // è®¾ç½®å½“å‰å—çš„å¤´éƒ¨å’Œè„šéƒ¨ä¿¡æ¯
                    (av != &amp;main_arena ? NON_MAIN_ARENA : 0));
          set_head (remainder, remainder_size | PREV_INUSE); // è®¾ç½®å‰©ä¸‹é‚£éƒ¨åˆ†topchunkçš„sizeåŸŸå’ŒPæ ‡å¿—ä½
          // è°ƒç”¨check_malloced_chunkå‡½æ•°ï¼Œæ£€æŸ¥åˆ†é…çš„å—æ˜¯å¦æ­£ç¡®
          check_malloced_chunk (av, victim, nb);
          void *p = chunk2mem (victim);               // å°†å—è½¬æ¢ä¸ºåˆ†é…çš„å†…å­˜åŒºåŸŸ
          alloc_perturb (p, bytes);                   // æ‰°åŠ¨åˆ†é…çš„å†…å­˜åŒºåŸŸ
          return p;                                   // è¿”å›åˆ†é…çš„å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆ
      }

      // 9.2å¦‚æœtopchunkä¸å¤Ÿå¤§ï¼Œä½†æ˜¯æœ‰fastchunkï¼Œåˆ™è°ƒç”¨malloc_consolidateå‡½æ•°----------------------------------------
      else if (have_fastchunks (av)){                 // å¦‚æœæœ‰å¿«é€Ÿå—
          malloc_consolidate (av);                    // åˆå¹¶ç©ºé—²å—
          // æ¢å¤åŸå§‹ bin ç´¢å¼•ï¼Œç„¶åè¿™ä¹‹åè¿˜ä¼šæ‰§è¡Œéå†unsortedbiné™„è¿‘é‚£ä¸ªå¤–å±‚å¾ªç¯çš„for(;;)å»å°è¯•ä»smallbin&amp;largebinä¸­è·å¾—chunkï¼
          if (in_smallbin_range (nb))
            idx = smallbin_index (nb);
          else
            idx = largebin_index (nb);
        }

      // 9.3å¦‚æœtopchunkä¸å¤Ÿå¤§ï¼Œä¸”æ²¡æœ‰fastchunkï¼Œåˆ™è°ƒç”¨sysmallocå‡½æ•°ä¸ºå…¶ç”³è¯·ä¸€ç‰‡ç©ºé—´----------------------------------------
      else{
          void *p = sysmalloc (nb, av);               // è°ƒç”¨ç³»ç»Ÿ malloc
          if (p != NULL)
            alloc_perturb (p, bytes);                 // æ‰°åŠ¨åˆ†é…çš„å†…å­˜åŒºåŸŸï¼Œå…¨éƒ¨è®¾ç½®ä¸º&quot;\0&quot;
          return p;                                   // è¿”å›åˆ†é…çš„å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆ
      }
  }
}
</code></pre></details></li></ul><h3 id="1860427e-38bb-80c6-adbe-f9f8180d1e66" class="">4-å…¶ä»–ç›¸å…³å‡½æ•°</h3><p id="1860427e-38bb-803e-930d-e9f02f3a2e6f" class="">å…¶ä¸­ï¼š</p><ul id="e3c2a687-dac9-49e6-b89d-5759b33b9062" class="toggle"><li><details open=""><summary>malloc_consolidateå‡½æ•°ç”¨äºfastbinç¢ç‰‡å—æ•´ç†åˆå¹¶ï¼Œè¯¦æƒ…å¦‚ä¸‹ï¼š</summary><p id="2fd447ab-9c5a-4b1f-97ef-8aeafeac242e" class=""><strong>ã€ä»‹ç»ã€‘</strong></p><p id="7e8f4b93-4512-4778-9d95-9be3c62b7e52" class="">è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ç§ä½œç”¨ï¼š<div class="indented"><p id="d9951144-51bc-4c3b-b62f-320d49c32406" class="">ï¼ˆ1ï¼‰ç”¨äºåˆå¹¶ fastbin ä¸­çš„ç©ºé—²å—å¹¶å°†å®ƒä»¬æ”¾å…¥ unsorted bin ä¸­</p><p id="e58b1ade-deec-4e68-883c-fcd8facd97a5" class="">ï¼ˆ2ï¼‰ä¹Ÿå¯ä»¥ç”¨äºå¯¹å †è¿›è¡Œåˆå§‹åŒ–</p></div></p><p id="1840427e-38bb-809b-991e-c9d92e407dff" class=""><strong>ã€æ‰§è¡Œé€»è¾‘ã€‘</strong></p><p id="9511940f-a46d-4186-ba9e-77bfdfff8fc2" class="">è¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œé€»è¾‘å¦‚ä¸‹ï¼š<div class="indented"><p id="1860427e-38bb-8073-8e3b-f19aa220380d" class="">1ã€å¦‚æœmax_fast!=0ï¼Œåˆ™åˆå¹¶ç©ºé—²å—å¹¶æ”¾å…¥æœªæ’åºé“¾è¡¨ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼›<div class="indented"><p id="1860427e-38bb-80de-86cc-c1c1c25bf4d5" class="">1.1ã€ä¿®æ”¹malloc_stateçš„fastchunkæ ‡å¿—ä½ä¸ºâ€œå¦â€</p><p id="1860427e-38bb-80ea-8609-dd5ef8d322f6" class="">1.2ã€ä» fastbin ä¸­ç§»é™¤æ¯ä¸ªå—å¹¶åˆå¹¶ï¼Œç„¶åæ”¾å…¥æœªæ’åºé“¾è¡¨ä¸­ã€‚è¿™æ˜¯é€šè¿‡ä»¥ä¸‹ä¸¤ä¸ªdo  whileæ“ä½œå®ç°çš„ï¼š<div class="indented"><p id="1860427e-38bb-801b-ad46-f0ce1f81f7b4" class="">1.2.1ã€ç¬¬ä¸€ä¸ªdo whileå¾ªç¯ç”¨æ¥åœ¨fastbinsYæ•°ç»„é‡Œé¢éå†å„ä¸ªfastbiné“¾è¡¨</p><p id="1860427e-38bb-804b-946d-f03fa5aaec1f" class="">1.2.2ã€ç¬¬äºŒä¸ªdo whileå¾ªç¯ç”¨æ¥åœ¨ä¸€æ¡fastbiné“¾è¡¨ä¸­éå†æ¯ä¸€ä¸ªfastchunkï¼Œå…¶ä¸­ï¼š<div class="indented"><p id="1860427e-38bb-80e9-bb23-de7bac2d40e1" class="">1.2.2.1ã€å…ˆåšä¸€äº›é¢„å¤„ç†ï¼šæ‰¾åˆ°äº†å½“å‰chunkçš„sizeï¼›æ‰¾åˆ°äº†ç‰©ç†ç›¸é‚»ä¸‹ä¸€ä¸ªchunkåŠå…¶sizeï¼›</p><p id="1860427e-38bb-8022-8d2d-f1e876152fa3" class="">1.2.2.2ã€å‘å‰åˆå¹¶å°è¯•ï¼šå¦‚æœå½“å‰å—çš„Pä½=0ï¼Œåˆ™å°†å½“å‰å—ä¸å‰é¢å—åˆå¹¶åï¼Œå°†å‰é¢å—ä»å…¶æ‰€åœ¨é“¾è¡¨ä¸­åˆ é™¤</p><p id="1860427e-38bb-80d8-a022-e2abf4558006" class="">1.2.2.3ã€å‘ååˆå¹¶å°è¯•ï¼Œå¦‚ä¸‹ï¼š<div class="indented"><p id="1860427e-38bb-80f7-8593-c60a8eb2e87a" class="">ï¼ˆ1ï¼‰å¦‚æœnextchunkæ˜¯topchunkï¼Œåˆ™å°†å½“å‰å—èåˆå…¥topchunk</p><p id="1860427e-38bb-805f-b2b5-e60688ed7e14" class="">ï¼ˆ2ï¼‰å¦‚æœnextchunkå¹¶étopchunkï¼Œåˆ™æ£€æŸ¥å…¶æ˜¯å¦å¯ç”¨ã€‚å¦‚æœå¯ç”¨ï¼Œåˆ™åˆå¹¶ä¹‹å¹¶å°†å…¶ä»é“¾è¡¨ä¸­åˆ é™¤ï¼›å¦åˆ™ï¼Œæ¸…é™¤nextchunkçš„Pæ ‡å¿—ä½ã€‚è¿™æ ·å¤„ç†åçš„ç»“æœï¼Œå†å»è®¾ç½®ç›¸å…³æ ‡è®°ä½ï¼Œç„¶ååŠ å…¥unsortedbin</p></div></p></div></p></div></p></div></p><p id="1860427e-38bb-8074-9816-faefe3caf43a" class="">2ã€å¦‚æœmax_fast==0ï¼Œåˆ™è°ƒç”¨malloc_init_stateå‡½æ•°åˆå§‹åŒ–av</p></div></p><p id="35b700f2-3c2a-494e-a48b-1caac5f75a87" class=""><mark class="highlight-default"><strong>ã€ä»£ç ã€‘</strong></mark></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="30a9dbc4-6d59-419a-ab76-17f7b707068d" class="code"><code class="language-Plain Text">// malloc_consolidateå‡½æ•°å†…å®¹ï¼š
// å¦‚æœmax_fast!=0ï¼Œåˆå¹¶ç©ºé—²å—å¹¶æ”¾å…¥æœªæ’åºé“¾è¡¨ï¼›
// å¦åˆ™ï¼Œè°ƒç”¨malloc_init_stateè¿›è¡Œmalloc_stateçš„åˆå§‹åŒ–
static void malloc_consolidate(mstate av) {
    mfastbinptr* fb;                 /* å½“å‰æ­£åœ¨åˆå¹¶çš„ fastbin */
    mfastbinptr* maxfb;              /* æœ€åä¸€ä¸ª fastbin (ç”¨äºå¾ªç¯æ§åˆ¶) */
    mchunkptr p;                     /* å½“å‰æ­£åœ¨åˆå¹¶çš„å— */
    mchunkptr nextp;                 /* ä¸‹ä¸€ä¸ªå¾…åˆå¹¶çš„å— */
    mchunkptr unsorted_bin;          /* æœªæ’åºé“¾è¡¨å¤´éƒ¨ */
    mchunkptr first_unsorted;        /* å¾…è¿æ¥çš„å— */

    /* ä¸‹é¢è¿™äº›å˜é‡ä¸ free() ä¸­çš„ç”¨æ³•ç›¸åŒ */
    mchunkptr nextchunk;
    INTERNAL_SIZE_T size;
    INTERNAL_SIZE_T nextsize;
    INTERNAL_SIZE_T prevsize;
    int nextinuse;
    mchunkptr bck;
    mchunkptr fwd;

    // 1ã€å¦‚æœmax_fast!=0ï¼Œåˆ™åˆå¹¶ç©ºé—²å—å¹¶æ”¾å…¥æœªæ’åºé“¾è¡¨ï¼›
    if (get_max_fast() != 0) {
		    // 1.1ã€ä¿®æ”¹malloc_stateçš„fastchunkæ ‡å¿—ä½ä¸ºâ€œå¦â€
        clear_fastchunks(av);   
            
        unsorted_bin = unsorted_chunks(av);  /* è·å–unsorted biné“¾è¡¨å¤´éƒ¨åœ°å€ */

        // 1.2ã€ä» fastbin ä¸­ç§»é™¤æ¯ä¸ªå—å¹¶åˆå¹¶ï¼Œç„¶åæ”¾å…¥æœªæ’åºé“¾è¡¨ä¸­ã€‚
        // 1.2.1ã€ç¬¬ä¸€ä¸ªdo whileå¾ªç¯ç”¨æ¥åœ¨fastbinsYæ•°ç»„é‡Œé¢éå†å„ä¸ªfastbiné“¾è¡¨
        // è¿™é‡Œï¼ŒmaxfbæŒ‡å‘æœ€åä¸€ä¸ªfastbinï¼ˆå¿«é€ŸäºŒè¿›åˆ¶å—ï¼‰ï¼Œè€Œfbä»ç¬¬ä¸€ä¸ªfastbinå¼€å§‹ã€‚è¿™æ˜¯å› ä¸ºç¬¬ä¸€ä¸ªdo whileå¾ªç¯çš„æ¡ä»¶æ˜¯(fb++ != maxfb)ï¼Œè¡¨ç¤ºç”¨æ¥åœ¨fastbinsYæ•°ç»„é‡Œé¢éå†å„ä¸ªfastbiné“¾è¡¨
        maxfb = &amp;fastbin(av, NFASTBINS - 1);
        fb = &amp;fastbin(av, 0);
        do {
		        // è¿™æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œç”¨äºå®‰å…¨åœ°ä»fastbiné“¾è¡¨ä¸­åˆ é™¤å¹¶è¿”å›ç¬¬ä¸€ä¸ªå—
            p = atomic_exchange_acq(fb, 0); 
            // p!=0ä¹Ÿå°±æ˜¯â€œè¯¥fastbinå­˜åœ¨å—â€ï¼Œè¿›å…¥ç¬¬äºŒä¸ªdo whileå¾ªç¯
            if (p != 0) {
		            // 1.2.2ã€ç¬¬äºŒä¸ªdo whileå¾ªç¯ç”¨æ¥åœ¨ä¸€æ¡fastbiné“¾è¡¨ä¸­éå†æ¯ä¸€ä¸ªfastchunk
                do {
                    check_inuse_chunk(av, p);  /* æ£€æŸ¥å—æ˜¯å¦è¢«æ­£ç¡®ä½¿ç”¨ */
                    nextp = p-&gt;fd;

										// 1.2.2.1ã€è¿™é‡Œåšä¸€äº›é¢„å¤„ç†ï¼šæ‰¾åˆ°äº†å½“å‰chunkçš„sizeï¼›æ‰¾åˆ°äº†ç‰©ç†ç›¸é‚»ä¸‹ä¸€ä¸ªchunkåŠå…¶sizeï¼›
                    /* è¿™é‡Œç¨å¾®ç®€åŒ–äº†åœ¨ free() ä¸­çš„åˆå¹¶ä»£ç  */
                    size = p-&gt;size &amp; ~(PREV_INUSE | NON_MAIN_ARENA);
                    nextchunk = chunk_at_offset(p, size);
                    nextsize = chunksize(nextchunk);

										// 1.2.2.2ã€å‘å‰åˆå¹¶å°è¯•
										// å¦‚æœå½“å‰å—çš„Pä½=0ï¼Œåˆ™å°†å½“å‰å—ä¸å‰é¢å—åˆå¹¶åï¼Œå°†å‰é¢å—ä»å…¶æ‰€åœ¨é“¾è¡¨ä¸­åˆ é™¤
                    if (!prev_inuse(p)) {
                        prevsize = p-&gt;prev_size;
                        size += prevsize;
                        p = chunk_at_offset(p, -((long)prevsize));
                        unlink(av, p, bck, fwd);  /* ä»é“¾è¡¨ä¸­ç§»é™¤å— */
                    }
										
										// 1.2.2.3ã€å‘ååˆå¹¶å°è¯•
										// ï¼ˆ1ï¼‰å¦‚æœnextchunkæ˜¯topchunkï¼Œåˆ™å°†å½“å‰å—èåˆå…¥topchunk
										// ï¼ˆ2ï¼‰å¦‚æœnextchunkå¹¶étopchunkï¼Œåˆ™æ£€æŸ¥å…¶æ˜¯å¦å¯ç”¨ã€‚å¦‚æœå¯ç”¨ï¼Œåˆ™åˆå¹¶ä¹‹å¹¶å°†å…¶ä»é“¾è¡¨ä¸­åˆ é™¤ï¼›å¦åˆ™ï¼Œæ¸…é™¤nextchunkçš„Pæ ‡å¿—ä½ã€‚
                    //     è¿™æ ·å¤„ç†åçš„ç»“æœï¼Œå†å»è®¾ç½®ç›¸å…³æ ‡è®°ä½ï¼Œç„¶ååŠ å…¥unsortedbin
                    if (nextchunk != av-&gt;top) {
                        nextinuse = inuse_bit_at_offset(nextchunk, nextsize);

                        if (!nextinuse) {
                            size += nextsize;
                            unlink(av, nextchunk, bck, fwd);  /* ä»é“¾è¡¨ä¸­ç§»é™¤ä¸‹ä¸€ä¸ªå— */
                        } else
                            clear_inuse_bit_at_offset(nextchunk, 0);

                        first_unsorted = unsorted_bin-&gt;fd;
                        unsorted_bin-&gt;fd = p;
                        first_unsorted-&gt;bk = p;

                        if (!in_smallbin_range(size)) {
                            p-&gt;fd_nextsize = NULL;
                            p-&gt;bk_nextsize = NULL;
                        }

                        set_head(p, size | PREV_INUSE);
                        p-&gt;bk = unsorted_bin;
                        p-&gt;fd = first_unsorted;
                        set_foot(p, size);
                    } else {
                        size += nextsize;
                        set_head(p, size | PREV_INUSE);
                        av-&gt;top = p;
                    }
                } while ((p = nextp) != 0);
            }
        } while (fb++ != maxfb);
     } 
     // 2ã€å¦‚æœmax_fast==0ï¼Œåˆ™è°ƒç”¨malloc_init_stateå‡½æ•°åˆå§‹åŒ–av
     else {
        malloc_init_state(av);
        check_malloc_state(av);
     }
}
</code></pre><ul id="32e36b16-edea-4e7b-8bb7-3e402130964b" class="toggle"><li><details open=""><summary>å…¶ä¸­ï¼Œmalloc_init_stateå‡½æ•°ã€do_check_malloc_stateå‡½æ•°å¦‚ä¸‹</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b8026268-db15-4232-a049-6a0f1a708357" class="code"><code class="language-Plain Text">static void malloc_init_state (mstate av)
{
  int i;
  mbinptr bin;

  // 1ã€ä½¿binæ•°ç»„é‡Œé¢çš„å„ä¸ªå…ƒç´ åœ¨å¼€å§‹æ—¶å¾ªç¯è‡ªæŒ‡
  for (i = 1; i &lt; NBINS; ++i)
    {
      bin = bin_at (av, i);
      bin-&gt;fd = bin-&gt;bk = bin;
    }

#if MORECORE_CONTIGUOUS
  if (av != &amp;main_arena)
#endif
	// 2ã€åˆå§‹åŒ–ä¸€äº›æ ‡å¿—ä½
	// åˆå§‹åŒ–MORECORE_CONTIGUOUS
  set_noncontiguous (av);
  // è®¾ç½®max_fast
  if (av == &amp;main_arena)
    set_max_fast (DEFAULT_MXFAST);
  // åˆå§‹åŒ–FASTCHUNKS_BITæ ‡å¿—ä½
  av-&gt;flags |= FASTCHUNKS_BIT;

	// 3ã€åˆå§‹åŒ–topåŸŸï¼Œä½¿ä¹‹æŒ‡å‘bin[1]
  // ç›¸å…³å®å®šä¹‰å¦‚ä¸‹ï¼š
	// #define initial_top(M)              (unsorted_chunks (M))
  // #define unsorted_chunks(M)          (bin_at (M, 1))
  av-&gt;top = initial_top (av);
}



static void
do_check_malloc_state (mstate av)
{
  int i;
  mchunkptr p;
  mchunkptr q;
  mbinptr b;
  unsigned int idx;
  INTERNAL_SIZE_T size;
  unsigned long total = 0;
  int max_fast_bin;

  // æ–­è¨€ï¼šå†…éƒ¨å¤§å°ç±»å‹size_t&lt;=æŒ‡é’ˆå¤§å°ï¼ˆä¸€èˆ¬æ¥è¯´æ˜¯==å…³ç³»ï¼‰
  assert (sizeof (INTERNAL_SIZE_T) &lt;= sizeof (char *));

  // æ–­è¨€ï¼šå¯¹é½æ˜¯2çš„å¹‚
  assert ((MALLOC_ALIGNMENT &amp; (MALLOC_ALIGNMENT - 1)) == 0);

  // åœ¨å†…å­˜åˆ†é…å™¨æœªå®Œå…¨åˆå§‹åŒ–ä¹‹å‰ï¼Œä¸èƒ½æ‰§è¡Œå‰©ä½™çš„æ£€æŸ¥ï¼Œå…¶ä¸­ï¼š
  // å½“ av-&gt;top == 0 æ—¶ï¼Œè¡¨ç¤ºåˆ†é…å™¨å°šæœªå®Œæˆåˆå§‹åŒ–ï¼Œè¿˜æ²¡æœ‰å‡†å¤‡å¥½è¿›è¡Œå†…å­˜åˆ†é…ï¼Œå› æ­¤æ²¡æœ‰æ„ä¹‰å»è¿è¡Œè¿›ä¸€æ­¥çš„æ£€æŸ¥ã€‚
  // å½“ av-&gt;top == initial_top(av) æ—¶ï¼Œæ„å‘³ç€åˆ†é…å™¨å¯èƒ½åˆšåˆå§‹åŒ–å®Œæˆï¼Œæˆ–è€…è¿˜æœªç»è¿‡ä»»ä½•å®é™…çš„å†…å­˜åˆ†é…æ“ä½œï¼Œæ­¤æ—¶å †çš„çŠ¶æ€è¢«è®¤ä¸ºæ˜¯åˆå§‹çŠ¶æ€ï¼Œä¸æ»¡è¶³è¿›è¡Œæ›´æ·±å±‚æ¬¡ä¸€è‡´æ€§æ£€æŸ¥çš„å‰ææ¡ä»¶ã€‚
  if (av-&gt;top == 0 || av-&gt;top == initial_top (av))
    return;

  //æ–­è¨€ï¼šé¡µå¤§å°æ˜¯2çš„å¹‚
  assert (powerof2(GLRO (dl_pagesize)));

  // å¦‚æœæ˜¯ä¸»åŒºåŸŸä¸”è¿ç»­ï¼Œåˆ™éªŒè¯sbrkåŸºå€ï¼ˆä¹Ÿå°±æ˜¯ç³»ç»Ÿè°ƒç”¨ç”³è¯·çš„åœ°å€çš„åŸºå€ï¼‰ä¸å †é¡¶éƒ¨åœ°å€æ˜¯å¦ä¸€è‡´
  if (av == &amp;main_arena &amp;&amp; contiguous (av))
    assert ((char *) mp_.sbrk_base + av-&gt;system_mem ==
            (char *) av-&gt;top + chunksize (av-&gt;top));

  /* properties of fastbins */

  // æ–­è¨€ï¼šglobal_max_faståœ¨åˆé€‚çš„èŒƒå›´å†…ï¼ˆå³&lt;=MAX_FAST_SIZEï¼‰
  assert ((get_max_fast () &amp; ~1) &lt;= request2size (MAX_FAST_SIZE));

  max_fast_bin = fastbin_index (get_max_fast ());

	// éå†æ‰€æœ‰fastchunkï¼Œæ£€æŸ¥å…¶åˆæ³•æ€§
  for (i = 0; i &lt; NFASTBINS; ++i)
    {
      p = fastbin (av, i);

      /* The following test can only be performed for the main arena.
         While mallopt calls malloc_consolidate to get rid of all fast
         bins (especially those larger than the new maximum) this does
         only happen for the main arena.  Trying to do this for any
         other arena would mean those arenas have to be locked and
         malloc_consolidate be called for them.  This is excessive.  And
         even if this is acceptable to somebody it still cannot solve
         the problem completely since if the arena is locked a
         concurrent malloc call might create a new arena which then
         could use the newly invalid fast bins.  */

      /* all bins past max_fast are empty */
      if (av == &amp;main_arena &amp;&amp; i &gt; max_fast_bin)
        assert (p == 0);

      while (p != 0)
        {
          /* each chunk claims to be inuse */
          do_check_inuse_chunk (av, p);
          total += chunksize (p);
          /* chunk belongs in this bin */
          assert (fastbin_index (chunksize (p)) == i);
          p = p-&gt;fd;
        }
    }

  if (total != 0)
    assert (have_fastchunks (av));
  else if (!have_fastchunks (av))
    assert (total == 0);

  // éå†å½“å‰å †NBINSé‡Œé¢çš„æ‰€æœ‰ç©ºé—²å—ï¼Œæ£€æŸ¥å…¶åˆæ³•æ€§
  for (i = 1; i &lt; NBINS; ++i)
    {
      b = bin_at (av, i);

      /* binmap is accurate (except for bin 1 == unsorted_chunks) */
      if (i &gt;= 2)
        {
          unsigned int binbit = get_binmap (av, i);
          int empty = last (b) == b;
          if (!binbit)
            assert (empty);
          else if (!empty)
            assert (binbit);
        }

      for (p = last (b); p != b; p = p-&gt;bk)
        {
          /* each chunk claims to be free */
          do_check_free_chunk (av, p);
          size = chunksize (p);
          total += size;
          if (i &gt;= 2)
            {
              /* chunk belongs in bin */
              idx = bin_index (size);
              assert (idx == i);
              /* lists are sorted */
              assert (p-&gt;bk == b ||
                      (unsigned long) chunksize (p-&gt;bk) &gt;= (unsigned long) chunksize (p));

              if (!in_smallbin_range (size))
                {
                  if (p-&gt;fd_nextsize != NULL)
                    {
                      if (p-&gt;fd_nextsize == p)
                        assert (p-&gt;bk_nextsize == p);
                      else
                        {
                          if (p-&gt;fd_nextsize == first (b))
                            assert (chunksize (p) &lt; chunksize (p-&gt;fd_nextsize));
                          else
                            assert (chunksize (p) &gt; chunksize (p-&gt;fd_nextsize));

                          if (p == first (b))
                            assert (chunksize (p) &gt; chunksize (p-&gt;bk_nextsize));
                          else
                            assert (chunksize (p) &lt; chunksize (p-&gt;bk_nextsize));
                        }
                    }
                  else
                    assert (p-&gt;bk_nextsize == NULL);
                }
            }
          else if (!in_smallbin_range (size))
            assert (p-&gt;fd_nextsize == NULL &amp;&amp; p-&gt;bk_nextsize == NULL);
          /* chunk is followed by a legal chain of inuse chunks */
          for (q = next_chunk (p);
               (q != av-&gt;top &amp;&amp; inuse (q) &amp;&amp;
                (unsigned long) (chunksize (q)) &gt;= MINSIZE);
               q = next_chunk (q))
            do_check_inuse_chunk (av, q);
        }
    }

  // æ£€æŸ¥topchunkæ˜¯å¦æ­£å¸¸
  check_chunk (av, av-&gt;top);
}
#endif
</code></pre></details></li></ul></details></li></ul><ul id="146c1bfc-f86d-41e1-80d8-1d2441053709" class="toggle"><li><details open=""><summary>sysmallocå‡½æ•°ç”¨äºæ‰©å¤§topchunkï¼Œè¯¦æƒ…å¦‚ä¸‹ï¼š</summary><p id="83486175-bd10-437a-baa4-027c19d13213" class="">ã€ä»‹ç»ã€‘</p><p id="6d23eae4-46d4-465c-9eda-a08d870ee5a0" class="">ä¸‹é¢æ˜¯å‡½æ•°çš„æ‰§è¡Œé€»è¾‘ï¼š</p><ol type="1" id="e111ab50-1163-4697-9b16-a49fca68edbe" class="numbered-list" start="1"><li>é¦–å…ˆï¼Œå‡½æ•°æ£€æŸ¥æ˜¯å¦å¯ä»¥é€šè¿‡ mmap ç›´æ¥æ˜ å°„è¯·æ±‚å¤§å°çš„å†…å­˜åŒºåŸŸï¼Œè€Œä¸æ˜¯æ‰©å±•å½“å‰çš„ topã€‚å¦‚æœæ»¡è¶³ä¸€å®šæ¡ä»¶ï¼Œä¼šå°è¯•ç›´æ¥ä½¿ç”¨ mmap æ¥æ»¡è¶³åˆ†é…è¯·æ±‚ã€‚</li></ol><ol type="1" id="bb776551-18e0-44f1-b3c4-ae881d2f7844" class="numbered-list" start="2"><li>å¦‚æœæ— æ³•é€šè¿‡ mmap æ¥æ»¡è¶³åˆ†é…è¯·æ±‚ï¼Œæˆ–è€…éœ€è¦é€šè¿‡ mmap æ¥æ»¡è¶³ä½†å°è¯•å¤±è´¥ï¼Œåˆ™ä¼šå°è¯•ä½¿ç”¨ sbrk æˆ–è€…æ›´å¤§å•ä½çš„ mmapã€‚</li></ol><ol type="1" id="0541cf30-5eeb-49d3-83a4-69ecc01654db" class="numbered-list" start="3"><li>å¦‚æœå½“å‰çš„ arena ä¸æ˜¯ä¸» arenaï¼ˆmain_arenaï¼‰ï¼Œåˆ™ä¼šå°è¯•æ‰©å±•å½“å‰çš„å †ï¼ˆheapï¼‰æˆ–è€…åˆ›å»ºæ–°çš„å †æ¥æ»¡è¶³åˆ†é…è¯·æ±‚ã€‚</li></ol><ol type="1" id="44168280-b59a-45d5-bbda-4c23f2d52f32" class="numbered-list" start="4"><li>å¦‚æœå½“å‰çš„ arena æ˜¯ä¸» arenaï¼ˆmain_arenaï¼‰ï¼Œåˆ™ä¼šå°è¯•é€šè¿‡ sbrk æ¥æ‰©å±•å †ï¼Œå¹¶æ ¹æ®éœ€è¦ä½¿ç”¨ mmap æ¥è¡¥å……ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼šå¯¹ sbrk è¿”å›çš„å†…å­˜è¿›è¡Œè°ƒæ•´ï¼Œä¿è¯å¯¹é½ç­‰è¦æ±‚ã€‚<blockquote id="c57b219d-91f3-465e-bacf-dd7cf7d48549" class=""><mark class="highlight-blue">è¿™é‡Œå…¶å®æ˜¯ä¼šæ–°åˆ›å»ºä¸€ä¸ªtopchunkï¼Œç„¶åæŠŠåŸæ¥ä¸å¤Ÿç”¨çš„topchunkå˜æˆunsorted chunkï¼</mark><p id="daebcd21-99c4-4de1-a190-0b90d11b59c2" class="">ç”±æ­¤æˆ‘ä»¬ä¹Ÿä¼šæœ‰ä¸€ä¸ªæ”»å‡»æ–¹å¼â€œhouse of orangeâ€</p></blockquote></li></ol><ol type="1" id="9e6773d1-9346-4cd5-ad46-91a9bd13b257" class="numbered-list" start="5"><li>æœ€åï¼Œå¦‚æœæœ‰è¶³å¤Ÿçš„å†…å­˜æ»¡è¶³åˆ†é…è¯·æ±‚ï¼Œä¼šè¿›è¡Œåˆ†é…æ“ä½œï¼Œå¹¶æ›´æ–° top æŒ‡é’ˆï¼›å¦‚æœåˆ†é…å¤±è´¥ï¼Œåˆ™è®¾ç½®é”™è¯¯ç å¹¶è¿”å› 0ã€‚</li></ol><p id="626c673b-caf3-47ef-b281-5e20ba0ac6fb" class="">ã€æºç ã€‘</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="35f2fe10-ff51-4f16-85ab-c4fca011d8ac" class="code"><code class="language-C">static void *sysmalloc(INTERNAL_SIZE_T nb, mstate av) {
  mchunkptr old_top;              /* av-&gt;top çš„åŸå§‹å€¼ */
  INTERNAL_SIZE_T old_size;       /* av-&gt;top çš„å¤§å° */
  char *old_end;                  /* av-&gt;top çš„ç»“æŸåœ°å€ */

  long size;                      /* ä¼ é€’ç»™ç¬¬ä¸€ä¸ª MORECORE æˆ– mmap è°ƒç”¨çš„å‚æ•° */
  char *brk;                      /* MORECORE çš„è¿”å›å€¼ */

  long correction;                /* ç¬¬äºŒä¸ª MORECORE è°ƒç”¨çš„å‚æ•° */
  char *snd_brk;                  /* ç¬¬äºŒä¸ªè¿”å›å€¼ */

  INTERNAL_SIZE_T front_misalign; /* æ–°ç©ºé—´å‰ç«¯æ— æ³•ä½¿ç”¨çš„å­—èŠ‚ */
  INTERNAL_SIZE_T end_misalign;   /* æ–°ç©ºé—´æœ«ç«¯å‰©ä½™çš„éƒ¨åˆ†é¡µ */
  char *aligned_brk;              /* å¯¹é½çš„ brk åç§»é‡ */

  mchunkptr p;                    /* åˆ†é…/è¿”å›çš„å— */
  mchunkptr remainder;            /* åˆ†é…åçš„å‰©ä½™å— */
  unsigned long remainder_size;   /* å‰©ä½™å—çš„å¤§å° */

  size_t pagesize = GLRO(dl_pagesize); /* è·å–ç³»ç»Ÿé¡µå¤§å° */
  bool tried_mmap = false;        /* æ˜¯å¦å°è¯•è¿‡ mmap */

  /*
     å¦‚æœæœ‰ mmapï¼Œä¸”è¯·æ±‚å¤§å°è¾¾åˆ° mmap é˜ˆå€¼ï¼Œä¸”ç³»ç»Ÿæ”¯æŒ mmapï¼Œ
     ä¸”å½“å‰åˆ†é…çš„ mmap åŒºåŸŸæ•°é‡ä¸å¤šï¼Œå°è¯•ç›´æ¥æ˜ å°„è¯·æ±‚ï¼Œè€Œä¸æ˜¯æ‰©å±• topã€‚
   */
  if (av == NULL ||
      ((unsigned long)(nb) &gt;= (unsigned long)(mp_.mmap_threshold) &amp;&amp;
       (mp_.n_mmaps &lt; mp_.n_mmaps_max))) {
    char *mm;                     /* mmap è°ƒç”¨çš„è¿”å›å€¼ */

  try_mmap:
    /*
       å°†å¤§å°å‘ä¸Šèˆå…¥åˆ°æœ€è¿‘çš„é¡µã€‚å¯¹äº mmapped å—ï¼Œå¼€é”€æ¯”æ™®é€šå—å¤§ä¸€ä¸ª SIZE_SZ å•ä½ï¼Œ
       å› ä¸ºæ²¡æœ‰åç»­å—å¯ä»¥ä½¿ç”¨å…¶ prev_size å­—æ®µã€‚

       è¯·å‚è§ä¸‹é¢çš„ front_misalign å¤„ç†ï¼Œå¯¹äº glibcï¼Œé™¤éæœ‰é«˜å¯¹é½è¦æ±‚ï¼Œå¦åˆ™æ— éœ€è¿›ä¸€æ­¥å¯¹é½ã€‚
     */
    if (MALLOC_ALIGNMENT == 2 * SIZE_SZ)
      size = ALIGN_UP(nb + SIZE_SZ, pagesize);
    else
      size = ALIGN_UP(nb + SIZE_SZ + MALLOC_ALIGN_MASK, pagesize);
    tried_mmap = true;

    /* å¦‚æœå¤§å°ä¸ä¼šæº¢å‡ºä¸º 0ï¼Œåˆ™å°è¯•æ˜ å°„ */
    if ((unsigned long)(size) &gt; (unsigned long)(nb)) {
      mm = (char *)(MMAP(0, size, PROT_READ | PROT_WRITE, 0));

      if (mm != MAP_FAILED) {
        /*
           æ˜ å°„åŒºåŸŸçš„èµ·å§‹åç§»é‡å­˜å‚¨åœ¨å—çš„ prev_size å­—æ®µä¸­ã€‚
           è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œå’Œ memalign() ä¸­è°ƒæ•´è¿”å›çš„èµ·å§‹åœ°å€ä»¥æ»¡è¶³å¯¹é½è¦æ±‚ï¼Œ
           å¹¶ä¸”ä»ç„¶èƒ½å¤Ÿåœ¨ free() å’Œ realloc() ä¸­è®¡ç®—æ­£ç¡®çš„åœ°å€å‚æ•°æ¥è¿›è¡Œåç»­çš„ munmapã€‚
         */

        if (MALLOC_ALIGNMENT == 2 * SIZE_SZ) {
          /* å¯¹äº glibcï¼Œchunk2mem å°†åœ°å€å¢åŠ äº† 2*SIZE_SZï¼Œ
             MALLOC_ALIGN_MASK æ˜¯ 2*SIZE_SZ-1ã€‚æ¯ä¸ª mmap åŒºåŸŸéƒ½æ˜¯é¡µé¢å¯¹é½çš„ï¼Œ
             å› æ­¤ç»å¯¹æ˜¯ MALLOC_ALIGN_MASK å¯¹é½çš„ã€‚ */
          assert(((INTERNAL_SIZE_T)chunk2mem(mm) &amp; MALLOC_ALIGN_MASK) == 0);
          front_misalign = 0;
        } else
          front_misalign = (INTERNAL_SIZE_T)chunk2mem(mm) &amp; MALLOC_ALIGN_MASK;
        if (front_misalign &gt; 0) {
          correction = MALLOC_ALIGNMENT - front_misalign;
          p = (mchunkptr)(mm + correction);
          p-&gt;prev_size = correction;
          set_head(p, (size - correction) | IS_MMAPPED);
        } else {
          p = (mchunkptr)mm;
          set_head(p, size | IS_MMAPPED);
        }

        /* æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ */
        int new = atomic_exchange_and_add(&amp;mp_.n_mmaps, 1) + 1;
        atomic_max(&amp;mp_.max_n_mmaps, new);

        unsigned long sum;
        sum = atomic_exchange_and_add(&amp;mp_.mmapped_mem, size) + size;
        atomic_max(&amp;mp_.max_mmapped_mem, sum);

        check_chunk(av, p);

        return chunk2mem(p);
      }
    }
  }

	/* æ‰€æœ‰å¯ç”¨çš„åˆ†é…åŒºåŸŸå’Œ mmap éƒ½å¤±è´¥äº†ã€‚ */
	if (av == NULL)
	  return 0;

	/* è®°å½• av-&gt;top çš„å½“å‰é…ç½® */
	old_top = av-&gt;top;
	old_size = chunksize(old_top);
	old_end = (char *)(chunk_at_offset(old_top, old_size));

	brk = snd_brk = (char *)(MORECORE_FAILURE);

	/*
	   å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼Œåˆ™è¦æ±‚ old_size è‡³å°‘ä¸º MINSIZEï¼Œå¹¶ä¸”è®¾ç½®äº† prev_inuseã€‚
	 */
	assert((old_top == initial_top(av) &amp;&amp; old_size == 0) ||
	       ((unsigned long)(old_size) &gt;= MINSIZE &amp;&amp;
	        prev_inuse(old_top) &amp;&amp;
	        ((unsigned long)old_end &amp; (pagesize - 1)) == 0));

	/* å‰ææ¡ä»¶ï¼šå½“å‰ç©ºé—´ä¸è¶³ä»¥æ»¡è¶³ nb è¯·æ±‚ */
	assert((unsigned long)(old_size) &lt; (unsigned long)(nb + MINSIZE));
	
	if (av != &amp;main_arena) {
	    heap_info *old_heap, *heap;
	    size_t old_heap_size;

	    /* é¦–å…ˆå°è¯•æ‰©å±•å½“å‰å †ã€‚ */
	    old_heap = heap_for_ptr(old_top);
	    old_heap_size = old_heap-&gt;size;
	    if ((long)(MINSIZE + nb - old_size) &gt; 0 &amp;&amp;
	        grow_heap(old_heap, MINSIZE + nb - old_size) == 0) {
	        av-&gt;system_mem += old_heap-&gt;size - old_heap_size;
	        arena_mem += old_heap-&gt;size - old_heap_size;
	        set_head(old_top, (((char *)old_heap + old_heap-&gt;size) - (char *)old_top) | PREV_INUSE);
	    }
	    else if ((heap = new_heap(nb + (MINSIZE + sizeof(*heap)), mp_.top_pad))) {
	        /* ä½¿ç”¨æ–°åˆ†é…çš„å †ã€‚ */
	        heap-&gt;ar_ptr = av;
	        heap-&gt;prev = old_heap;
	        av-&gt;system_mem += heap-&gt;size;
	        arena_mem += heap-&gt;size;
	        /* è®¾ç½®æ–°çš„ topã€‚ */
	        top(av) = chunk_at_offset(heap, sizeof(*heap));
	        set_head(top(av), (heap-&gt;size - sizeof(*heap)) | PREV_INUSE);
	
	        /* è®¾ç½®æ …æ å¹¶é‡Šæ”¾æ—§çš„ top å—ï¼Œå…¶å¤§å°ä¸º MALLOC_ALIGNMENT çš„å€æ•°ã€‚ */
	        /* æ …æ è‡³å°‘å ç”¨ MINSIZE å­—èŠ‚ï¼Œå› ä¸ºå®ƒå¯èƒ½ç¨åå†æ¬¡æˆä¸ºé¡¶éƒ¨å—ã€‚
	           è¯·æ³¨æ„ï¼Œå°½ç®¡æ ‡è®°äº†ä½¿ç”¨ï¼Œä½†è¿˜è®¾ç½®äº†é¡µè„šã€‚ */
	        old_size = (old_size - MINSIZE) &amp; ~MALLOC_ALIGN_MASK;
	        set_head(chunk_at_offset(old_top, old_size + 2 * SIZE_SZ), 0 | PREV_INUSE);
	        if (old_size &gt;= MINSIZE) {
	            set_head(chunk_at_offset(old_top, old_size), (2 * SIZE_SZ) | PREV_INUSE);
	            set_foot(chunk_at_offset(old_top, old_size), (2 * SIZE_SZ));
	            set_head(old_top, old_size | PREV_INUSE | NON_MAIN_ARENA);
	            _int_free(av, old_top, 1);
	        }
		      else {
	            set_head(old_top, (old_size + 2 * SIZE_SZ) | PREV_INUSE);
	            set_foot(old_top, (old_size + 2 * SIZE_SZ));
	        }
	    }
	    else if (!tried_mmap)
			    /* æˆ‘ä»¬è‡³å°‘å¯ä»¥å°è¯•ä½¿ç”¨ mmap å†…å­˜ã€‚ */
		      goto try_mmap;
	}
	else{ /* av == main_arena */
			/* è¯·æ±‚è¶³å¤Ÿçš„ç©ºé—´ä»¥å®¹çº³ nb + pad + overhead */

		  size = nb + mp_.top_pad + MINSIZE;

		  /*
		     å¦‚æœæ˜¯è¿ç»­çš„ï¼Œæˆ‘ä»¬å¯ä»¥å‡å»ç°æœ‰çš„ç©ºé—´ï¼Œå¸Œæœ›ä¸æ–°ç©ºé—´ç»“åˆã€‚
		     ä»…å½“æˆ‘ä»¬å®é™…ä¸Šæ²¡æœ‰è·å¾—è¿ç»­ç©ºé—´æ—¶ï¼Œæˆ‘ä»¬ç¨åæ‰å°†å…¶æ·»åŠ å›å»ã€‚
		   */
		  if (contiguous(av))
		  size -= old_size;

		  /*
		     èˆå…¥ä¸ºé¡µé¢å¤§å°çš„å€æ•°ã€‚
		     å¦‚æœ MORECORE ä¸æ˜¯è¿ç»­çš„ï¼Œåˆ™ç¡®ä¿æˆ‘ä»¬åªä»¥æ•´é¡µå‚æ•°è°ƒç”¨å®ƒã€‚
		     å¦‚æœ MORECORE æ˜¯è¿ç»­çš„ï¼Œå¹¶ä¸”è¿™ä¸æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œé‚£ä¹ˆè¿™ä¼šä¿ç•™å‰æ¬¡è°ƒç”¨çš„é¡µå¯¹é½ã€‚
		     å¦åˆ™ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹é¢è¿›è¡Œé¡µå¯¹é½ä¿®æ­£ã€‚
		   */
		  size = ALIGN_UP(size, pagesize);

		  /*
		     å¦‚æœå‚æ•°å¤ªå¤§ï¼Œä»¥è‡³äºçœ‹èµ·æ¥ä¸ºè´Ÿæ•°ï¼Œåˆ™ä¸è¦å°è¯•è°ƒç”¨ MORECOREã€‚
		     è¯·æ³¨æ„ï¼Œç”±äº mmap æ¥å— size_t å‚æ•°ï¼Œå³ä½¿æˆ‘ä»¬æ— æ³•è°ƒç”¨ MORECOREï¼Œ
		     åœ¨ä¸‹é¢çš„ mmap å¯èƒ½ä¹Ÿä¼šæˆåŠŸã€‚
		   */
		  if (size &gt; 0){
		      brk = (char *)(MORECORE(size));
		      LIBC_PROBE(memory_sbrk_more, 2, brk, size);
		  }

		  if (brk != (char *)(MORECORE_FAILURE)){
		      /* å¦‚æœæœ‰å¿…è¦ï¼Œåˆ™è°ƒç”¨â€œmorecoreâ€æŒ‚é’©ã€‚ */
		      void (*hook)(void) = atomic_forced_read(__after_morecore_hook);
		      if (__builtin_expect(hook != NULL, 0))
		          (*hook)();
		  }else{
		      /*
		         å¦‚æœæœ‰ mmapï¼Œåˆ™åœ¨ MORECORE å¤±è´¥æˆ–æ— æ³•ä½¿ç”¨æ—¶å°è¯•ä½¿ç”¨å®ƒä½œä¸ºå¤‡ç”¨ã€‚
			       åœ¨åœ°å€ç©ºé—´ä¸­å­˜åœ¨â€œç©ºæ´â€çš„ç³»ç»Ÿä¸­å€¼å¾—è¿™æ ·åšï¼Œ
		         å› æ­¤ sbrk æ— æ³•æ‰©å±•ä»¥æä¾›è¿ç»­ç©ºé—´ï¼Œä½†å…¶ä»–åœ°æ–¹æœ‰ç©ºé—´å¯ç”¨ã€‚
		         è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å¿½ç•¥ mmap çš„æœ€å¤§è®¡æ•°å’Œé˜ˆå€¼é™åˆ¶ï¼Œ
		         å› ä¸ºç©ºé—´ä¸ä¼šè¢«ç”¨ä½œåˆ†ç¦»çš„ mmap åŒºåŸŸã€‚
		       */
		
		      /* æ— æ³•ä¸æ—§é¡¶éƒ¨åˆå¹¶ï¼Œå› æ­¤å°†å…¶å¤§å°å†åŠ å›æ¥ */
		      if (contiguous(av))
			        size = ALIGN_UP(size + old_size, pagesize);

		      /* å¦‚æœæˆ‘ä»¬ä¾èµ– mmap ä½œä¸ºå¤‡ç”¨ï¼Œé‚£ä¹ˆä½¿ç”¨æ›´å¤§çš„å•ä½ */
		      if ((unsigned long)(size) &lt; (unsigned long)(MMAP_AS_MORECORE_SIZE))
				      size = MMAP_AS_MORECORE_SIZE;

		      /* ä¸è¦å°è¯•å¦‚æœ size è¶…å‡º 0 */
		      if ((unsigned long)(size) &gt; (unsigned long)(nb)){
			        char *mbrk = (char *)(MMAP(0, size, PROT_READ | PROT_WRITE, 0));

		          if (mbrk != MAP_FAILED){
		              /* æˆ‘ä»¬ä¸éœ€è¦ï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨å¦ä¸€ä¸ª sbrk è°ƒç”¨æ¥æŸ¥æ‰¾ç»“æŸ */
		              brk = mbrk;
		              snd_brk = brk + size;

		              /*
		                 è®°å½•æˆ‘ä»¬ä¸å†æ‹¥æœ‰è¿ç»­çš„ sbrk åŒºåŸŸã€‚
		                 ç¬¬ä¸€æ¬¡ä½¿ç”¨ mmap ä½œä¸ºå¤‡ç”¨åï¼Œæˆ‘ä»¬æ°¸è¿œä¸å†ä¾èµ–è¿ç»­ç©ºé—´ï¼Œ
		                 å› ä¸ºè¿™å¯èƒ½ä¼šé”™è¯¯åœ°æ¡¥æ¥åŒºåŸŸã€‚
		               */
		              set_noncontiguous(av);
		          }
		      }
		  }
	
			if (brk != (char *)(MORECORE_FAILURE)){
			    if (mp_.sbrk_base == 0)
			        mp_.sbrk_base = brk;
		
			    // å¢åŠ ç³»ç»Ÿå†…å­˜ç»Ÿè®¡ä¿¡æ¯
				  av-&gt;system_mem += size;

			    /*
		       å¦‚æœ MORECORE æ‰©å±•äº†å…ˆå‰çš„ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥åŒæ ·æ‰©å±• top çš„å¤§å°ã€‚
			    */
			    if (brk == old_end &amp;&amp; snd_brk == (char *)(MORECORE_FAILURE))
			        set_head(old_top, (size + old_size) | PREV_INUSE);
	
			    else if (contiguous(av) &amp;&amp; old_size &amp;&amp; brk &lt; old_end){
			        /* ç³Ÿç³•ï¼æœ‰äººç ´åäº†æˆ‘ä»¬çš„ç©ºé—´â€¦ä¸èƒ½è§¦åŠä»»ä½•ä¸œè¥¿ */
			        malloc_printerr(3, &quot;break adjusted to free malloc space&quot;, brk, av);
			    }

		    /*
		       å¦åˆ™ï¼Œåšä¸€äº›è°ƒæ•´ï¼š
		     * å¦‚æœç¬¬ä¸€æ¬¡è°ƒç”¨æˆ–éè¿ç»­çš„ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ sbrk ä»…ä»…æ˜¯ä¸ºäº†æ‰¾å‡ºå†…å­˜çš„æœ«å°¾ä½ç½®ã€‚
		     * æˆ‘ä»¬éœ€è¦ç¡®ä¿ä» malloc è¿”å›çš„æ‰€æœ‰å—éƒ½æ»¡è¶³ MALLOC_ALIGNMENT
		     * å¦‚æœæœ‰ä¸€ä¸ªé—´éš”çš„å¤–æ¥ sbrkï¼Œæˆ‘ä»¬éœ€è¦è°ƒæ•´ sbrk è¯·æ±‚çš„å¤§å°ï¼Œ
		        ä»¥è€ƒè™‘æˆ‘ä»¬å°†æ— æ³•å°†æ–°ç©ºé—´ä¸ old_top ä¸­çš„ç°æœ‰ç©ºé—´åˆå¹¶ã€‚
		     * å‡ ä¹æ‰€æœ‰ç³»ç»Ÿå†…éƒ¨ä¸€æ¬¡åˆ†é…æ•´ä¸ªé¡µé¢çš„å†…å­˜ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½ä¼š
		        ç”¨æœ€åä¸€ä¸ªè¯·æ±‚é¡µçš„æ•´ä¸ªç©ºé—´ï¼Œå› æ­¤æˆ‘ä»¬ç°åœ¨åˆ†é…è¶³å¤Ÿçš„å†…å­˜ä»¥è¾¾åˆ°é¡µé¢è¾¹ç•Œï¼Œ
		        è¿™åè¿‡æ¥åˆå¯¼è‡´å°†æ¥çš„è¿ç»­è°ƒç”¨è¿›è¡Œé¡µé¢å¯¹é½ã€‚
		     */

				  else{
				      front_misalign = 0;
				      end_misalign = 0;
				      correction = 0;
				      aligned_brk = brk;
			
				      /* å¤„ç†è¿ç»­çš„æƒ…å†µ */
				      if (contiguous(av)){
				          /* è®¡ç®—å¤–æ¥ sbrk ä½œä¸º system_memã€‚ */
				          if (old_size)
				              av-&gt;system_mem += brk - old_end;
	
				          /* ä¿è¯ä»æ­¤ç©ºé—´åˆ›å»ºçš„ç¬¬ä¸€ä¸ªæ–°å—çš„å¯¹é½ */
				          front_misalign = (INTERNAL_SIZE_T)chunk2mem(brk) &amp; MALLOC_ALIGN_MASK;
				          if (front_misalign &gt; 0){
		                /*
		                   è·³è¿‡ä¸€äº›å­—èŠ‚ä»¥åˆ°è¾¾å¯¹é½ä½ç½®ã€‚
		                   æˆ‘ä»¬ä¸éœ€è¦ç‰¹åˆ«æ ‡è®°è¿™äº›æµªè´¹çš„å‰ç½®å­—èŠ‚ã€‚
		                   æ— è®ºå¦‚ä½•ï¼Œå®ƒä»¬æ°¸è¿œä¸ä¼šè¢«è®¿é—®ï¼Œå› ä¸ºåˆå§‹åŒ–å av-&gt;top çš„
		                   prev_inuse æ€»æ˜¯ trueï¼ˆä»¥åŠä»å…¶å¼€å¤´åˆ›å»ºçš„ä»»ä½•å—ï¼‰ã€‚
		                 */
				              correction = MALLOC_ALIGNMENT - front_misalign;
				              aligned_brk += correction;
					        }

			            /*
			             å¦‚æœè¿™ä¸æ˜¯ä¸ç°æœ‰ç©ºé—´ç›¸é‚»çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†æ— æ³•ä¸ old_top ç©ºé—´åˆå¹¶ï¼Œ
		               å› æ­¤å¿…é¡»æ·»åŠ åˆ°ç¬¬äºŒä¸ªè¯·æ±‚ã€‚
			            */
				          correction += old_size;
	
				          /* å°†ç»“æŸåœ°å€æ‰©å±•åˆ°è¾¾åˆ°é¡µé¢è¾¹ç•Œ */
				          end_misalign = (INTERNAL_SIZE_T)(brk + size + correction);
				          correction += (ALIGN_UP(end_misalign, pagesize)) - end_misalign;
	
				          assert(correction &gt;= 0);
				          snd_brk = (char *)(MORECORE(correction));
	
			            /*
		               å¦‚æœæ— æ³•åˆ†é… correctionï¼Œå°è¯•è‡³å°‘æ‰¾å‡ºå½“å‰çš„ brkã€‚
		               å¦‚æœ second sbrk æ²¡æœ‰å¤±è´¥ï¼Œæˆ‘ä»¬å‡å®š space ä¸ first sbrk è¿ç»­ã€‚
		               è¿™æ˜¯ä¸€ä¸ªå®‰å…¨çš„å‡è®¾ï¼Œé™¤éç¨‹åºæ˜¯å¤šçº¿ç¨‹çš„ä½†ä¸ä½¿ç”¨é”ï¼Œè€Œåœ¨ç¬¬ä¸€æ¬¡
		               å’Œç¬¬äºŒæ¬¡è°ƒç”¨ä¹‹é—´å‘ç”Ÿäº†å¤–æ¥çš„ sbrkã€‚
			             */
				          if (snd_brk == (char *)(MORECORE_FAILURE)){
				               correction = 0;
				               snd_brk = (char *)(MORECORE(0));
				          }else{
				               /* å¦‚æœæœ‰å¿…è¦ï¼Œåˆ™è°ƒç”¨â€œmorecoreâ€æŒ‚é’©ã€‚ */
				               void (*hook)(void) = atomic_forced_read(__after_morecore_hook);
				               if (__builtin_expect(hook != NULL, 0))
				                   (*hook)();
				          }
				      }

              /* handle non-contiguous cases */
				      else{
				          if (MALLOC_ALIGNMENT == 2 * SIZE_SZ)
				              /* MORECORE/mmap must correctly align */
				              assert (((unsigned long) chunk2mem (brk) &amp; MALLOC_ALIGN_MASK) == 0);
				          else{
				              front_misalign = (INTERNAL_SIZE_T) chunk2mem (brk) &amp; MALLOC_ALIGN_MASK;
				              if (front_misalign &gt; 0){
                          /*
                             Skip over some bytes to arrive at an aligned position.
                             We don&#x27;t need to specially mark these wasted front bytes.
                             They will never be accessed anyway because
                             prev_inuse of av-&gt;top (and any chunk created from its start)
                             is always true after initialization.
                           */

		                  aligned_brk += MALLOC_ALIGNMENT - front_misalign;
				              }
				          }

				          /* Find out current end of memory */
				          if (snd_brk == (char *) (MORECORE_FAILURE)){
				              snd_brk = (char *) (MORECORE (0));
				          }
				      }

              /* Adjust top based on results of second sbrk */
              if (snd_brk != (char *) (MORECORE_FAILURE)){
                  av-&gt;top = (mchunkptr) aligned_brk;
                  set_head (av-&gt;top, (snd_brk - aligned_brk + correction) | PREV_INUSE);
                  av-&gt;system_mem += correction;

                  /*
                     If not the first time through, we either have a
                     gap due to foreign sbrk or a non-contiguous region.  Insert a
                     double fencepost at old_top to prevent consolidation with space
                     we don&#x27;t own. These fenceposts are artificial chunks that are
                     marked as inuse and are in any case too small to use.  We need
                     two to make sizes and alignments work out.
                   */

                  if (old_size != 0){
                      /*
                         Shrink old_top to insert fenceposts, keeping size a
                         multiple of MALLOC_ALIGNMENT. We know there is at least
                         enough space in old_top to do this.
                       */
                      old_size = (old_size - 4 * SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK;
                      set_head (old_top, old_size | PREV_INUSE);

                      /*
                         Note that the following assignments completely overwrite
                         old_top when old_size was previously MINSIZE.  This is
                         intentional. We need the fencepost, even if old_top otherwise gets
                         lost.
                       */
                      chunk_at_offset (old_top, old_size)-&gt;size =
                        (2 * SIZE_SZ) | PREV_INUSE;

                      chunk_at_offset (old_top, old_size + 2 * SIZE_SZ)-&gt;size =
                        (2 * SIZE_SZ) | PREV_INUSE;

                      /* If possible, release the rest. */
                      if (old_size &gt;= MINSIZE){
                          _int_free (av, old_top, 1);
                      }
                  }
              }
          }
      }
  } /* if (av !=  &amp;main_arena) */

  if ((unsigned long) av-&gt;system_mem &gt; (unsigned long) (av-&gt;max_system_mem))
    av-&gt;max_system_mem = av-&gt;system_mem;
  check_malloc_state (av);

  /* finally, do the allocation */
  p = av-&gt;top;
  size = chunksize (p);

  /* check that one of the above allocation paths succeeded */
  if ((unsigned long) (size) &gt;= (unsigned long) (nb + MINSIZE)){
      remainder_size = size - nb;
      remainder = chunk_at_offset (p, nb);
      av-&gt;top = remainder;
      set_head (p, nb | PREV_INUSE | (av != &amp;main_arena ? NON_MAIN_ARENA : 0));
      set_head (remainder, remainder_size | PREV_INUSE);
      check_malloced_chunk (av, p, nb);
      return chunk2mem (p);
  }

  /* catch all failure paths */
  __set_errno (ENOMEM);
  return 0;
}

							/* å¤„ç†éè¿ç»­çš„æƒ…å†µ */
							else {
							    if (MALLOC_ALIGNMENT == 2 * SIZE_SZ)
							        /* MORECORE/mmap å¿…é¡»ç¡®ä¿æ­£ç¡®å¯¹é½ */
							        assert (((unsigned long) chunk2mem(brk) &amp; MALLOC_ALIGN_MASK) == 0);
							    else {
							        front_misalign = (INTERNAL_SIZE_T) chunk2mem(brk) &amp; MALLOC_ALIGN_MASK;
							        if (front_misalign &gt; 0) {
							            /* è·³è¿‡ä¸€äº›å­—èŠ‚ä»¥è¾¾åˆ°å¯¹é½ä½ç½®ã€‚
							               ä¸éœ€è¦ç‰¹åˆ«æ ‡è®°è¿™äº›è¢«æµªè´¹çš„å‰ç«¯å­—èŠ‚ã€‚
							               æ— è®ºå¦‚ä½•ï¼Œå®ƒä»¬å°†ä¸ä¼šè¢«è®¿é—®ï¼Œå› ä¸º av-&gt;top çš„ prev_inuseï¼ˆä»¥åŠä»å®ƒå¼€å§‹åˆ›å»ºçš„ä»»ä½•å—ï¼‰
							               åœ¨åˆå§‹åŒ–åæ€»æ˜¯ä¸º trueã€‚ */
							            aligned_brk += MALLOC_ALIGNMENT - front_misalign;
							        }
							    }

							    /* æŸ¥æ‰¾å½“å‰å†…å­˜çš„æœ«å°¾ */
							    if (snd_brk == (char *) (MORECORE_FAILURE)) {
							        snd_brk = (char *) (MORECORE(0));
							    }
							}

							/* æ ¹æ®ç¬¬äºŒæ¬¡ sbrk çš„ç»“æœè°ƒæ•´ top */
							if (snd_brk != (char *) (MORECORE_FAILURE)) {
							    av-&gt;top = (mchunkptr) aligned_brk;
							    set_head(av-&gt;top, (snd_brk - aligned_brk + correction) | PREV_INUSE);
							    av-&gt;system_mem += correction;

							    /* å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡é€šè¿‡ï¼Œæˆ‘ä»¬è¦ä¹ˆæœ‰ä¸€ä¸ªå¤–æ¥ sbrk å¯¼è‡´çš„é—´éš™ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªéè¿ç»­çš„åŒºåŸŸã€‚
							       åœ¨ old_top å¤„æ’å…¥ä¸€ä¸ªåŒæ …æ ï¼Œé˜²æ­¢ä¸æˆ‘ä»¬ä¸æ‹¥æœ‰çš„ç©ºé—´åˆå¹¶ã€‚
							       è¿™äº›æ …æ æ˜¯æ ‡è®°ä¸ºä½¿ç”¨ä¸­çš„äººå·¥å—ï¼Œæ— è®ºå¦‚ä½•éƒ½å¤ªå°è€Œæ— æ³•ä½¿ç”¨ã€‚
							       æˆ‘ä»¬éœ€è¦ä¸¤ä¸ªæ¥ä½¿å¤§å°å’Œå¯¹é½æ­£å¸¸ã€‚ */
							    if (old_size != 0) {
							        /* æ”¶ç¼© old_top ä»¥æ’å…¥æ …æ ï¼Œä¿æŒå¤§å°æ˜¯ MALLOC_ALIGNMENT çš„å€æ•°ã€‚
							           æˆ‘ä»¬çŸ¥é“ old_top ä¸­è‡³å°‘æœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ */
							        old_size = (old_size - 4 * SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK;
							        set_head(old_top, old_size | PREV_INUSE);

							        /* è¯·æ³¨æ„ï¼Œä»¥ä¸‹åˆ†é…ä¼šåœ¨ old_size ä¹‹å‰æ˜¯ MINSIZE æ—¶å®Œå…¨è¦†ç›– old_topã€‚
							           è¿™æ˜¯æ•…æ„çš„ã€‚æˆ‘ä»¬éœ€è¦æ …æ ï¼Œå³ä½¿ old_top å¦åˆ™å¯èƒ½ä¼šä¸¢å¤±ã€‚ */
							        chunk_at_offset(old_top, old_size)-&gt;size = (2 * SIZE_SZ) | PREV_INUSE;
							        chunk_at_offset(old_top, old_size + 2 * SIZE_SZ)-&gt;size = (2 * SIZE_SZ) | PREV_INUSE;
			
							        /* å¦‚æœå¯èƒ½ï¼Œé‡Šæ”¾å‰©ä½™çš„éƒ¨åˆ†ã€‚ */
							        if (old_size &gt;= MINSIZE) {
							            _int_free(av, old_top, 1);
							        }
							    }
							}
					}
			}
	}

	if ((unsigned long) av-&gt;system_mem &gt; (unsigned long) (av-&gt;max_system_mem))
	    av-&gt;max_system_mem = av-&gt;system_mem;

	check_malloc_state(av);
	
	/* æœ€åï¼Œè¿›è¡Œåˆ†é… */
	p = av-&gt;top;
	size = chunksize(p);
	
	/* æ£€æŸ¥ä¸Šè¿°åˆ†é…è·¯å¾„ä¹‹ä¸€æ˜¯å¦æˆåŠŸ */
	if ((unsigned long) (size) &gt;= (unsigned long) (nb + MINSIZE)) {
	    remainder_size = size - nb;
	    remainder = chunk_at_offset(p, nb);
	    av-&gt;top = remainder;
	    set_head(p, nb | PREV_INUSE | (av != &amp;main_arena ? NON_MAIN_ARENA : 0));
	    set_head(remainder, remainder_size | PREV_INUSE);
	    check_malloced_chunk(av, p, nb);
	    return chunk2mem(p);
	}

	/* æ•è·æ‰€æœ‰å¤±è´¥è·¯å¾„ */
	__set_errno(ENOMEM);
	return 0;
}
</code></pre></details></li></ul><h1 id="dedaeb86-0d72-4a78-9c4e-035533a7ca80" class="block-color-default_background">ä¸‰ã€freeå‡½æ•°æ‰§è¡Œæµç¨‹</h1><h3 id="200dfa13-e10c-432d-8801-488f9f7b315a" class=""><strong>1-è¿‡ç¨‹ç®€ä»‹</strong></h3><ul id="17c0427e-38bb-8065-855d-ffe70b800c14" class="toggle"><li><details open=""><summary>1ã€<strong>ä¸€äº›é¢„å¤„ç†</strong></summary><p id="17c0427e-38bb-80e7-91e0-f3ce7b797201" class="">ï¼ˆ1ï¼‰åœ¨libc_freeå‡½æ•°ä¸­ï¼Œåšé’©å­å¤„ç†ï¼Œå¹¶æ£€æŸ¥ç”¨æˆ·è¾“å…¥çš„æŒ‡é’ˆä¸åº”ä¸ºNULLï¼Œ</p><p id="17c0427e-38bb-8082-bb80-c1bcf7eff88d" class="">ï¼ˆ2ï¼‰å¦‚æœç”¨æˆ·è¾“å…¥çš„å—æ˜¯é€šè¿‡mmapåˆ†é…çš„ï¼Œåˆ™ç›´æ¥é‡Šæ”¾ä¹‹ï¼›å¦åˆ™ï¼Œè°ƒç”¨int_freeå‡½æ•°</p><p id="17c0427e-38bb-80b7-9050-fb89c779e496" class="">ï¼ˆ3ï¼‰</p></details></li></ul><ul id="17d0427e-38bb-806b-b909-c673785b6809" class="toggle"><li><details open=""><summary>2ã€<strong>é€šç”¨å®‰å…¨æ£€æŸ¥</strong></summary><p id="1800427e-38bb-8061-9243-fd8032648429" class="">ï¼ˆ1ï¼‰ä¸€äº›é’ˆå¯¹ä¼ å‚æŒ‡é’ˆpçš„å®‰å…¨æ€§æ£€æŸ¥<div class="indented"><p id="1800427e-38bb-8098-b641-ebbcca540383" class="">{1} pæŒ‡å‘çš„æ–¹å‘æ˜¯å¦è¶…å‡ºäº†ç”¨æˆ·å†…å­˜åŒºåŸŸ</p><p id="1800427e-38bb-8055-861e-e5778e9ee7d1" class="">{2} pçš„èµ·å§‹åœ°å€æ˜¯å¦å·²æŒ‰è¦æ±‚å¯¹é½</p></div></p><p id="1800427e-38bb-80b7-b5c6-c784673a3ce8" class="">ï¼ˆ2ï¼‰ä¸€äº›é’ˆå¯¹ä¼ å‚å¤§å°sizeçš„å®‰å…¨æ€§æ£€æŸ¥<div class="indented"><p id="1800427e-38bb-80c0-9bd4-e381d8bd03d4" class="">{1} å½“å‰å—å¤§å°æ˜¯å¦å¤§äºMINSIZE</p><p id="1800427e-38bb-80a3-a374-db6beeb03272" class="">{3} å½“å‰å—å¤§å°æ˜¯å¦ç¬¦åˆå¯¹é½è¦æ±‚</p></div></p><p id="1800427e-38bb-806b-b9ee-ec7585a4fa38" class="">ï¼ˆ3ï¼‰é’ˆå¯¹double freeçš„å®‰å…¨æ€§æ£€æŸ¥ï¼šè°ƒç”¨do_check_inuse_chunkå‡½æ•°ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„æ˜¯æŸ¥çœ‹ä¸‹ä¸€ä¸ªchunkçš„Pæ˜¯å¦==1</p></details></li></ul><ul id="17d0427e-38bb-80c0-981f-e7c3c4631dda" class="toggle"><li><details open=""><summary>3ã€å¦‚æœsizeâ‰¤global_max_fastï¼Œ<strong>å°†å…¶è§†ä¸ºfastbinå›æ”¶</strong></summary><blockquote id="1800427e-38bb-8097-975b-de0fb35b0311" class="">æ³¨æ„ï¼šå¦‚æœTRIM_FASTBINSè¢«è®¾ç½®ï¼Œä¸”è¯¥å—ä¸topchunkç›¸é‚»ï¼Œåˆ™ä¸å°†å…¶æ”¾å…¥â€œå¿«é€Ÿåˆ†é…é“¾è¡¨â€ä¸­ã€‚</blockquote><p id="1800427e-38bb-8083-8b9f-d8a196d98f0a" class="">ï¼ˆ1ï¼‰å®‰å…¨æ£€æŸ¥ï¼Œä¸æ»¡è¶³åˆ™æŠ¥é”™ï¼š<div class="indented"><p id="1800427e-38bb-804f-91ab-fd878d2cecbd" class="">{1} ç‰©ç†ç›¸é‚»ä¸‹ä¸€ä¸ªå†…å­˜å—çš„å¤§å°æ˜¯å¦&lt;=2 * SIZE_SZï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢æ”»å‡»è€…å †æº¢å‡ºä¿®æ”¹ä¸‹ä¸€ä¸ªchunkçš„sizeå­—æ®µ</p><p id="1800427e-38bb-8036-93a5-d7cec48c4515" class="">{2} å½“å‰chunnkçš„sizeæ˜¯å¦&gt;=av-&gt;system_memï¼Œsystem_memæ˜¯ç³»ç»Ÿåˆ†é…çš„æœ€å¤§å†…å­˜å—å¤§å°ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢houseOfForceæ”»å‡»</p></div></p><p id="1800427e-38bb-80a4-bdf9-fe2ec8b936f1" class="">ï¼ˆ2ï¼‰&#x27;\0&#x27;å¡«å……æ¸…ç©ºå½“å‰chunkçš„dataåŸŸçš„å†…å®¹ï¼</p><p id="1800427e-38bb-8045-9af8-e1a7fed831fb" class="">ï¼ˆ3ï¼‰ä¸€å¤„é’ˆå¯¹doublefreeçš„å®‰å…¨æ£€æŸ¥ï¼šæ£€æŸ¥é“¾è¡¨é¡¶éƒ¨æ˜¯å¦æ­£å¥½ä¹Ÿæ˜¯æˆ‘ä»¬è¦freeçš„è¿™ä¸ªchunkï¼Œå¦‚æœæ˜¯åˆ™æŠ¥é”™</p><p id="1800427e-38bb-806a-9676-d49617ef7928" class="">ï¼ˆ4ï¼‰åŸå­åœ°å°†Pé“¾æ¥åˆ°å…¶å¯¹åº”fastbinå¼€å§‹å¤„: P-&gt;FD = *FB; *FB = P;</p><p id="1800427e-38bb-8003-b705-e784dc5cf357" class="">ï¼ˆ5ï¼‰å®‰å…¨æ£€æŸ¥ï¼šæ£€æŸ¥é¡¶éƒ¨å¿«é€Ÿåˆ†é…å—çš„å¤§å°æ˜¯å¦ä¸è¦æ·»åŠ çš„å—çš„å¤§å°ç›¸åŒ</p></details></li></ul><ul id="17d0427e-38bb-80bd-9405-e87156402931" class="toggle"><li><details open=""><summary>4ã€å¦åˆ™ï¼Œ<strong>å°†å…¶è§†ä¸ºéfastchunkå›æ”¶</strong></summary><p id="1800427e-38bb-80cd-b0c7-c030eb87a985" class="">ï¼ˆ1ï¼‰ä¸“ç”¨äºéfastchunkå›æ”¶çš„å®‰å…¨æ£€æŸ¥ï¼š<div class="indented"><p id="1800427e-38bb-80b3-bdc6-f5b5a9af66f9" class="">å®‰å…¨æ£€æŸ¥1-å†æ¬¡æ£€æŸ¥å®ƒæ˜¯å¦ä¸ºmmapäº§ç”Ÿçš„chunkï¼ˆä¹‹å‰åœ¨__libc_freeé‡Œæ›¾ç»æ£€æŸ¥è¿‡ä¸€æ¬¡ï¼‰<br/>å®‰å…¨æ€§æ£€æŸ¥-2ï¼šæ£€æŸ¥å½“å‰å—æ˜¯å¦ä¸ºtopchunkï¼Œæ˜¯åˆ™æŠ¥é”™<br/>å®‰å…¨æ€§æ£€æŸ¥-3ï¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªå—æ˜¯å¦è¶…å‡ºäº†arenaçš„è¾¹ç•Œ<br/>å®‰å…¨æ€§æ£€æŸ¥-4ï¼šæ£€æŸ¥å½“å‰chunkæ˜¯å¦å·²ç»è¢«freeè¿‡ï¼Œé˜²æ­¢doublefree<br/>å®‰å…¨æ€§æ£€æŸ¥-5ï¼šæ£€æŸ¥å½“å‰chunkçš„ä¸‹ä¸€ä¸ªchunkçš„å¤§å°æ˜¯å¦åˆæ³•ï¼ˆ&gt;2ä¸ªæŒ‡é’ˆå¤§å°ï¼Œå°äºav-&gt;system_memæç¤ºçš„èƒ½åˆ†é…çš„å†…å­˜æœ€å¤§<br/></p></div></p><p id="1800427e-38bb-8032-a476-ea6ff90a7642" class="">ï¼ˆ2ï¼‰&#x27;\0&#x27;å¡«å……æ¸…ç©ºå½“å‰chunkçš„dataåŸŸçš„å†…å®¹ï¼</p><p id="1800427e-38bb-8052-b0bd-dfd1e0ce8f89" class="">ï¼ˆ3ï¼‰chunkå‰ååˆå¹¶æœºåˆ¶ï¼<div class="indented"><p id="1800427e-38bb-80a0-94b7-f6ad53f1df45" class="">{1} å‘å‰åˆå¹¶å°è¯•</p><p id="1800427e-38bb-80a1-9705-c01947e4b878" class="">{2} å‘ååˆå¹¶å°è¯•ï¼Œåˆ†ä¸ºä¸¤ç§å¯èƒ½ï¼š</p><p id="1800427e-38bb-80bb-9a28-df9567525f15" class="">å¦‚æœåé¢chunkä¸æ˜¯topchunk ï¼Œåˆ™ï¼š<div class="indented"><p id="1800427e-38bb-8030-a0a3-dcb929e81e3c" class="">â‘  å°†åä¸€ä¸ªchunkåˆå¹¶å…¥å½“å‰chunkä¸­</p><p id="1800427e-38bb-8063-9038-d8b52904d7a1" class="">â‘¡ å®‰å…¨æ€§æ£€æŸ¥ï¼šè¦æ±‚å¿…é¡»æ»¡è¶³fwd-&gt;bk = bck-&gt;fdå¦åˆ™æŠ¥é”™</p><p id="1800427e-38bb-8015-8004-ec30dabe8c47" class="">â‘¢ å°†å—æ”¾å…¥unsorted binä¸­</p><p id="1800427e-38bb-8092-8d9b-ff9cc66e8853" class="">â‘£å¦‚æœæ˜¯large_binå¤§å°ï¼Œåˆ™ä¼šæŠŠå®ƒç”¨åˆ°çš„fd_nextsizeã€bk_nextsizeåšä¸€ä¸ªåˆå§‹åŒ–</p><p id="1800427e-38bb-8023-b5d1-e76ce3b39ab7" class="">â‘¤è®¾ç½®å½“å‰chunkçš„ç›¸å…³æ ‡å¿—ä½</p></div></p><p id="1800427e-38bb-801b-b118-f08ad26e9972" class="">å¦‚æœåé¢chunkæ˜¯topchunk ï¼Œåˆ™ï¼š<div class="indented"><p id="1800427e-38bb-80d9-a3db-eca4c871e106" class="">å°†å½“å‰chunkåˆå¹¶å…¥topchunkä¸­ï¼Œè®¾ç½®topchunkæ ‡å¿—ä½ï¼Œè°ƒç”¨check_chunkè¿›è¡Œå®‰å…¨æ£€æŸ¥</p></div></p></div></p></details></li></ul><h3 id="3183f3ef-50f4-4bab-b35d-0fc36d13b14b" class=""><strong>2-ç¤ºæ„å›¾</strong></h3><ul id="17c0427e-38bb-809a-966c-fd84b9af9a80" class="toggle"><li><details open=""><summary>ä»¥x32ç¯å¢ƒä¸‹çš„freeå‡½æ•°ä¸ºä¾‹</summary><figure id="45470238-d5a2-4519-ba22-62c69268ec38" class="image" style="text-align:left"><a href="ptmalloc2%E5%BA%93%E7%9A%84%E8%AE%BE%E8%AE%A1%E7%90%86%E5%BF%B5%2042d57ad04c9544898cfa507d4d47dde4/Untitled%202.png"><img style="width:384px" src="ptmalloc2%E5%BA%93%E7%9A%84%E8%AE%BE%E8%AE%A1%E7%90%86%E5%BF%B5%2042d57ad04c9544898cfa507d4d47dde4/Untitled%202.png"/></a></figure><figure id="5a8c2c19-5ed6-4909-8a81-c9f7d9d10132" class="image" style="text-align:left"><a href="ptmalloc2%E5%BA%93%E7%9A%84%E8%AE%BE%E8%AE%A1%E7%90%86%E5%BF%B5%2042d57ad04c9544898cfa507d4d47dde4/Untitled%203.png"><img style="width:480px" src="ptmalloc2%E5%BA%93%E7%9A%84%E8%AE%BE%E8%AE%A1%E7%90%86%E5%BF%B5%2042d57ad04c9544898cfa507d4d47dde4/Untitled%203.png"/></a></figure></details></li></ul><p id="1750427e-38bb-8016-b944-fe24d66aaa1d" class=""><mark class="highlight-red"><mark class="highlight-red_background">è¦æ”¹</mark></mark></p><h3 id="06e5feff-c63a-486c-9963-8c0d22126078" class="">3-æºç è§£æ</h3><blockquote id="1770427e-38bb-809b-a42d-c0212f1c3701" class="">æºç å‡ºå¤„ï¼š<a href="https://elixir.bootlin.com/glibc/glibc-2.23/source/malloc/malloc.c">https://elixir.bootlin.com/glibc/glibc-2.23/source/malloc/malloc.c</a></blockquote><p id="1770427e-38bb-80a3-a3da-f2b45503744c" class="">å…ˆæ˜¯è¿›åˆ°__libc_freeå‡½æ•°ï¼Œç„¶åè¯¥å‡½æ•°è°ƒç”¨_int_freeå‡½æ•°æ¥å®Œæˆä¸»è¦çš„å—é‡Šæ”¾è¿‡ç¨‹</p><ul id="17b0427e-38bb-8096-8ce5-e097e7d44b95" class="toggle"><li><details open=""><summary><strong>__libc_freeå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</strong></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="17b0427e-38bb-8027-a62f-d00e79672754" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">void __libc_free (void *mem) // å‚æ•° mem æŒ‡å‘è¦é‡Šæ”¾çš„å†…å­˜å—çš„åœ°å€ã€‚
{
  mstate ar_ptr; // ç”¨äºè¡¨ç¤ºå½“å‰çº¿ç¨‹ä½¿ç”¨çš„å†…å­˜åŒºåŸŸï¼ˆarenaï¼‰çš„çŠ¶æ€ã€‚
  mchunkptr p;                          /* chunk å¯¹åº”äº mem çš„å†…å­˜å— */

	// 1ã€é’©å­å¤„ç†
  // è·å–å…¨å±€ free é’©å­å‡½æ•°ã€‚è¿™ä¸ªé’©å­å…è®¸ç”¨æˆ·åœ¨å®é™…é‡Šæ”¾å‘ç”Ÿä¹‹å‰æ’å…¥è‡ªå®šä¹‰é€»è¾‘ã€‚
  void (*hook) (void *, const void *) = atomic_forced_read (__free_hook);
  // å¦‚æœæœ‰è®¾ç½® free é’©å­å¹¶ä¸”å®ƒä¸æ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œåˆ™è°ƒç”¨è¯¥é’©å­è¿›è¡Œå†…å­˜é‡Šæ”¾ã€‚
  if (__builtin_expect (hook != NULL, 0)) // __builtin_expect ä¼˜åŒ–åˆ†æ”¯é¢„æµ‹ï¼ŒæœŸæœ›é€šå¸¸æƒ…å†µä¸‹ hook æ˜¯ NULLã€‚
    {
      (*hook)(mem, RETURN_ADDRESS (0)); // è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„ hook å‡½æ•°ï¼Œå¹¶ä¼ é€’è¦é‡Šæ”¾çš„å†…å­˜åœ°å€å’Œè¿”å›åœ°å€ã€‚
      return; // ç›´æ¥é€€å‡ºï¼Œä¸å†æ‰§è¡Œä¸‹é¢çš„æ ‡å‡†é‡Šæ”¾é€»è¾‘ã€‚
    }

	// 2ã€é’ˆå¯¹ç”¨æˆ·è¾“å…¥çš„å®‰å…¨æ£€æŸ¥
  // å¦‚æœä¼ å…¥çš„æŒ‡é’ˆä¸º NULLï¼Œåˆ™ free(0) ä¸åº”è¯¥æœ‰ä»»ä½•æ•ˆæœï¼Œç›´æ¥è¿”å›ã€‚
  if (mem == 0)                            
    return;
    
  // å°†ç”¨æˆ·æä¾›çš„å†…å­˜æŒ‡é’ˆè½¬æ¢ä¸ºå¯¹åº”çš„ chunk ç»“æ„ã€‚
  p = mem2chunk (mem);
  
  // 3ã€å¦‚æœç”¨æˆ·è¾“å…¥çš„å—æ˜¯é€šè¿‡mmapåˆ†é…çš„ï¼Œåˆ™ç›´æ¥é‡Šæ”¾
  // æ£€æŸ¥è¯¥ chunk æ˜¯å¦æ˜¯é€šè¿‡ mmap åˆ†é…çš„å†…å­˜ã€‚
  if (chunk_is_mmapped (p))                       /* release mmapped memory. */
    {
      /* 
       * å¦‚æœä¸æ˜¯ç¦ç”¨åŠ¨æ€è°ƒæ•´é˜ˆå€¼ï¼Œå¹¶ä¸”è¯¥ chunk çš„å¤§å°å¤§äºå½“å‰çš„ mmap é˜ˆå€¼ï¼Œ
       * ä½†ä¸è¶…è¿‡é»˜è®¤çš„æœ€å¤§ mmap é˜ˆå€¼ï¼Œåˆ™è°ƒæ•´ mmap å’Œ trim çš„é˜ˆå€¼ã€‚
       */
      if (!mp_.no_dyn_threshold
          &amp;&amp; p-&gt;size &gt; mp_.mmap_threshold
          &amp;&amp; p-&gt;size &lt;= DEFAULT_MMAP_THRESHOLD_MAX)
        {
          // æ›´æ–° mmap å’Œ trim çš„é˜ˆå€¼ä¸ºå½“å‰ chunk çš„å¤§å°ã€‚
          mp_.mmap_threshold = chunksize (p);
          mp_.trim_threshold = 2 * mp_.mmap_threshold;
          LIBC_PROBE (memory_mallopt_free_dyn_thresholds, 2, // å‘å‡ºè°ƒè¯•ä¿¡æ¯ï¼Œè¡¨æ˜æ­£åœ¨è°ƒæ•´åŠ¨æ€é˜ˆå€¼ã€‚
                      mp_.mmap_threshold, mp_.trim_threshold);
        }
      // é‡Šæ”¾é€šè¿‡ mmap åˆ†é…çš„å†…å­˜ã€‚
      munmap_chunk (p);
      return;
    }

	// 4ã€å¦åˆ™ï¼Œé€šè¿‡_int_freeå‡½æ•°é‡Šæ”¾å€¼ä¹‹
  // æ ¹æ® chunk æ‰¾åˆ°æ‰€å±çš„ arenaã€‚
  ar_ptr = arena_for_chunk (p);
  // ä½¿ç”¨ _int_free å‡½æ•°æ¥é‡Šæ”¾ arena ä¸­çš„å†…å­˜å—ã€‚
  _int_free (ar_ptr, p, 0); // ç¬¬ä¸‰ä¸ªå‚æ•°é€šå¸¸ç”¨äºæ ‡å¿—ä½ï¼Œè¿™é‡Œè®¾ä¸º 0 è¡¨ç¤ºæ™®é€šé‡Šæ”¾ã€‚
}</code></pre></details></li></ul><ul id="1770427e-38bb-8067-bdbf-ef854a432e3c" class="toggle"><li><details open=""><summary><strong>_int_freeå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</strong></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="0de1ad9d-5d06-408f-8daa-c9b504292113" class="code"><code class="language-Plain Text">static void _int_free(mstate av, mchunkptr p, int have_lock)   //ä¼ å‚ï¼šavæ˜¯â€œå­˜å‚¨å †ç®¡ç†ä¿¡æ¯çš„ç»“æ„ä½“â€ï¼Œpæ˜¯è¦freeæ‰çš„é‚£å—chunkï¼Œlockæ˜¯é”çš„çŠ¶æ€
{
  INTERNAL_SIZE_T size;     /* è¦freeçš„å—çš„å¤§å° */
  mfastbinptr *fb;          /* ç›¸å…³çš„å¿«é€Ÿåˆ†é…é“¾è¡¨ */
  mchunkptr nextchunk;      /* ä¸‹ä¸€ä¸ªç›¸é‚»çš„å— */
  INTERNAL_SIZE_T nextsize; /* ä¸‹ä¸€ä¸ªå—çš„å¤§å° */
  int nextinuse;            /* ä¸‹ä¸€ä¸ªå—æ˜¯å¦è¢«ä½¿ç”¨ */
  INTERNAL_SIZE_T prevsize; /* å‰ä¸€ä¸ªç›¸é‚»å—çš„å¤§å° */
  mchunkptr bck;            /* é“¾è¡¨æ“ä½œä¸´æ—¶å˜é‡ */
  mchunkptr fwd;            /* é“¾è¡¨æ“ä½œä¸´æ—¶å˜é‡ */
  const char *errstr = NULL;
  int locked = 0;           /* äº’æ–¥é” */
  size = chunksize (p);

	/********************************************
		é€šç”¨å®‰å…¨æ£€æŸ¥ï¼
	*********************************************/
	// 1ã€é€šç”¨å®‰å…¨æ£€æŸ¥-----------------------------------------
	// 1.1ã€ä¸€äº›é’ˆå¯¹ä¼ å‚æŒ‡é’ˆpçš„å®‰å…¨æ€§æ£€æŸ¥
	// ï¼ˆ1ï¼‰pæŒ‡å‘çš„æ–¹å‘æ˜¯å¦è¶…å‡ºäº†ç”¨æˆ·å†…å­˜åŒºåŸŸï¼›ï¼ˆ2ï¼‰pçš„èµ·å§‹åœ°å€æ˜¯å¦å·²æŒ‰è¦æ±‚å¯¹é½ã€‚
  if (__builtin_expect ((uintptr_t) p &gt; (uintptr_t) -size, 0)  // ï¼ˆ1ï¼‰å°†pè½¬æ¢æˆunsignedåï¼Œä¼šä¸ä¼šå¤§äºå°†-sizeè½¬æˆunsigned intçš„ç»“æœã€‚ä¸€èˆ¬æ¥è¯´-sizeå¯¹åº”çš„å†…å­˜æ˜¯ï¼š0b11111111...ï¼Œè€Œå¦‚æœåœ¨x32ç³»ç»Ÿä¸‹ï¼Œå› ä¸ºlinuxè®¾å®šçš„ç”¨æˆ·å†…å­˜åŒºåŸŸæ˜¯3Gï¼Œæ‰€ä»¥æŒ‡é’ˆæ­£å¸¸åº”è¯¥ä¸èƒ½è¶…è¿‡0b11.....ã€‚
																															 //      æ‰€ä»¥ï¼Œå¦‚æœpè½¬æ¢æˆunsignedå&gt;å°†-sizeè½¬æˆunsigned intçš„ç»“æœï¼Œåˆ™è¡¨ç¤ºpä¸€å®šæ˜¯è¶…å‡ºäº†ç”¨æˆ·å†…å­˜åŒºåŸŸã€‚
      || __builtin_expect (misaligned_chunk (p), 0))           // ï¼ˆ2ï¼‰æ£€æŸ¥å½“å‰è¦é‡Šæ”¾çš„å— p çš„å—çš„èµ·å§‹åœ°å€æ˜¯å¦æŒ‰ç…§è¦æ±‚å¯¹é½
    {
      // æŠ¥é”™
      errstr = &quot;free(): invalid pointer&quot;;
    errout:
      if (!have_lock &amp;&amp; locked)
        (void) mutex_unlock (&amp;av-&gt;mutex);
      malloc_printerr (check_action, errstr, chunk2mem (p), av);
      return;
    }

  // 1.2ã€ä¸€äº›é’ˆå¯¹ä¼ å‚å¤§å°sizeçš„å®‰å…¨æ€§æ£€æŸ¥
  // ï¼ˆ1ï¼‰å½“å‰å—å¤§å°æ˜¯å¦å¤§äºMINSIZEï¼› ï¼ˆ2ï¼‰å½“å‰å—å¤§å°æ˜¯å¦ç¬¦åˆå¯¹é½è¦æ±‚ã€‚
  if (__glibc_unlikely (size &lt; MINSIZE || !aligned_OK (size))) // ï¼ˆ1ï¼‰æ£€æŸ¥å½“å‰è¦é‡Šæ”¾çš„å— p çš„å¤§å°æ˜¯å¦å¤§äºMINSIZE ï¼ˆ2ï¼‰æ£€æŸ¥å½“å‰å—çš„å¤§å°æ˜¯å¦ç¬¦åˆå¯¹é½è¦æ±‚
	  {
      errstr = &quot;free(): invalid size&quot;;
      goto errout;
    }
    
  // 1.3ã€é’ˆå¯¹double freeçš„å®‰å…¨æ€§æ£€æŸ¥
  // è°ƒç”¨do_check_inuse_chunkå‡½æ•°ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„æ˜¯æŸ¥çœ‹ä¸‹ä¸€ä¸ªchunkçš„Pæ˜¯å¦==1ï¼ˆä»¥é˜²æ­¢double freeï¼‰
  check_inuse_chunk(av, p);       

	/********************************************
		å°†å…¶è§†ä¸ºfastbinå›æ”¶éƒ¨åˆ†ï¼
	*********************************************/
	// 2ã€å¦‚æœå®ƒçš„å¤§å°&lt;=get_max_fastï¼Œåˆ™å°è¯•â€œå°†å½“å‰chunkæ”¾å…¥fastbiné“¾è¡¨â€------------------------------------------
	if ((unsigned long)(size) &lt;= (unsigned long)(get_max_fast ())
#if TRIM_FASTBINS
    //å¦‚æœTRIM_FASTBINSè¢«è®¾ç½®ï¼Œä¸”è¯¥å—ä¸topchunkç›¸é‚»ï¼Œåˆ™ä¸å°†å…¶æ”¾å…¥â€œå¿«é€Ÿåˆ†é…é“¾è¡¨â€ä¸­ã€‚
    &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top)
#endif
    ) {

	  // 2.1ã€ä¸“ç”¨äºfastchunkå›æ”¶çš„å®‰å…¨æ£€æŸ¥ï¼š
	  // ï¼ˆ1ï¼‰ç‰©ç†ç›¸é‚»ä¸‹ä¸€ä¸ªå†…å­˜å—çš„å¤§å°æ˜¯å¦&lt;=2 * SIZE_SZï¼Œå¦‚æœæ˜¯å°±å¤ªå°äº†â€”â€”å°äºæœ€å°chunkå¤§å°ã€‚
    // ï¼ˆ2ï¼‰å½“å‰chunnkçš„sizeæ˜¯å¦&gt;=av-&gt;system_memï¼Œsystem_memæ˜¯ç³»ç»Ÿåˆ†é…çš„æœ€å¤§å†…å­˜å—å¤§å°ï¼Œå¦‚æœæ˜¯å°±å¤ªå¤§ä½¬ã€‚
 	  // ä¸æ»¡è¶³è¦æ±‚ä¼šå‘ç”Ÿä¸€äº›æŠ¥é”™
    if (__builtin_expect (chunk_at_offset (p, size)-&gt;size &lt;= 2 * SIZE_SZ, 0)
        || __builtin_expect (chunksize (chunk_at_offset (p, size))&gt;= av-&gt;system_mem, 0))
      {
        // è¿›è¡Œä¸€äº›é”çš„å¤„ç†
        // å¦‚æœhave_lockå³å½“å‰çº¿ç¨‹æœ‰äº’æ–¥é”ï¼Œé‚£å°±æ‰§è¡ŒæŠ¥é”™ï¼›å¦åˆ™èµ°åˆ°||å³è¾¹çš„{}é‡Œï¼Œå»æ‰§è¡Œä¸Šé”çš„ä¸€ç³»åˆ—æ“ä½œï¼Œç„¶åå†æŠ¥é”™
        if (have_lock|| ({ assert (locked == 0);mutex_lock(&amp;av-&gt;mutex);locked = 1;chunk_at_offset (p, size)-&gt;size &lt;= 2 * SIZE_SZ|| chunksize (chunk_at_offset (p, size)) &gt;= av-&gt;system_mem;}))
         {
	  		  errstr = &quot;free(): invalid next size (fast)&quot;;
	  		  goto errout;
	  		 }
	  		// å¦‚æœä¹‹å‰æ²¡æœ‰é”ç„¶åæ˜¯é€šè¿‡{}é‡Œé¢çš„è¯­å¥è·å¾—äº†é”ï¼Œåˆ™åœ¨è¿™é‡Œé€šè¿‡mutex_unlocké‡Šæ”¾é”ã€‚
        if (! have_lock)
         {
	  		  (void)mutex_unlock(&amp;av-&gt;mutex);
	  		  locked = 0;
		  	 }
	    }

  	// 2.2ã€&#x27;\0&#x27;å¡«å……æ¸…ç©ºå½“å‰chunkçš„dataåŸŸçš„å†…å®¹ï¼
    free_perturb (chunk2mem(p), size - 2 * SIZE_SZ);

    set_fastchunks(av);       // è®¾ç½®å½“å‰malloc_stateçš„å¿«é€Ÿåˆ†é…æ ‡å¿—ä½ä¸ºâ€œæ˜¯â€ï¼ˆè¡¨ç¤ºæœ‰fastchunkï¼‰
    unsigned int idx = fastbin_index(size); // æ ¹æ®å½“å‰chunkçš„sizeè·å¾—å¯¹åº”çš„fastbinçš„idx
    fb = &amp;fastbin (av, idx);  // è·å¾—fastbinsY[idx]è¿™ä¸ªæ•°ç»„å…ƒç´ çš„åœ°å€ï¼

    mchunkptr old = *fb, old2;// å˜é‡oldæŒ‡å‘äº†fastbiné“¾è¡¨é‡Œçš„ç¬¬ä¸€ä¸ªchunk
    unsigned int old_idx = ~0u;
    do{
	 	    // 2.3ã€ä¸€å¤„é’ˆå¯¹doublefreeçš„æ£€æŸ¥
        // æ£€æŸ¥fastbiné“¾è¡¨é‡Œçš„ç¬¬ä¸€ä¸ªchunkæ˜¯å¦æ­£å¥½ä¹Ÿæ˜¯æˆ‘ä»¬è¦freeçš„è¿™ä¸ªchunkï¼Œå¦‚æœæ˜¯åˆ™æŠ¥é”™
        if (__builtin_expect (old == p, 0))
         {
			     errstr = &quot;double free or corruption (fasttop)&quot;;
			     goto errout;
			   }
        if (have_lock &amp;&amp; old != NULL)
					 old_idx = fastbin_index(chunksize(old));
			  // 2.4ã€åŸå­åœ°å°†Pé“¾æ¥åˆ°å…¶å¿«é€Ÿåˆ†é…é“¾è¡¨ä¸­: P-&gt;FD = *FB; *FB = P;
        p-&gt;fd = old2 = old;
    }while ((old = catomic_compare_and_exchange_val_rel (fb, p, old2)) != old2);
		//å…¶ä¸­ï¼Œwhileçš„æ“ä½œæ˜¯ä¸€ä¸ªè‡ªæ—‹æ“ä½œï¼Œæ„ä¹‰æ˜¯ä¸æ–­åœ°å°è¯•å°†è¯¥å—åŠ å…¥fastbinï¼Œä¼¼ä¹æ˜¯ä¸ºäº†åº”å¯¹å¤šçº¿ç¨‹çš„
	
	  // 2.5ã€å…¶ä¸­ï¼Œä¸€å¤„å®‰å…¨æ€§æ£€æŸ¥ï¼šæ£€æŸ¥é¡¶éƒ¨å¿«é€Ÿåˆ†é…å—çš„å¤§å°æ˜¯å¦ä¸è¦æ·»åŠ çš„å—çš„å¤§å°ç›¸åŒ
    if (have_lock &amp;&amp; old != NULL &amp;&amp; __builtin_expect (old_idx != idx, 0))
      {
        errstr = &quot;invalid fastbin entry (free)&quot;;
        goto errout;
      }
  }//åˆ°è¿™é‡Œï¼Œå°†å…¶æ”¾è¿›fastbinçš„å°è¯•ç»“æŸ

	/********************************************
		å°†å…¶è§†ä¸ºéfastchunkå›æ”¶éƒ¨åˆ†ï¼
	*********************************************/
// 3ã€å°†å…¶è§†ä¸ºéfastchunkå›æ”¶-------------------------------------------------------------------
// 3.1ã€ä¸“ç”¨äºéfastchunkå›æ”¶çš„å®‰å…¨æ£€æŸ¥ï¼š
// 3.1.1ã€å®‰å…¨æ£€æŸ¥1-å†æ¬¡æ£€æŸ¥å®ƒæ˜¯å¦ä¸ºmmapäº§ç”Ÿçš„chunkï¼ˆä¹‹å‰åœ¨__libc_freeé‡Œæ›¾ç»æ£€æŸ¥è¿‡ä¸€æ¬¡ï¼‰
else if (!chunk_is_mmapped(p)) 
 {
	 //é”ç›¸å…³çš„å¤„ç†
   if (! have_lock) 
    {
      (void)mutex_lock(&amp;av-&gt;mutex);
      locked = 1;
    }

	 //è·å¾—ç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ªchunk
   nextchunk = chunk_at_offset(p, size);

   // 3.1.2å®‰å…¨æ€§æ£€æŸ¥-2ï¼šæ£€æŸ¥å½“å‰å—æ˜¯å¦ä¸ºtopchunkï¼Œæ˜¯åˆ™æŠ¥é”™
   if (__glibc_unlikely (p == av-&gt;top))
     {
       errstr = &quot;double free or corruption (top)&quot;;
       goto errout;
     }
   // 3.1.3å®‰å…¨æ€§æ£€æŸ¥-3ï¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªå—æ˜¯å¦è¶…å‡ºäº†arenaçš„è¾¹ç•Œ
   if (__builtin_expect (contiguous (av)                                    //è‹¥å †çš„å†…å­˜æ˜¯è¿ç»­çš„
	    &amp;&amp; (char *) nextchunk&gt;= ((char *) av-&gt;top + chunksize(av-&gt;top))       //åˆ™æ£€æŸ¥â€œä¸‹ä¸€ä¸ªchunkçš„èµ·å§‹åœ°å€â€æ˜¯å¦&gt;=â€œtopchunkçš„ç»“å°¾åœ°å€â€ã€‚
	    , 0)){
        errstr = &quot;double free or corruption (out)&quot;;
        goto errout;
    }
   // 3.1.4å®‰å…¨æ€§æ£€æŸ¥-4ï¼šæ£€æŸ¥å½“å‰chunkæ˜¯å¦å·²ç»è¢«freeè¿‡ï¼Œé˜²æ­¢doublefree
   if (__glibc_unlikely (!prev_inuse(nextchunk)))
    {
      errstr = &quot;double free or corruption (!prev)&quot;;
      goto errout;
    }
	 // 3.1.5å®‰å…¨æ€§æ£€æŸ¥-5ï¼šæ£€æŸ¥å½“å‰chunkçš„ä¸‹ä¸€ä¸ªchunkçš„å¤§å°æ˜¯å¦åˆæ³•ï¼ˆ&gt;2ä¸ªæŒ‡é’ˆå¤§å°ï¼Œå°äºav-&gt;system_memæç¤ºçš„èƒ½åˆ†é…çš„å†…å­˜æœ€å¤§å¤§å°ï¼‰
	 //è¿™åº”è¯¥æ˜¯ä¸ºäº†é˜²æ­¢æ”»å‡»è€…æ¶æ„æ„å»ºå½“å‰chunkçš„ç‰©ç†ç›¸é‚»ä¸‹ä¸€ä¸ªchunkï¼Œä½†æ˜¯åªæ£€æŸ¥äº†sizeå­—æ®µè¿˜æ˜¯å¯ä»¥æ„å»ºçš„~
   nextsize = chunksize(nextchunk);
   if (__builtin_expect (nextchunk-&gt;size &lt;= 2 * SIZE_SZ, 0)
      || __builtin_expect (nextsize &gt;= av-&gt;system_mem, 0))
    {
      errstr = &quot;free(): invalid next size (normal)&quot;;
      goto errout;
    }

	 // 3.2ã€&#x27;\0&#x27;å¡«å……æ¸…ç©ºå½“å‰chunkçš„dataåŸŸçš„å†…å®¹ï¼
   free_perturb (chunk2mem(p), size - 2 * SIZE_SZ); 

	 // 3.3ã€éfastchunkå›æ”¶æ—¶çš„å‰ååˆå¹¶æœºåˆ¶ï¼
   // 3.3.1ã€å‘å‰åˆå¹¶å°è¯•
   if (!prev_inuse(p))
    {
      prevsize = p-&gt;prev_size;
      size += prevsize;
      p = chunk_at_offset(p, -((long) prevsize)); //è®©på¯»å€åˆ°å‰ä¸€ä¸ªchunkï¼Œç„¶åunlink
      unlink(av, p, bck, fwd);
    }
	 // 3.3.2ã€å‘ååˆå¹¶å°è¯•
	 // 3.3.2.1ã€å¦‚æœåé¢chunkä¸æ˜¯topchunk
   if (nextchunk != av-&gt;top)
    {
	    // 3.3.2.1.1ã€å°†åä¸€ä¸ªchunkåˆå¹¶å…¥å½“å‰chunkä¸­
      nextinuse = inuse_bit_at_offset(nextchunk, nextsize);//è·å–ä¸‹ä¸€ä¸ªchunkçš„prev_inuseä½
      if (!nextinuse) //å¦‚æœä¸‹ä¸€ä¸ªchunkæ˜¯freechunkåˆ™è§¦å‘åˆå¹¶
       {
         unlink(av, nextchunk, bck, fwd);
         size += nextsize;
       } 
      else           //å¦‚æœä¸‹ä¸€ä¸ªchunkæ˜¯allocated chunkåˆ™ä¸åˆå¹¶ï¼Œä½†ä¹Ÿä¼šå°†å…¶prev_inuseæ ‡å¿—ä½è®¾ç½®ä¸º0
         clear_inuse_bit_at_offset(nextchunk, 0);

	    // å—åªæœ‰åœ¨ç»™äºˆmallocä½¿ç”¨çš„æœºä¼šä¹‹åï¼Œæ‰ä¼šæ”¾å…¥å¸¸è§„çš„åˆ†é…åŒºå—ä¸­ã€‚
	    bck = unsorted_chunks(av);    //#define unsorted_chunks(M) (bin_at (M, 1))ï¼Œæ ¹æ®å®å®šä¹‰æ˜¯è¿”å›bin[1]è¿™ä¸ªå…ƒç´ çš„åœ°å€
	    fwd = bck-&gt;fd;
	    
		  // 3.3.2.1.2ã€å®‰å…¨æ€§æ£€æŸ¥ï¼šè¦æ±‚å¿…é¡»æ»¡è¶³fwd-&gt;bk = bck-&gt;fdå¦åˆ™æŠ¥é”™
	    //ç„¶è€Œè¿™ä¸ªä¹Ÿæ˜¯å¯ä»¥ç»•è¿‡æ»´~
	    if (__glibc_unlikely (fwd-&gt;bk != bck))
	     {
				 errstr = &quot;free(): corrupted unsorted chunks&quot;;
				 goto errout;
	     }
	     
	    // 3.3.2.1.3ã€å°†å—æ”¾å…¥unsorted binä¸­
	    p-&gt;fd = fwd;
	    p-&gt;bk = bck;    
	    
	    // 3.3.2.1.4ã€å¦‚æœæ˜¯large_binå¤§å°ï¼Œåˆ™ä¼šæŠŠå®ƒç”¨åˆ°çš„fd_nextsizeã€bk_nextsizeåšä¸€ä¸ªåˆå§‹åŒ–
	    if (!in_smallbin_range(size))
	     {
				 p-&gt;fd_nextsize = NULL;
				 p-&gt;bk_nextsize = NULL;
	     }
	    bck-&gt;fd = p;
	    fwd-&gt;bk = p;

			// 3.3.2.1.4ã€è®¾ç½®å½“å‰chunkçš„ç›¸å…³æ ‡å¿—ä½
	    set_head(p, size | PREV_INUSE);
	    set_foot(p, size);

	    check_free_chunk(av, p); // æ£€æŸ¥é‡Šæ”¾çš„å—
	  }
	  
	 // 3.3.2.2ã€å¦‚æœåé¢chunkæ˜¯topchunk
	 // åˆ™å°†å½“å‰chunkåˆå¹¶å…¥topchunkä¸­ï¼Œè®¾ç½®topchunkæ ‡å¿—ä½ï¼Œè°ƒç”¨check_chunkè¿›è¡Œå®‰å…¨æ£€æŸ¥
   //è¿™ä¹ŸåŒ…æ‹¬äº†å‰ä¸€ä¸ªè¢«åˆå¹¶å…¥å½“å‰chunkçš„å—ï¼Œåœ¨è¿™é‡Œä¹Ÿä¼šä¸€èµ·åˆå¹¶å…¥opchunkä¸­
   else 
    {
     size += nextsize;
     set_head(p, size | PREV_INUSE);
     av-&gt;top = p;
     check_chunk(av, p); // æ£€æŸ¥å—
    }
  }</code></pre></details></li></ul><h1 id="04b5447b-683f-43e0-b5be-844dbb8c87cb" class="block-color-default_background">å››ã€å…¶ä»–ç›¸å…³å‡½æ•°</h1><h3 id="1700427e-38bb-801f-bc1a-f7cea488ffec" class="">1-malloptå‡½æ•°</h3><p id="95652e72-e934-4f32-80e4-f0162c356e81" class="">ã€å®šä¹‰ã€‘</p><p id="c8345406-4457-42c2-acb8-c96dbc84b955" class="">Cæ ‡å‡†åº“ä¸­çš„ï¼Œç”¨äºè®¾ç½® malloc() å‡½æ•°çš„å‚æ•°</p><p id="3dae3ec0-7c80-4087-bb4f-f93dc746c0c0" class="">ã€ä¼ å‚ã€‘</p><p id="2902d1fc-610b-4d2e-acdb-30e46ba46b1d" class="">ç¬¬ä¸€ä¸ªæ˜¯é€‰é¡¹ï¼Œç¬¬äºŒä¸ªæ˜¯è¦ç»™è¿™ä¸ªé€‰é¡¹è®¾ç½®ä¸ºå¤šå°‘å€¼</p><p id="ac488cd5-fa33-495b-980a-94baf0de9277" class="">ã€ç¤ºä¾‹ã€‘</p><p id="fdd16eb0-8e16-454d-b430-eeb67575efd2" class="">mallopt(1,0)ï¼šä¿®æ”¹global_max_fastçš„å€¼ä¸º0ï¼Œå¹¶ä¸”æŒ‰ç…§ä¿®æ”¹åçš„global_max_fastå»æŠŠåŸå…ˆåœ¨fastbinä¸­çš„å †æ‹¿å‡ºæ¥æ”¾åˆ°unsortedbinä¸­å»</p><h3 id="1700427e-38bb-804a-9a2b-f1c881834dee" class="">2-malloc_hookå’Œfree_hookå‡½æ•°</h3><p id="1700427e-38bb-80c9-ad01-e6a1e76d32b2" class="">ã€å®šä¹‰ã€‘</p><p id="1700427e-38bb-80f7-b134-e482d12ec609" class="">å †åˆ›å»ºåˆ é™¤çš„æ—¶å€™ï¼Œæ‰§è¡Œé’©å­ä»£ç  </p></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body></html>